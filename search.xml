<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>MIT6.s081-lab-pgtbl</title>
      <link href="/2023/10/22/MIT6-s081-lab-pgtbl/"/>
      <url>/2023/10/22/MIT6-s081-lab-pgtbl/</url>
      
        <content type="html"><![CDATA[<h3 id="Speed-up-systems-calls"><a href="#Speed-up-systems-calls" class="headerlink" title="Speed up systems calls"></a>Speed up systems calls</h3><blockquote><p>é¢˜ç›®è¦æ±‚ï¼šä¸ºäº†åŠ é€ŸæŸäº›ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥è®©ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´å…±äº«ä¸€ç‰‡åªè¯»çš„ç‰©ç†å†…å­˜ç©ºé—´ï¼Œå¹¶æ”¾åœ¨<code>TRAPFRAME</code>ä¸‹é¢</p></blockquote><p>æ ¹æ®é¢˜ç›®æ„æ€å°±æ˜¯æ”¾åœ¨çº¢æ¡†è¿™é‡Œ</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231022211710321.png" alt="image-20231022211710321"></p><p>é¦–å…ˆéœ€è¦åœ¨<code>proc.h</code>æ–‡ä»¶ä¸­çš„<code>proc</code>ç»“æ„ä½“æ·»åŠ ä¸€ä¸ªæˆå‘˜ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">proc</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">spinlock</span> lock;</span><br><span class="line">    <span class="comment">// p-&gt;lock must be held when using these:</span></span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">procstate</span> state;  <span class="comment">// Process state</span></span><br><span class="line">    <span class="type">void</span> *chan;            <span class="comment">// If non-zero, sleeping on chan</span></span><br><span class="line">    <span class="type">int</span> killed;            <span class="comment">// If non-zero, have been killed</span></span><br><span class="line">    <span class="type">int</span> xstate;            <span class="comment">// Exit status to be returned to parent&#x27;s wait</span></span><br><span class="line">    <span class="type">int</span> pid;               <span class="comment">// Process ID</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait_lock must be held when using this:</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">proc</span> *parent;  <span class="comment">// Parent process</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// these are private to the process, so p-&gt;lock need not be held.</span></span><br><span class="line">    uint64 kstack;                  <span class="comment">// Virtual address of kernel stack</span></span><br><span class="line">    uint64 sz;                      <span class="comment">// Size of process memory (bytes)</span></span><br><span class="line">    <span class="type">pagetable_t</span> pagetable;          <span class="comment">// User page table</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">trapframe</span> *trapframe;    <span class="comment">// data page for trampoline.S</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">context</span> context;         <span class="comment">// swtch() here to run process</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">file</span> *ofile[NOFILE];     <span class="comment">// Open files</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">inode</span> *cwd;              <span class="comment">// Current directory</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">16</span>];                  <span class="comment">// Process name (debugging)</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">usyscall</span> *usyscallpage;  <span class="comment">// å…±äº«å†…å­˜é¡µ</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨<code>proc.c</code>çš„å‡½æ•°<code>allocproc</code>å¤šåˆ†é…ä¸€ä¸ªé¢å¤–çš„ç‰©ç†é¡µé¢ï¼Œå¹¶ä¸”å­˜æ”¾è¿›ç¨‹çš„<code>pid</code>ï¼Œå»ºè®®æ˜¯æ”¾åœ¨<code>trapframe</code>ä»£ç çš„ä¸‹é¢ï¼š</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231022212202336.png" alt="image-20231022212202336"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ†é…ä¸€ä¸ªuserè°ƒç”¨çš„é¡µ</span></span><br><span class="line"><span class="keyword">if</span> ((p-&gt;usyscallpage = (<span class="keyword">struct</span> usyscall *)<span class="built_in">kalloc</span>()) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">freeproc</span>(p);</span><br><span class="line">    <span class="built_in">release</span>(&amp;p-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">p-&gt;usyscallpage-&gt;pid = p-&gt;pid;</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”éœ€è¦åœ¨<code>proc_pagetable</code>å‡½æ•°ä¸­å®Œæˆç‰©ç†åœ°å€å’Œè™šæ‹Ÿåœ°å€çš„æ˜ å°„ï¼Œä¹Ÿå»ºè®®æ”¾åœ¨<code>trampoline</code>ä¸‹é¢ï¼š</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231022212425524.png" alt="image-20231022212425524"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">mappages</span>(pagetable, USYSCALL, PGSIZE, (uint64)(p-&gt;usyscallpage), PTE_R | PTE_U) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">uvmunmap</span>(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">uvmunmap</span>(pagetable, TRAPFRAME, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">uvmfree</span>(pagetable, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°±éœ€è¦åœ¨è¿›ç¨‹é‡Šæ”¾å‡½æ•°<code>freeproc</code>ä¸­é‡Šæ”¾æ‰è¿™ä¸ªé¡µé¢ï¼š</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231022212535555.png" alt="image-20231022212535555"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (p-&gt;usyscallpage)</span><br><span class="line">    <span class="built_in">kfree</span>((<span class="type">void</span> *)p-&gt;usyscallpage);</span><br><span class="line">p-&gt;usyscallpage = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>æœ€æœ€æœ€åä¸€æ­¥å°±æ˜¯è§£é™¤æ˜ å°„åœ¨<code>proc_freepagetable</code>å‡½æ•°ä¸­ï¼š</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231022212735483.png" alt="image-20231022212735483"></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">uvmunmap</span>(pagetable, USYSCALL, <span class="number">1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ç¬¬ä¸€ä¸ªä»»åŠ¡ç®—æ˜¯å¯¹å¤§åŠŸå‘Šæˆäº†ï¼Œå…¶å®æˆ‘è§‰å¾—è¿™éƒ¨åˆ†è¿˜æŒºéº»çƒ¦çš„ï¼Œè€Œä¸”è¿˜æ²¡æ€ä¹ˆç»™æç¤ºï¼Œä¸çŸ¥é“ä¸ºå•¥æ ‡è®°äº†ä¸ªç®€å•ï¼Œæˆ‘è§‰å¾—ç¬¬ä¸‰ä¸ªæ¯”è¿™ä¸ªå®¹æ˜“å†™å¤šäº†ã€‚ã€‚ã€‚</p><h3 id="Print-a-page-table"><a href="#Print-a-page-table" class="headerlink" title="Print a page table"></a>Print a page table</h3><blockquote><p>é¢˜ç›®è¦æ±‚ï¼šè®¾è®¡ä¸€ä¸ªå‡½æ•°æ‰“å°é¡µè¡¨</p></blockquote><p>è¿™éƒ¨åˆ†å°±æ¯•ç«Ÿç®€å•äº†ï¼Œä¸€ä¸ª<code>dfs</code>å°±æå®šäº†ã€‚</p><p>æ ¹æ®é¢˜ç›®è¦æ±‚å®Œæˆ<code>vm.c</code>æ–‡ä»¶ä¸­çš„<code>vmprint</code>å‡½æ•°ï¼Œä¸ºäº†æ–¹ä¾¿éå†ï¼Œæˆ‘è¿˜å®šä¹‰äº†ä¸€ä¸ª<code>dfs</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">pagetable_t</span> pagetable, <span class="type">int</span> level)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; i++) &#123;</span><br><span class="line">        <span class="type">pte_t</span> pte = pagetable[i];</span><br><span class="line">        <span class="keyword">if</span> (pte &amp; PTE_V) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> j = level; j &lt;= <span class="number">2</span>; j++) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot; ..&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d: pte %p pa %p\n&quot;</span>, i, pte, <span class="built_in">PTE2PA</span>(pte));</span><br><span class="line">            <span class="keyword">if</span> (level != <span class="number">0</span>) &#123;</span><br><span class="line">                uint64 child = <span class="built_in">PTE2PA</span>(pte);</span><br><span class="line">                <span class="built_in">dfs</span>((<span class="type">pagetable_t</span>)child, level - <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">vmprint</span><span class="params">(<span class="type">pagetable_t</span> pagetable)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>, pagetable);</span><br><span class="line">    <span class="built_in">dfs</span>(pagetable, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åéœ€è¦åœ¨<code>defs.h</code>ä¸­å£°æ˜ä¸€ä¸ªè¿™ä¸ªå‡½æ•°</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>    <span class="title">vmprint</span><span class="params">(<span class="type">pagetable_t</span>)</span></span>;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ç¬¬äºŒä¸ªä»»åŠ¡ä¹Ÿå®Œæˆäº†</p><h3 id="Detecting-which-pages-have-been-accessed"><a href="#Detecting-which-pages-have-been-accessed" class="headerlink" title="Detecting which pages have been accessed"></a>Detecting which pages have been accessed</h3><blockquote><p>é¢˜ç›®è¦æ±‚ï¼šç»™é¡µè¡¨æ·»åŠ ä¸€ä½ç”¨äºæ ‡è®°æ˜¯å¦è¢«è®¿é—®ï¼Œå¹¶å®ç°<code>sys_pgaccess</code>ç³»ç»Ÿè°ƒç”¨</p></blockquote><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231022213259048.png" alt="image-20231022213259048"></p><p>é€šè¿‡æŸ¥é˜…ä¸Šå›¾å‘ç°ï¼Œè®¿é—®ä½æ˜¯<code>6</code>ï¼Œå› æ­¤å…ˆåœ¨<code>riscv/h</code>æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªå®</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_A (1L &lt;&lt; 6)  <span class="comment">// access bit</span></span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨<code>sysproc.c</code>æ–‡ä»¶ä¸­å®ç°è¯¥ç³»ç»Ÿè°ƒç”¨ï¼Œé€šè¿‡æŸ¥çœ‹<code>pgaccess_test</code>å‡½æ•°å‘ç°ï¼Œéœ€è¦ä¼ å…¥ä¸‰ä¸ªå‚æ•°ï¼Œé¦–å…ˆè°ƒç”¨<code>argaddr</code>å’Œ<code>argint</code>è·å–åˆ°ç³»ç»Ÿè°ƒç”¨çš„ä¸‰ä¸ªå‚æ•°ï¼Œç„¶åè°ƒç”¨<code>walk</code>å‡½æ•°å¾—åˆ°æ¯ä¸ªéœ€è¦ç¡®è®¤çš„æ¯ä¸ª0çº§é¡µè¡¨PTEï¼Œåˆ¤æ–­é¡µé¢æ ‡å¿—æ¥ç¡®è®¤æ˜¯å¦è¢«è®¿é—®ï¼Œæœ€åä¸è¦å¿˜è®°å°†é¡µé¢çš„<code>PTE_A</code>æ ‡å¿—æ¸…0ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">sys_pgaccess</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// lab pgtbl: your code here.</span></span><br><span class="line">    uint64 addr, va;</span><br><span class="line">    <span class="type">int</span> len;</span><br><span class="line">    uint64 mask = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">argaddr</span>(<span class="number">0</span>, &amp;addr);</span><br><span class="line">    <span class="built_in">argint</span>(<span class="number">1</span>, &amp;len);</span><br><span class="line">    <span class="built_in">argaddr</span>(<span class="number">2</span>, &amp;va);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">proc</span> *p = <span class="built_in">myproc</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="type">pte_t</span> *pte = <span class="built_in">walk</span>(p-&gt;pagetable, addr + i * PGSIZE, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(*pte &amp; PTE_A) &#123;</span><br><span class="line">            mask |= <span class="number">1</span> &lt;&lt; i;</span><br><span class="line">            *pte &amp;= ~PTE_A; <span class="comment">// å°†è®¿é—®ä½æ¸…é›¶</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">copyout</span>(p-&gt;pagetable, va, (<span class="type">char</span> *)&amp;mask, <span class="built_in">sizeof</span>(mask)) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç¬¬ä¸‰ä¸ªä»»åŠ¡ä¹Ÿå¤§åŠŸå‘Šæˆ</p><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231022211453629.png" alt="image-20231022211453629" style="zoom:50%;" /></p>]]></content>
      
      
      <categories>
          
          <category> æ“ä½œç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</title>
      <link href="/2023/10/16/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/"/>
      <url>/2023/10/16/%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C%E7%AE%97%E6%B3%95/</url>
      
        <content type="html"><![CDATA[<p>ä¸€è‡´æ€§å“ˆå¸Œçš„åŸç†ï¼Œå¯ä»¥ç›´æ¥çœ‹å°æ—codingçš„<a href="https://www.xiaolincoding.com/os/8_network_system/hash.html#_9-4-%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%80%E8%87%B4%E6%80%A7%E5%93%88%E5%B8%8C">ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§å“ˆå¸Œ</a></p><h3 id="Golangâ€”â€”groupcache"><a href="#Golangâ€”â€”groupcache" class="headerlink" title="Golangâ€”â€”groupcache"></a>Golangâ€”â€”groupcache</h3><p>åœ¨<code>golang</code>å®˜æ–¹çš„ä»“åº“ä¸­æœ‰ä¸ªåå«<code>groupcache</code>çš„ä»“åº“ï¼Œé‡Œé¢æä¾›äº†ä¸ªç®€å•çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•æ˜¯<a href="https://github.com/golang/groupcache/blob/master/consistenthash/consistenthash.go">å®ç°</a>ï¼Œå…ˆç®€å•åˆ†æä¸€ä¸‹è¿™ä¸ªçš„æºç ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> consistenthash</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;hash/crc32&quot;</span></span><br><span class="line"><span class="string">&quot;sort&quot;</span></span><br><span class="line"><span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Hash <span class="function"><span class="keyword">func</span><span class="params">(data []<span class="type">byte</span>)</span></span> <span class="type">uint32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">hash     Hash<span class="comment">// å“ˆå¸Œå‡½æ•°</span></span><br><span class="line">replicas <span class="type">int</span><span class="comment">// æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹çš„æ•°é‡</span></span><br><span class="line">keys     []<span class="type">int</span> <span class="comment">// Sorted</span></span><br><span class="line">hashMap  <span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span><span class="comment">// è™šæ‹ŸèŠ‚ç‚¹å¯¹åº”çš„å®é™…èŠ‚ç‚¹</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(replicas <span class="type">int</span>, fn Hash)</span></span> *Map &#123;</span><br><span class="line">m := &amp;Map&#123;</span><br><span class="line">replicas: replicas,</span><br><span class="line">hash:     fn,</span><br><span class="line">hashMap:  <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="type">string</span>),</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> m.hash == <span class="literal">nil</span> &#123;</span><br><span class="line">m.hash = crc32.ChecksumIEEE</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> m</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IsEmpty returns true if there are no items available.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> IsEmpty() <span class="type">bool</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">len</span>(m.keys) == <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Add adds some keys to the hash.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Add(keys ...<span class="type">string</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> _, key := <span class="keyword">range</span> keys &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; m.replicas; i++ &#123;</span><br><span class="line">hash := <span class="type">int</span>(m.hash([]<span class="type">byte</span>(strconv.Itoa(i) + key)))</span><br><span class="line">m.keys = <span class="built_in">append</span>(m.keys, hash)</span><br><span class="line">m.hashMap[hash] = key</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// æ’åºï¼Œæ–¹ä¾¿äºŒåˆ†æŸ¥æ‰¾ï¼Œå¦åˆ™åªèƒ½ä¸€ä¸ªä¸€ä¸ªéå†</span></span><br><span class="line">sort.Ints(m.keys)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Get gets the closest item in the hash to the provided key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Get(key <span class="type">string</span>) <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">if</span> m.IsEmpty() &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hash := <span class="type">int</span>(m.hash([]<span class="type">byte</span>(key)))</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰¾åˆ°ç¬¬ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹</span></span><br><span class="line">idx := sort.Search(<span class="built_in">len</span>(m.keys), <span class="function"><span class="keyword">func</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123; <span class="keyword">return</span> m.keys[i] &gt;= hash &#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ²¡æ‰¾åˆ°ï¼Œåˆ™æ˜¯ç¬¬ä¸€ä¸ªè™šæ‹ŸèŠ‚ç‚¹ï¼ˆç¯å½¢ï¼‰</span></span><br><span class="line"><span class="keyword">if</span> idx == <span class="built_in">len</span>(m.keys) &#123;</span><br><span class="line">idx = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> m.hashMap[m.keys[idx]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>consistenthash</code>åŒ…å¯¹å¤–æä¾›äº†ä¸‰ä¸ªå‡½æ•°ï¼š</p><ol><li><code>New(replicas int, fn Hash)</code>ï¼šè¿”å›ä¸€ä¸ª<code>Map</code>å¯¹è±¡ï¼Œè¿™ä¸ª<code>Map</code>å¯¹è±¡æ˜¯é‡æ–°å®šä¹‰è¿‡çš„ï¼Œå…¶ä¸­<code>replicas</code>ä»£è¡¨æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”çš„è™šæ‹ŸèŠ‚ç‚¹çš„æ•°é‡ï¼Œ<code>fn</code>ä»£è¡¨å“ˆå¸Œå‡½æ•°ï¼ˆ<code>nil</code>çš„è¯ä¼šä½¿ç”¨é»˜è®¤çš„å“ˆå¸Œå‡½æ•°<code>crc32.ChecksumIEEE</code>ï¼‰ï¼Œå¹¶ä¸”åˆå§‹åŒ–ä¸€ä¸ª<code>map</code>ã€‚</li><li><code>Add</code>ï¼šå‘å“ˆå¸Œç¯ä¸Šæ·»åŠ èŠ‚ç‚¹</li><li><code>Get</code>ï¼šä¼ å…¥ä¸€ä¸ª<code>key</code>ï¼Œè·å–å…¶å¯¹åº”åˆ†é…çš„å®é™…èŠ‚ç‚¹</li></ol>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIT6.s081-lab-syscall</title>
      <link href="/2023/10/15/MIT6-s081-lab-syscall/"/>
      <url>/2023/10/15/MIT6-s081-lab-syscall/</url>
      
        <content type="html"><![CDATA[<h3 id="Using-gdb"><a href="#Using-gdb" class="headerlink" title="Using gdb"></a>Using gdb</h3><blockquote><p>å¦‚æœä¸çŸ¥é“æ€ä¹ˆè¿è¡Œgdbçš„ï¼Œè¦å…ˆçœ‹æä¾›çš„<a href="https://pdos.csail.mit.edu/6.S081/2023/labs/gdb.html">æ–‡æ¡£</a></p></blockquote><p>1.é¦–å…ˆåœ¨ç»ˆç«¯1ä¸­è¿è¡Œ<code>make qemu-gdb</code>ï¼Œç»“å°¾å¤„ä¼šå¾—åˆ°ä¸€ä¸ªç«¯å£å·ï¼Œä¾›ç»ˆç«¯2ä½¿ç”¨</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231015163310695.png" alt="image-20231015163310695"></p><p>2.æ–°èµ·ä¸€ä¸ªç»ˆç«¯ï¼Œè¿è¡Œ<code>riscv64-unknown-elf-gdb</code>ï¼Œä¼šè¿›å…¥å¦‚ä¸‹æ‰€ç¤ºçš„ç•Œé¢</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231015163444155.png" alt="image-20231015163444155" style="zoom:50%;" /></p><p>3.è¾“å…¥<code>target remote localhost: 25501</code>ï¼Œç„¶åå†è¾“å…¥<code>file kernel/kernel</code>ï¼Œå°±å¯ä»¥è·Ÿç€æŒ‡ç¤ºå¾€ä¸‹åšäº†</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231015163657010.png" alt="image-20231015163657010" style="zoom:100%;" /></p><blockquote><p>é—®é¢˜1ï¼šLooking at the backtrace output, which function called <code>syscall</code>?</p><p>usertrap()</p></blockquote><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231015163802691.png" alt="image-20231015163802691" style="zoom:100%;" /></p><blockquote><p>é—®é¢˜2ï¼šWhat is the value of <code>p-&gt;trapframe-&gt;a7</code> and what does that value represent? </p></blockquote><p>ä»<code>initcode.S</code>æ–‡ä»¶ä¸­çœ‹åˆ°<code>a7</code>ä¿å­˜çš„æ˜¯è¦æ‰§è¡Œçš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œä»<code>syscall.h</code>ä¸­çœ‹åˆ°<code>7</code>æ˜¯<code>SYS_exec</code></p><blockquote><p>7å’Œexecçš„ç³»ç»Ÿè°ƒç”¨å·</p></blockquote><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231015164051477.png" alt=""></p><blockquote><p>é—®é¢˜3ï¼šWhat was the previous mode that the CPU was in?</p></blockquote><p>é€šè¿‡è¾“å…¥<code>p /x $sstatus</code>ï¼Œå¾—åˆ°<code>0x200000022</code>ï¼Œé€šè¿‡æŸ¥è¯¢ç›¸å…³æ–‡æ¡£å¾—åˆ°ä¹‹å‰çš„ç‰¹æƒçº§åˆ«æ˜¯<code>user mode</code>ï¼Œå…¶ä¸­çš„<code>8</code>è¿™ä¸ªä½ç½®<code>SPP</code>å°±è¡¨ç¤ºæºè‡ªä»€ä¹ˆæ¨¡å¼ï¼ˆ0è¡¨ç¤ºç”¨æˆ·æ¨¡å¼ï¼‰ã€‚</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231015164751145.png" alt="image-20231015164751145"></p><blockquote><p>ç”¨æˆ·æ¨¡å¼</p><p>é—®é¢˜4ï¼šWrite down the assembly instruction the kernel is panicing at. Which register corresponds to the variable <code>num</code>?</p></blockquote><p>è·Ÿç€ä½œä¸šçš„æŒ‡ç¤ºèµ°ï¼Œåœ¨<code>kernel.asm</code>æ–‡ä»¶ä¸­æœç´¢åœ°å€å¯ä»¥çœ‹åˆ°ï¼š</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231015200533042.png" alt="image-20231015200533042"></p><blockquote><p>åœ¨lw a3,0(zero)å¤„panicï¼Œå­˜åœ¨å¯„å­˜å™¨a3ä¸­</p><p>é—®é¢˜5ï¼šWhy does the kernel crash? Hint: look at figure 3-3 in the text; is address 0 mapped in the kernel address space? Is that confirmed by the value in <code>scause</code> above?</p><p>å†…æ ¸å› ä¸ºåŠ è½½äº†ä¸€ä¸ªæœªä½¿ç”¨çš„åœ°å€ 0 å¤„çš„å†…å­˜æ•°æ®è€Œå´©æºƒï¼ˆLoad page faultï¼‰ã€‚åœ°å€ 0 å¹¶ä¸æ˜ å°„åˆ°å†…æ ¸ç©ºé—´ä¸­ï¼ˆä» <code>0x80000000</code> å¼€å§‹ï¼‰ã€‚</p><p>é—®é¢˜6ï¼šWhat is the name of the binary that was running when the kernel paniced? What is its process id (<code>pid</code>)?</p><p>è¿™ä¸ªäºŒè¿›åˆ¶çš„åå­—ä¸º <code>initcode</code> ï¼Œå…¶ process id ä¸º 1.</p></blockquote><h3 id="System-call-tracing"><a href="#System-call-tracing" class="headerlink" title="System call tracing"></a>System call tracing</h3><blockquote><p>å»ºè®®å…ˆè¯»å‡ éä½œä¸šæ–‡æ¡£ï¼Œè¿™ä¸¤ä¸ªä½œä¸šéœ€è¦å®ç°çš„é€»è¾‘ä¸éš¾ï¼Œä½†æ˜¯è¿™ä¸ªæµç¨‹ç¨å¾®å¤šäº†äº›</p></blockquote><ol><li>é¦–å…ˆåœ¨<code>Makefile</code>ä¸­æ·»åŠ <code>$U/_trace\</code></li></ol><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016215601273.png" alt="image-20231016215601273" style="zoom:50%;" /></p><ol><li>ç„¶ååœ¨<code>user.h</code>æ–‡ä»¶ä¸­æ³¨å†Œå¯¹åº”çš„å‡½æ•°</li></ol><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016215751599.png" style="zoom:50%;" /></p><ol><li>åœ¨<code>usys.pl</code>æ–‡ä»¶ä¸­ä¹Ÿæ·»åŠ å¯¹åº”çš„å…¥å£</li></ol><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016215841421.png" alt="image-20231016215841421" style="zoom:50%;" /></p><ol><li>åœ¨<code>syscall.h</code>æ–‡ä»¶ä¸­æ·»åŠ å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å·</li></ol><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016220127159.png" alt="image-20231016220127159" style="zoom:50%;" /></p><ol><li>åœ¨<code>sysproc.c</code>æ–‡ä»¶ä¸­å®ç°<code>sys_trace</code>å‡½æ•°ï¼Œä»ç”¨æˆ·æ€è·å–åˆ°ç”¨æˆ·è¾“å…¥çš„<code>mask</code>ï¼Œç„¶åèµ‹å€¼ç»™è¿›ç¨‹çš„<code>syscall_trace</code>æˆå‘˜ï¼Œè¯¥æˆå‘˜éœ€è¦åœ¨<code>proc.h</code>æ–‡ä»¶ä¸­çš„<code>proc</code>ç»“æ„ä½“æ·»åŠ </li></ol><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016221346681.png" alt="image-20231016221346681" style="zoom:50%;" /></p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016220431358.png" alt="image-20231016220431358" style="zoom:50%;" /></p><ol><li>åœ¨<code>proc.c</code>æ–‡ä»¶ä¸­ä¿®æ”¹<code>fork</code>å‡½æ•°ï¼Œåœ¨çˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™å°†è¯¥å€¼å¤åˆ¶è¿‡å»ï¼Œå¦‚ä¸‹</li></ol><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016220616830.png" alt="image-20231016220616830" style="zoom:50%;" /></p><ol><li>æœ€åä¿®æ”¹<code>syscall.c</code>æ–‡ä»¶ä¸­çš„<code>syscall</code>å‡½æ•°ï¼Œåœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™æ ¹æ®<code>mask</code>æ‰“å°ç›¸åº”çš„ä¿¡æ¯</li></ol><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016220722966.png" alt="image-20231016220722966" style="zoom:50%;" /></p><h3 id="Sysinfo"><a href="#Sysinfo" class="headerlink" title="Sysinfo"></a>Sysinfo</h3><p>è¯¥å®éªŒæµç¨‹è·Ÿå‰é¢çš„å·®ä¸å¤šï¼Œè¿™é‡Œä¸»è¦æè¿°ä¸€ä¸‹<code>freemem</code>å’Œ<code>nproc</code>æ€ä¹ˆè®¡ç®—å¾—åˆ°çš„ï¼Œæ ¹æ®è¯¾ç¨‹çš„ä½œä¸šæç¤ºæˆ‘ä»¬åœ¨<code>kalloc.c</code>æ–‡ä»¶ä¸­åˆ›å»ºä¸€ä¸ª<code>count_freeMem</code>ç”¨æ¥è¿”å›ç©ºé—²çš„å†…å­˜å­—èŠ‚æ•°ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯è¿™ä¹ˆè®¡ç®—ï¼Œå› ä¸ºå¯ä»¥çœ‹å‡ºæ¥<code>xv6</code>ç³»ç»Ÿä½¿ç”¨çš„æ˜¯ç©ºé—²é“¾è¡¨æ³•æ¥åˆ†é…å†…å­˜çš„</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›ç©ºé—²å†…å­˜çš„å­—èŠ‚æ•°=ç©ºé—²é¡µæ•°*æ¯é¡µå­—èŠ‚æ•°</span></span><br><span class="line">uint64 <span class="title function_">count_freeMem</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// å…ˆä¸Šé”</span></span><br><span class="line">    acquire(&amp;kmem.lock);</span><br><span class="line">    uint64 bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span> =</span> kmem.freelist;</span><br><span class="line">    <span class="keyword">while</span> (r) &#123;</span><br><span class="line">        bytes += PGSIZE;</span><br><span class="line">        r = r-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    release(&amp;kmem.lock);</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶ä¸”åœ¨<code>proc.c</code>æ–‡ä»¶ä¸­åˆ›å»ºä¸€ä¸ª<code>count_process</code>ç”¨æ¥è¿”å›ä¸æ˜¯<code>UNUSED</code>çŠ¶æ€çš„è¿›ç¨‹æ•°é‡</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›å·²ç»åˆ†é…çš„è¿›ç¨‹æ•°</span></span><br><span class="line">uint64 <span class="title function_">count_process</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    uint64 cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">struct</span> proc *p = proc; p &lt; &amp;proc[NPROC]; p++) &#123;</span><br><span class="line">        <span class="comment">// åªæœ‰è¯»è¯·æ±‚ï¼Œä¸éœ€è¦ä¸Šé”</span></span><br><span class="line">        <span class="keyword">if</span> (p-&gt;state != UNUSED)</span><br><span class="line">            cnt++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ä¸ªå‡½æ•°ä¹Ÿéƒ½å¾ˆç›´è§‚ï¼Œåº”è¯¥æ˜¯æ²¡ä»€ä¹ˆéš¾åº¦ï¼Œæœ€åè·‘ä¸€ä¸‹<code>make grade</code>çœ‹çœ‹å¾—åˆ†å§ï½</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231016221308188.png" alt="image-20231016221308188" style="zoom:50%;" /></p>]]></content>
      
      
      <categories>
          
          <category> æ“ä½œç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MIT6.s081-lab-util</title>
      <link href="/2023/10/14/MIT6-s081-lab-util/"/>
      <url>/2023/10/14/MIT6-s081-lab-util/</url>
      
        <content type="html"><![CDATA[<h3 id="sleep"><a href="#sleep" class="headerlink" title="sleep"></a>sleep</h3><blockquote><p>æ³¨æ„ğŸ‘‡è¿™ä¸‰ä¸ªå¤´æ–‡ä»¶çš„é¡ºåºä¸èƒ½ä¿®æ”¹ï¼Œå¦‚æœIDEæœ‰è‡ªåŠ¨æ’åºincludeçš„åŠŸèƒ½è¦å…³é—­ï¼Œå¦åˆ™é€šè¿‡ä¸äº†ç¼–è¯‘</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: need sleep seconds\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> time = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">    sleep(time);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="pingpong"><a href="#pingpong" class="headerlink" title="pingpong"></a>pingpong</h3><blockquote><p>ä»£ç çœ‹èµ·æ¥æ¯”è¾ƒå¤šï¼Œå…¶å®æ ¸å¿ƒæ¯”è¾ƒå°‘çš„ï¼Œæˆ‘åŠ äº†å¾ˆå¤šcloseï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œé¢å¯ä»¥ä¸åŠ ï¼Œåº”è¯¥ç”¨ä¸äº†å‡ ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä½†æ˜¯ä¸‹é¢é‚£ä¸€é¢˜ä¸€å®šè¦åŠ ï¼Œå¦åˆ™è¿‡ä¸äº†</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 1</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> p1[<span class="number">2</span>], p2[<span class="number">2</span>];</span><br><span class="line">    <span class="type">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="keyword">if</span> (pipe(p1) &lt; <span class="number">0</span> || pipe(p2) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;pipe failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;fork failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">        close(p1[<span class="number">1</span>]);</span><br><span class="line">        close(p2[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (read(p1[<span class="number">0</span>], buf, BUF_SIZE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;read failed\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> pid = getpid();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d: received ping\n&quot;</span>, pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (write(p2[<span class="number">1</span>], buf, BUF_SIZE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;write failed\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        close(p1[<span class="number">0</span>]);</span><br><span class="line">        close(p2[<span class="number">1</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        close(p1[<span class="number">0</span>]);</span><br><span class="line">        close(p2[<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">if</span> (write(p1[<span class="number">1</span>], buf, BUF_SIZE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;write failed\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (read(p2[<span class="number">0</span>], buf, BUF_SIZE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;read failed\n&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> pid = getpid();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d: received pong\n&quot;</span>, pid);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="number">0</span>);</span><br><span class="line">        close(p1[<span class="number">1</span>]);</span><br><span class="line">        close(p2[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="primes"><a href="#primes" class="headerlink" title="primes"></a>primes</h3><blockquote><p>è¿™é¢˜éœ€è¦äº†è§£ä»€ä¹ˆæ˜¯è´¨æ•°ç­›ï¼Œä½œä¸šé‡Œé¢ç»™å‡ºäº†ä¸ª<a href="http://swtch.com/~rsc/thread/">é“¾æ¥</a>ï¼Œè§£é‡Šäº†ä¸€ä¸‹ï¼Œè¿™é‡Œæˆ‘ä¹Ÿç®€å•ç”»ä¸ªå›¾è§£é‡Šä¸‹è¯¥é¢˜çš„å¤„ç†æµç¨‹ã€‚</p></blockquote><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231014112948202.png" alt="image-20231014112948202" style="zoom: 50%;" /></p><p>çœ‹æ‡‚äº†ä¸Šé¢è¿™ä¸ªå›¾ï¼Œå†çœ‹ä¸‹é¢çš„ä»£ç å°±å¾ˆæ¸…æ™°äº†</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">process</span><span class="params">(<span class="type">int</span> left[<span class="number">2</span>])</span> &#123;</span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    read(left[<span class="number">0</span>], &amp;num, <span class="keyword">sizeof</span>(num));</span><br><span class="line">    <span class="keyword">if</span> (num == <span class="number">-1</span>) <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prime %d\n&quot;</span>, num);</span><br><span class="line">    <span class="type">int</span> right[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe(right) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pipe failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è·Ÿmainå‡½æ•°åšçš„ä¸€æ ·</span></span><br><span class="line">        close(right[<span class="number">1</span>]);</span><br><span class="line">        close(left[<span class="number">0</span>]);</span><br><span class="line">        process(right);</span><br><span class="line">        close(right[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        close(right[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span> buf;</span><br><span class="line">        <span class="keyword">while</span> (read(left[<span class="number">0</span>], &amp;buf, <span class="keyword">sizeof</span>(buf)) &amp;&amp; buf != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (buf % num != <span class="number">0</span>)</span><br><span class="line">                write(right[<span class="number">1</span>], &amp;buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠ-1ä¼ é€’ç»™ä¸‹ä¸€ä¸ªè¿›ç¨‹</span></span><br><span class="line">        write(right[<span class="number">1</span>], &amp;buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        close(right[<span class="number">1</span>]);</span><br><span class="line">        close(left[<span class="number">0</span>]);</span><br><span class="line">        wait(<span class="number">0</span>);  <span class="comment">// ç­‰å¾…å­è¿›ç¨‹å¤„ç†å®Œæ¯•</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="type">int</span> p[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span> (pipe(p) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pipe failed\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// å­è¿›ç¨‹åªè¯»ï¼Œå› æ­¤å…³é—­å†™</span></span><br><span class="line">        close(p[<span class="number">1</span>]);</span><br><span class="line">        process(p);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// çˆ¶è¿›åœºåªå†™ï¼Œå…³é—­è¯»</span></span><br><span class="line">        close(p[<span class="number">0</span>]);</span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt;= <span class="number">35</span>; i++) &#123;</span><br><span class="line">            write(p[<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line">        &#125;</span><br><span class="line">        i = <span class="number">-1</span>;</span><br><span class="line">        <span class="comment">// å“¨å…µæ ‡è¯†å¤„ç†å®Œæ¯•</span></span><br><span class="line">        write(p[<span class="number">1</span>], &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line">        wait(<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);  <span class="comment">// ç­‰å¾…å­è¿›ç¨‹å¤„ç†å®Œæ¯•</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="find"><a href="#find" class="headerlink" title="find"></a>find</h3><blockquote><p>findä¸»è¦æ³¨æ„ä¸è¦å¤„ç†â€.â€å’Œâ€..â€æ–‡ä»¶å¤¹ï¼Œå¦åˆ™ä¼šæ­»å¾ªç¯ä¸‹å»ï¼Œå…¶ä»–çš„å°±æŒ‰ç…§ls.cæ–‡ä»¶ä¸‹é¢çš„å†™æ³•</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/fs.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/fcntl.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">find</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">const</span> <span class="type">char</span> *filename)</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> <span class="title">de</span>;</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">512</span>];</span><br><span class="line">    <span class="type">char</span> *p;</span><br><span class="line">    <span class="keyword">if</span> ((fd = open(path, O_RDONLY)) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;find: cannot open %s\n&quot;</span>, path);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fstat(fd, &amp;st) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;find: cannot stat %s\n&quot;</span>, path);</span><br><span class="line">        close(fd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> (st.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> T_DEVICE:</span><br><span class="line">    <span class="keyword">case</span> T_FILE:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strcmp</span>(path + <span class="built_in">strlen</span>(path) - <span class="built_in">strlen</span>(filename), filename) == <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, path);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> T_DIR:</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">strlen</span>(path) + <span class="number">1</span> + DIRSIZ + <span class="number">1</span> &gt; <span class="keyword">sizeof</span>(buf)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;find: path too long\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">strcpy</span>(buf, path);</span><br><span class="line">        p = buf + <span class="built_in">strlen</span>(buf);</span><br><span class="line">        *p++ = <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">        <span class="keyword">while</span> (read(fd, &amp;de, <span class="keyword">sizeof</span>(de)) == <span class="keyword">sizeof</span>(de)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (de.inum == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">strcmp</span>(de.name, <span class="string">&quot;.&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(de.name, <span class="string">&quot;..&quot;</span>) == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            memmove(p, de.name, DIRSIZ);</span><br><span class="line">            p[DIRSIZ] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (stat(buf, &amp;st) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;find: cannot stat %s\n&quot;</span>, buf);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            find(buf, filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> <span class="type">const</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;usage: find &lt;path&gt; &lt;filename&gt;\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    find(argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="xargs"><a href="#xargs" class="headerlink" title="xargs"></a>xargs</h3><blockquote><p>è¿™éƒ¨åˆ†å¯èƒ½ä¸äº†è§£è¿™ä¸ªå‘½ä»¤åœ¨linuxæœ‰ä»€ä¹ˆä½œç”¨çš„äººä¼šä¸çŸ¥æ‰€æªï¼Œå¯ä»¥å…ˆå»äº†è§£çœ‹çœ‹è¿™ä¸ªå‘½ä»¤æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œä½œä¸šé‡Œé¢æ˜¯æ¯”è¾ƒç®€åŒ–çš„ç‰ˆæœ¬</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/stat.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;user/user.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel/param.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUF_SIZE 512</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span> &#123;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥å‘½ä»¤è¡Œå‚æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;Usage: xargs command\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°†é™¤ç¬¬ä¸€ä¸ªå‚æ•°å¤–çš„å…¶ä»–å‚æ•°å­˜å‚¨åˆ°ä¸€ä¸ªæ•°ç»„ä¸­</span></span><br><span class="line">    <span class="type">char</span>* args[MAXARG + <span class="number">1</span>];</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; argc; ++i) &#123;</span><br><span class="line">        args[index++] = argv[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»æ ‡å‡†è¾“å…¥ä¸­è¯»å–ä¸€è¡Œè¡Œçš„æ–‡æœ¬</span></span><br><span class="line">    <span class="type">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="type">char</span>* p = buf;</span><br><span class="line">    <span class="keyword">while</span> (read(<span class="number">0</span>, p, <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((*p) == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            <span class="comment">// å½“è¯»å–åˆ°ä¸€è¡Œæ–‡æœ¬æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹</span></span><br><span class="line">            *p = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> pid;</span><br><span class="line">            <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">                <span class="comment">// å°†è¯¥è¡Œæ–‡æœ¬ä½œä¸ºå‚æ•°ä¼ é€’ç»™æŒ‡å®šçš„å‘½ä»¤</span></span><br><span class="line">                args[index] = buf;</span><br><span class="line">                <span class="comment">// æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤</span></span><br><span class="line">                exec(argv[<span class="number">1</span>], args);</span><br><span class="line">                <span class="comment">// å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œåˆ™è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡ºå­è¿›ç¨‹</span></span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="number">2</span>, <span class="string">&quot;exec %s failed\n&quot;</span>, argv[<span class="number">1</span>]);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line">            <span class="comment">// ç­‰å¾…å­è¿›ç¨‹æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">            wait(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">// é‡ç½®ç¼“å†²åŒºæŒ‡é’ˆï¼Œå‡†å¤‡è¯»å–ä¸‹ä¸€è¡Œæ–‡æœ¬</span></span><br><span class="line">            p = buf;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªå­—ç¬¦</span></span><br><span class="line">            ++p;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€€å‡ºç¨‹åº</span></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æœ€åè¦è®°ä½åœ¨ä¸»ç›®å½•ä¸‹é¢æ·»åŠ åº”è¯¥time.txtæ–‡ä»¶ï¼Œç„¶åå†™ä¸Šä¸€ä¸ªæ•´æ•°ï¼Œä¸ç„¶åˆ†æ•°åªæœ‰99</p></blockquote><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20231014113517139.png" alt="image-20231014113517139" style="zoom:50%;" /></p>]]></content>
      
      
      <categories>
          
          <category> æ“ä½œç³»ç»Ÿ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> lab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŒå‘é“¾è¡¨listæºç å­¦ä¹ </title>
      <link href="/2023/09/25/%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8list%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/09/25/%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8list%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç‰¹åˆ«æé†’ï¼Œæœ¬æ–‡æ‰€æ¶‰åŠçš„æºç æ˜¯<code>go1.21.0 darwin/amd64</code><br>æ–‡ä»¶ä½ç½®ï¼šcontainer/list/list.go</p></blockquote><h3 id="1-æ•°æ®ç»“æ„"><a href="#1-æ•°æ®ç»“æ„" class="headerlink" title="1 æ•°æ®ç»“æ„"></a>1 æ•°æ®ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Element <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å’Œå‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    next, prev *Element</span><br><span class="line">    <span class="comment">// æ ‡è¯†å½“å‰elementæ‰€å±çš„List</span></span><br><span class="line">    list *List</span><br><span class="line">    <span class="comment">// å­˜å‚¨çš„å½“å‰èŠ‚ç‚¹å€¼</span></span><br><span class="line">    Value any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> List <span class="keyword">struct</span> &#123;</span><br><span class="line">    root Element <span class="comment">// å“¨å…µèŠ‚ç‚¹</span></span><br><span class="line">    <span class="built_in">len</span>  <span class="type">int</span>     <span class="comment">// é“¾è¡¨é•¿åº¦ï¼ˆä¸ç®—å“¨å…µèŠ‚ç‚¹ï¼‰</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤è€…çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230925202523466.png" alt="image-20230925202523466" style="zoom:50%;" /></p><h3 id="2-åˆå§‹åŒ–"><a href="#2-åˆå§‹åŒ–" class="headerlink" title="2 åˆå§‹åŒ–"></a>2 åˆå§‹åŒ–</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> Init() *List &#123;</span><br><span class="line">    l.root.next = &amp;l.root</span><br><span class="line">    l.root.prev = &amp;l.root</span><br><span class="line">    l.<span class="built_in">len</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> l</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å°†å“¨å…µèŠ‚ç‚¹çš„<code>next</code>å’Œ<code>prev</code>éƒ½æŒ‡å‘è‡ªå·±ï¼Œè¡¨ç¤ºå½“å‰é“¾è¡¨ä¸ºç©º</li><li>é•¿åº¦<code>len</code>è®¾ç½®ä¸º0</li><li>è¿”å›ä¸€ä¸ª<code>*List</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span></span> *List &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">new</span>(List).Init() </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¤–éƒ¨é€šè¿‡è°ƒç”¨<code>New()</code>åˆ›å»ºä¸€ä¸ªåŒå‘é“¾è¡¨</li></ul><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230925203236258.png" alt="image-20230925203236258" style="zoom:50%;" /></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> lazyInit() &#123;</span><br><span class="line">    <span class="keyword">if</span> l.root.next == <span class="literal">nil</span> &#123;</span><br><span class="line">        l.Init()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ‡’åˆå§‹åŒ–ï¼šå¦‚æœè¯¥é“¾è¡¨è¿˜ä¸ºåˆå§‹åŒ–ï¼Œåˆ™è°ƒç”¨<code>Init()</code>å‡½æ•°æ¥åˆå§‹åŒ–</li></ul><h3 id="3-éå†"><a href="#3-éå†" class="headerlink" title="3 éå†"></a>3 éå†</h3><blockquote><p>è¿”å›å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span></span> Next() *Element &#123;</span><br><span class="line">    <span class="keyword">if</span> p := e.next; e.list != <span class="literal">nil</span> &amp;&amp; p != &amp;e.list.root &#123;</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœå½“å‰èŠ‚ç‚¹å·²ç»æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è¿”å›<code>nil</code></li><li>è¿”å›å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li></ul><blockquote><p>è¿”å›å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span></span> Prev() *Element &#123;</span><br><span class="line">    <span class="keyword">if</span> p := e.prev; e.list != <span class="literal">nil</span> &amp;&amp; p != &amp;e.list.root &#123;</span><br><span class="line">        <span class="keyword">return</span> p</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœå½“å‰èŠ‚ç‚¹å·²ç»æ˜¯ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™è¿”å›<code>nil</code></li><li>è¿”å›å½“å‰èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</li></ul><blockquote><p>è¿”å›åŒå‘é“¾è¡¨çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> Front() *Element &#123;</span><br><span class="line">    <span class="keyword">if</span> l.<span class="built_in">len</span> == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l.root.next</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é•¿åº¦ä¸º0ï¼Œåˆ™è¿”å›<code>nil</code></li></ul><blockquote><p>è¿”å›åŒå‘é“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> Back() *Element &#123;</span><br><span class="line">    <span class="keyword">if</span> l.<span class="built_in">len</span> == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l.root.prev</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é•¿åº¦ä¸º0ï¼Œåˆ™è¿”å›<code>nil</code></li></ul><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230925204108617.png" alt="image-20230925204108617" style="zoom:40%;" /></p><h3 id="4-æ’å…¥"><a href="#4-æ’å…¥" class="headerlink" title="4 æ’å…¥"></a>4 æ’å…¥</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨atå…ƒç´ åé¢æ’å…¥eï¼Œå¹¶ä¸”è¿”å›eï¼Œå¹¶æ›´æ–°ç›¸åº”çš„å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> insert(e, at *Element) *Element &#123;</span><br><span class="line">    e.prev = at</span><br><span class="line">    e.next = at.next</span><br><span class="line">    e.prev.next = e</span><br><span class="line">    e.next.prev = e</span><br><span class="line">    e.list = l</span><br><span class="line">    l.<span class="built_in">len</span>++</span><br><span class="line">    <span class="keyword">return</span> e</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒæ ·æ˜¯æ’å…¥ä¸€ä¸ªå…ƒç´ åœ¨atåé¢ï¼Œä½†æ˜¯åªæä¾›ä¸€ä¸ªvalueï¼Œéœ€è¦å¸®ä»–åˆ›å»ºä¸€ä¸ªElement</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> insertValue(v any, at *Element) *Element &#123;</span><br><span class="line">    <span class="keyword">return</span> l.insert(&amp;Element&#123;Value: v&#125;, at)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> PushFront(v any) *Element &#123;</span><br><span class="line">    l.lazyInit()</span><br><span class="line">    <span class="keyword">return</span> l.insertValue(v, &amp;l.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœé“¾è¡¨<code>l</code>æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™å…ˆåˆå§‹åŒ–</li><li>æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹å€¼ä¸º<code>v</code>çš„èŠ‚ç‚¹åœ¨é“¾è¡¨<code>l</code>çš„å¤´éƒ¨</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> PushBack(v any) *Element &#123;</span><br><span class="line">    l.lazyInit()</span><br><span class="line">    <span class="keyword">return</span> l.insertValue(v, l.root.prev)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœé“¾è¡¨<code>l</code>æ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™å…ˆåˆå§‹åŒ–</li><li>æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹å€¼ä¸º<code>v</code>çš„èŠ‚ç‚¹åœ¨é“¾è¡¨<code>l</code>çš„å°¾éƒ¨</li></ul><blockquote><p>æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹å€¼våœ¨markèŠ‚ç‚¹å‰é¢</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> InsertBefore(v any, mark *Element) *Element &#123;</span><br><span class="line">    <span class="keyword">if</span> mark.list != l &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l.insertValue(v, mark.prev)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹å€¼våœ¨markèŠ‚ç‚¹åé¢      </p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> InsertAfter(v any, mark *Element) *Element &#123;</span><br><span class="line">    <span class="keyword">if</span> mark.list != l &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l.insertValue(v, mark)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å°†é“¾è¡¨otherä¸­çš„èŠ‚ç‚¹ä¾æ¬¡æ’å…¥åˆ°é“¾è¡¨lçš„åé¢</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> PushBackList(other *List) &#123;</span><br><span class="line">    l.lazyInit()</span><br><span class="line">    <span class="keyword">for</span> i, e := other.Len(), other.Front(); i &gt; <span class="number">0</span>; i, e = i<span class="number">-1</span>, e.Next() &#123;</span><br><span class="line">        l.insertValue(e.Value, l.root.prev)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å°†é“¾è¡¨otherä¸­dèŠ‚ç‚¹æ’å…¥åˆ°é“¾è¡¨lçš„å‰é¢</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> PushFrontList(other *List) &#123;</span><br><span class="line">    l.lazyInit()</span><br><span class="line">    <span class="keyword">for</span> i, e := other.Len(), other.Back(); i &gt; <span class="number">0</span>; i, e = i<span class="number">-1</span>, e.Prev() &#123;</span><br><span class="line">        l.insertValue(e.Value, &amp;l.root)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-åˆ é™¤"><a href="#5-åˆ é™¤" class="headerlink" title="5 åˆ é™¤"></a>5 åˆ é™¤</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ é™¤èŠ‚ç‚¹e</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> remove(e *Element) &#123;</span><br><span class="line">    e.prev.next = e.next</span><br><span class="line">    e.next.prev = e.prev</span><br><span class="line">    e.next = <span class="literal">nil</span> <span class="comment">// avoid memory leaks</span></span><br><span class="line">    e.prev = <span class="literal">nil</span> <span class="comment">// avoid memory leaks</span></span><br><span class="line">    e.list = <span class="literal">nil</span></span><br><span class="line">    l.<span class="built_in">len</span>--</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> Remove(e *Element) any &#123;</span><br><span class="line">    <span class="keyword">if</span> e.list == l &#123;</span><br><span class="line">        l.remove(e)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e.Value</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœèŠ‚ç‚¹<code>e</code>åœ¨é“¾è¡¨<code>l</code>ä¸­ï¼Œåˆ™è°ƒç”¨<code>remove()</code>å‡½æ•°ç§»é™¤è¯¥èŠ‚ç‚¹</li><li>è¿”å›èŠ‚ç‚¹<code>e</code>çš„å€¼</li></ul><h3 id="6-ç§»åŠ¨"><a href="#6-ç§»åŠ¨" class="headerlink" title="6 ç§»åŠ¨"></a>6 ç§»åŠ¨</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°†eç§»åˆ°atçš„åé¢</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> move(e, at *Element) &#123;</span><br><span class="line">    <span class="keyword">if</span> e == at &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    e.prev.next = e.next</span><br><span class="line">    e.next.prev = e.prev</span><br><span class="line"></span><br><span class="line">    e.prev = at</span><br><span class="line">    e.next = at.next</span><br><span class="line">    e.prev.next = e</span><br><span class="line">    e.next.prev = e</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å°†èŠ‚ç‚¹eç§»åˆ°é“¾è¡¨lå‰é¢</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> MoveToFront(e *Element) &#123;</span><br><span class="line">    <span class="keyword">if</span> e.list != l || l.root.next == e &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    l.move(e, &amp;l.root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å°†èŠ‚ç‚¹eç§»åˆ°é“¾è¡¨lå°¾éƒ¨</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> MoveToBack(e *Element) &#123;</span><br><span class="line">    <span class="keyword">if</span> e.list != l || l.root.prev == e &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    l.move(e, l.root.prev)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å°†èŠ‚ç‚¹eç§»åˆ°èŠ‚ç‚¹markçš„å‰é¢</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> MoveBefore(e, mark *Element) &#123;</span><br><span class="line">    <span class="keyword">if</span> e.list != l || e == mark || mark.list != l &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    l.move(e, mark.prev)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å°†èŠ‚ç‚¹eç§»åˆ°èŠ‚ç‚¹markçš„åé¢</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span></span> MoveAfter(e, mark *Element) &#123;</span><br><span class="line">    <span class="keyword">if</span> e.list != l || e == mark || mark.list != l &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    l.move(e, mark)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7 æ€»ç»“"></a>7 æ€»ç»“</h3><p>ä»<code>list.go</code>æºç ä¸­ï¼Œçœ‹å¾—å‡ºå®ç°çš„è¿˜æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼Œè·Ÿæˆ‘ä»¬è‡ªå·±å®ç°çš„åŒå‘é“¾è¡¨å‡ ä¹æ— å·®åˆ«ï¼Œæºç é˜…è¯»èµ·æ¥åº”è¯¥ä¹Ÿæ˜¯æ¯«æ— å‹åŠ›</p>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>trieå‰ç¼€æ ‘</title>
      <link href="/2023/09/18/trie%E5%89%8D%E7%BC%80%E6%A0%91/"/>
      <url>/2023/09/18/trie%E5%89%8D%E7%BC%80%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<h3 id="1-å®šä¹‰"><a href="#1-å®šä¹‰" class="headerlink" title="1 å®šä¹‰"></a>1 å®šä¹‰</h3><p><code>Trie</code>æ ‘ï¼Œå³å­—å…¸æ ‘ï¼Œåˆç§°å‰ç¼€æ ‘ï¼Œæ˜¯ä¸€ç§æ ‘å½¢ç»“æ„ï¼Œæ˜¯ä¸€ç§å“ˆå¸Œæ ‘çš„å˜ç§ï¼Œåƒå­—å…¸ä¸€æ ·çš„æ ‘ã€‚</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230918162852921.png" alt="image-20230918162852921" style="zoom:40%;" /></p><p><code>Trie</code>çš„æ ¸å¿ƒæ€æƒ³æ˜¯ç©ºé—´æ¢æ—¶é—´ã€‚åˆ©ç”¨å­—ç¬¦ä¸²çš„å…¬å…±å‰ç¼€æ¥é™ä½æŸ¥è¯¢æ—¶é—´çš„å¼€é”€ä»¥è¾¾åˆ°æé«˜æ•ˆç‡çš„ç›®çš„ï¼Œä½¿ç”¨<code>Trie</code>ç›¸æ¯”å“ˆå¸ŒæŸ¥è¯¢çš„å¥½å¤„æ˜¯ï¼Œè·¯ç”±ç®—æ³•ä¸­éœ€è¦æ¨¡ç³ŠåŒ¹é…ï¼Œå“ˆå¸Œæ˜¯åšä¸åˆ°çš„ï¼Œå®ƒåªèƒ½ç²¾ç¡®æŸ¥æ‰¾ã€‚</p><h3 id="2-å®ç°"><a href="#2-å®ç°" class="headerlink" title="2 å®ç°"></a>2 å®ç°</h3><h4 id="2-1-å­—æ®µ"><a href="#2-1-å­—æ®µ" class="headerlink" title="2.1 å­—æ®µ"></a>2.1 å­—æ®µ</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Trie</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> tag;</span><br><span class="line">    Trie *nxt[<span class="number">26</span>]&#123;&#125;;</span><br><span class="line">    <span class="built_in">Trie</span>(): <span class="built_in">tag</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå®šä¹‰æ ¸å¿ƒå­—æ®µï¼Œ<code>tag</code>ç”¨æ¥è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ˜¯å¦æ˜¯æŸä¸ªå­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œæ¯”å¦‚è¯´å¦‚æœåœ¨ä¸Šé¢çš„æ ‘ä¸­ï¼Œåˆæ¥äº†ä¸€ä¸ª<code>go</code>ï¼Œé‚£åœ¨ç¬¬ä¸€ä¸ª<code>o</code>ä¸­çš„<code>tag</code>åº”è¯¥æ ‡è¯†ä¸º1</p><h4 id="2-2-æ’å…¥"><a href="#2-2-æ’å…¥" class="headerlink" title="2.2 æ’å…¥"></a>2.2 æ’å…¥</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">const</span> string &amp;s)</span> </span>&#123;</span><br><span class="line">    Trie *p = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">char</span> i : s) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>] == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>] = <span class="keyword">new</span> <span class="built_in">Trie</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        p = p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    p-&gt;tag = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å¦‚æœå­èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»ºä¸€ä¸ªå­èŠ‚ç‚¹</p></li><li><p>ç§»åŠ¨pæŒ‡é’ˆ</p></li><li>å°†æœ€åä¸€ä¸ªå­—ç¬¦çš„<code>tag</code>ç½®ä¸º1ï¼Œæ ‡è¯†ä¸€ä¸ªå­—ç¬¦ä¸²çš„æœ«å°¾</li></ul><h4 id="2-3-æŸ¥è¯¢"><a href="#2-3-æŸ¥è¯¢" class="headerlink" title="2.3 æŸ¥è¯¢"></a>2.3 æŸ¥è¯¢</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">search</span><span class="params">(<span class="type">const</span> string &amp;s)</span> </span>&#123;</span><br><span class="line">    Trie *p = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">char</span> i : s) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>] == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        p = p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p-&gt;tag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœéå†åˆ°å­èŠ‚ç‚¹ä¸º<code>nullptr</code>ï¼Œåˆ™ç›´æ¥è¿”å›<code>false</code></li><li>ç§»åŠ¨<code>p</code>æŒ‡é’ˆ</li><li>åˆ¤æ–­æœ€åä¸€ä¸ª<code>p-&gt;tag</code>æ˜¯å¦ä¸º<code>1</code></li></ul><h4 id="2-4-å‰ç¼€åŒ¹é…"><a href="#2-4-å‰ç¼€åŒ¹é…" class="headerlink" title="2.4 å‰ç¼€åŒ¹é…"></a>2.4 å‰ç¼€åŒ¹é…</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">startsWith</span><span class="params">(<span class="type">const</span> string &amp;prefix)</span> </span>&#123;</span><br><span class="line">    Trie *p = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">char</span> i : prefix) &#123;</span><br><span class="line">        <span class="keyword">if</span>(p-&gt;nxt[i-<span class="string">&#x27;a&#x27;</span>] == <span class="literal">nullptr</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        p = p-&gt;nxt[i-<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è·ŸæŸ¥è¯¢å·®ä¸å¤š</li></ul><p>æ•´ä¸ªç±»çš„å®Œæ•´å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Trie</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> tag;</span><br><span class="line">    Trie *nxt[<span class="number">26</span>]&#123;&#125;;</span><br><span class="line">    <span class="built_in">Trie</span>(): <span class="built_in">tag</span>(<span class="number">0</span>) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">insert</span><span class="params">(<span class="type">const</span> string &amp;s)</span> </span>&#123;</span><br><span class="line">        Trie *p = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> i : s) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>] == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>] = <span class="keyword">new</span> <span class="built_in">Trie</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            p = p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        p-&gt;tag = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">search</span><span class="params">(<span class="type">const</span> string &amp;s)</span> </span>&#123;</span><br><span class="line">        Trie *p = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">char</span> i : s) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>] == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            p = p-&gt;nxt[i - <span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p-&gt;tag;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">startsWith</span><span class="params">(<span class="type">const</span> string &amp;prefix)</span> </span>&#123;</span><br><span class="line">        Trie *p = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">char</span> i : prefix) &#123;</span><br><span class="line">            <span class="keyword">if</span>(p-&gt;nxt[i-<span class="string">&#x27;a&#x27;</span>] == <span class="literal">nullptr</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            p = p-&gt;nxt[i-<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æä¾›ä¸€ä¸ª<code>go</code>å®ç°çš„ç‰ˆæœ¬</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Trie <span class="keyword">struct</span> &#123;</span><br><span class="line">    nxt [<span class="number">26</span>]*Trie</span><br><span class="line">    tag <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *Trie)</span></span> Insert(word <span class="type">string</span>) &#123;</span><br><span class="line">    root := this</span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> word &#123;</span><br><span class="line">        <span class="keyword">if</span> root.nxt[c-<span class="string">&#x27;a&#x27;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">            root.nxt[c-<span class="string">&#x27;a&#x27;</span>] = &amp;Trie&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        root = root.nxt[c-<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    root.tag = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *Trie)</span></span> Search(word <span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    root := this</span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> word &#123;</span><br><span class="line">        <span class="keyword">if</span> root.nxt[c-<span class="string">&#x27;a&#x27;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        root = root.nxt[c-<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root.tag == <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *Trie)</span></span> StartsWith(prefix <span class="type">string</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    root := this</span><br><span class="line">    <span class="keyword">for</span> _, c := <span class="keyword">range</span> prefix &#123;</span><br><span class="line">        <span class="keyword">if</span> root.nxt[c-<span class="string">&#x27;a&#x27;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        root = root.nxt[c-<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒ³è¦åšé¢˜çš„è¯å¯ä»¥å»è¯•è¯•è¿™ä¸ª <a href="https://leetcode.cn/problems/implement-trie-prefix-tree/">leetcode 208. å®ç° Trie (å‰ç¼€æ ‘)</a></p><h3 id="3-radix-tree"><a href="#3-radix-tree" class="headerlink" title="3 radix tree"></a>3 radix tree</h3><p><code>gin</code>æ¡†æ¶å¹¶ä¸æ˜¯ä½¿ç”¨æ™®é€šçš„<code>trie</code>æ ‘ï¼Œè€Œæ˜¯ä¸€ç§ç»è¿‡å‹ç¼©çš„<code>Radix Trie</code>åˆå«åšåŸºæ•°æ ‘ã€åŸºæ•°ç‰¹é‡Œæ ‘ã€å‹ç¼©å‰ç¼€æ ‘ã€‚</p><p><strong>å½“æŸä¸ªçˆ¶èŠ‚ç‚¹ä»…æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶ä¸”ä¸å­˜åœ¨å­—ç¬¦ä¸²ä»¥è¯¥çˆ¶èŠ‚ç‚¹ä¸ºç»“å°¾çš„æ—¶å€™</strong>ï¼Œä¼šå°†çˆ¶èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹è¿›è¡Œåˆå¹¶ï¼Œåˆ™æœ€å‰é¢çš„<code>trie</code>æ ‘å°±ä¼šå˜æˆä¸‹å›¾ï¼š</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230918171430821.png" alt="image-20230918171430821" style="zoom:40%;" /></p>]]></content>
      
      
      <categories>
          
          <category> æ•°æ®ç»“æ„ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> C++ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sync.mapæºç å­¦ä¹ </title>
      <link href="/2023/09/12/sync-map%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/09/12/sync-map%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç‰¹åˆ«æé†’ï¼Œæœ¬æ–‡æ‰€æ¶‰åŠçš„æºç æ˜¯<code>go1.21.0 darwin/amd64</code><br>æ–‡ä»¶ä½ç½®ï¼šruntime/map.go</p></blockquote><p>æ™®é€šçš„<code>map</code>å¹¶ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå› æ­¤æƒ³è¦ä½¿ç”¨å¹¶å‘å®‰å…¨çš„<code>map</code>ï¼Œ<code>sync</code>åŒ…ä¸‹æä¾›äº†ä¸€ä¸ª<code>sync.map</code>æ•°æ®ç»“æ„</p><h3 id="1-æ•°æ®ç»“æ„"><a href="#1-æ•°æ®ç»“æ„" class="headerlink" title="1 æ•°æ®ç»“æ„"></a>1 æ•°æ®ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Map <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// ä¿æŠ¤å¹¶å‘è¯»å†™ã€å†™å†™</span></span><br><span class="line">    mu Mutex</span><br><span class="line">    read atomic.Pointer[readOnly]</span><br><span class="line">    dirty <span class="keyword">map</span>[any]*entry</span><br><span class="line">    misses <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>readï¼šæ— é”åŒ–çš„<code>map</code>ï¼Œå®é™…ç±»å‹ä¸º<code>atomic.Pointer</code></li><li>dirtyï¼šåŠ é”çš„<code>map</code>ï¼Œæ˜¯ä¸€ä¸ªæ™®é€šçš„<code>map</code></li><li>missesï¼šæ¯æ¬¡ä»<code>read</code>ä¸­è¯»å–å¤±è´¥ï¼Œ<code>misses</code>éƒ½ä¼šåŠ 1ï¼Œè¾¾åˆ°ä¸€å®šé˜ˆå€¼åï¼Œä¼šå°†<code>dirty</code>æå‡ä¸º<code>read</code></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> readOnly <span class="keyword">struct</span> &#123;</span><br><span class="line">    m       <span class="keyword">map</span>[any]*entry</span><br><span class="line">    amended <span class="type">bool</span> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>mï¼š<code>read</code>ä¸­çš„<code>map</code>ï¼Œå­˜æ”¾<code>k-v</code>å¯¹</li><li>amendedï¼šæ ‡è¯†<code>read</code>å’Œ<code>dirty</code>ä¸­çš„å…ƒç´ æ˜¯å¦ä¸€è‡´</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> entry <span class="keyword">struct</span> &#123;</span><br><span class="line">    p atomic.Pointer[any]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>pï¼š<code>k-v</code>å¯¹ä¸­çš„<code>value</code>ï¼Œä½¿ç”¨<code>atomic.Pointer</code>çš„å½¢å¼ï¼Œé€šè¿‡<code>entry.p</code>çš„æŒ‡é’ˆæ¥è·å–å€¼</li></ul><h3 id="2-entryçš„å‡ ç§çŠ¶æ€"><a href="#2-entryçš„å‡ ç§çŠ¶æ€" class="headerlink" title="2 entryçš„å‡ ç§çŠ¶æ€"></a>2 entryçš„å‡ ç§çŠ¶æ€</h3><h4 id="2-1-p-nilï¼ˆè½¯åˆ é™¤ï¼‰"><a href="#2-1-p-nilï¼ˆè½¯åˆ é™¤ï¼‰" class="headerlink" title="2.1 p==nilï¼ˆè½¯åˆ é™¤ï¼‰"></a>2.1 p==nilï¼ˆè½¯åˆ é™¤ï¼‰</h4><p>æ­¤æ—¶<code>p</code>æ˜¯<code>nil</code>ï¼Œ<code>m.dirty</code>ç­‰äº<code>nil</code>æˆ–è€…<code>m.dirty[key]</code>æŒ‡å‘è¯¥<code>entry</code></p><h4 id="2-2-p-expungedï¼ˆç¡¬åˆ é™¤ï¼‰"><a href="#2-2-p-expungedï¼ˆç¡¬åˆ é™¤ï¼‰" class="headerlink" title="2.2 p==expungedï¼ˆç¡¬åˆ é™¤ï¼‰"></a>2.2 p==expungedï¼ˆç¡¬åˆ é™¤ï¼‰</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å›ºå®šçš„å…¨å±€å˜é‡ï¼Œæ ‡è¯†è¯¥entryå·²ç»ä»m.dirtyä¸­åˆ é™¤</span></span><br><span class="line"><span class="keyword">var</span> expunged = <span class="built_in">new</span>(any)</span><br></pre></td></tr></table></figure><h4 id="2-3-pæŒ‡å‘æ­£å¸¸å€¼çš„åœ°å€"><a href="#2-3-pæŒ‡å‘æ­£å¸¸å€¼çš„åœ°å€" class="headerlink" title="2.3 pæŒ‡å‘æ­£å¸¸å€¼çš„åœ°å€"></a>2.3 pæŒ‡å‘æ­£å¸¸å€¼çš„åœ°å€</h4><p>è¿™ç§æƒ…å†µå°±æ˜¯<code>k-v</code>å¯¹æ²¡åˆ é™¤çš„æƒ…å†µï¼Œå¯ä»¥é€šè¿‡<code>m.read.m[key]</code>æ‰¾åˆ°ï¼Œå¦‚æœæ­¤æ—¶<code>dirty</code>ä¹Ÿä¸ä¸º<code>nil</code>ï¼ŒåŒæ ·ä¹Ÿå¯ä»¥é€šè¿‡<code>m.dirty[key]</code>æ‰¾åˆ°ï¼Œä¸¤è€…å®é™…æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªå€¼ã€‚</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230913154004629.png" alt="image-20230913154004629" style="zoom:40%;" /></p><h3 id="3-Load"><a href="#3-Load" class="headerlink" title="3 Load"></a>3 Load</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Load(key any) (value any, ok <span class="type">bool</span>) &#123;</span><br><span class="line">    read := m.loadReadOnly()</span><br><span class="line">    e, ok := read.m[key]</span><br><span class="line">    <span class="comment">// readä¸­æ²¡æ‰¾åˆ°ï¼Œåˆ™åˆ¤æ–­amendedæ˜¯å¦ä¸ºtrue</span></span><br><span class="line">    <span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">        m.mu.Lock()</span><br><span class="line">        read = m.loadReadOnly()</span><br><span class="line">        <span class="comment">// double checkï¼Œæœ‰å¯èƒ½åœ¨ä¸Šé”çš„è¿‡ç¨‹ä¸­ï¼Œå…¶ä¸­goroutineå°†dirtyæå‡ä¸ºreadäº†</span></span><br><span class="line">        e, ok = read.m[key]</span><br><span class="line">        <span class="comment">// è¿˜æ˜¯æ²¡æœ‰åœ¨readä¸­æ‰¾åˆ°å¯¹åº”keyçš„value</span></span><br><span class="line">        <span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">            e, ok = m.dirty[key]</span><br><span class="line">            <span class="comment">// misses++ï¼Œå¦‚æœè¶…è¿‡é˜ˆå€¼åˆ™å°†dirtyæå‡ä¸ºread</span></span><br><span class="line">            m.missLocked()</span><br><span class="line">        &#125;</span><br><span class="line">        m.mu.Unlock()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e.load()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¼šè°ƒç”¨<code>loadReadOnly</code>å‡½æ•°è·å–<code>read</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> loadReadOnly() readOnly &#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºreadæ˜¯atomicåŒ…ä¸‹çš„ç±»å‹ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨loadå‡½æ•°è·å–</span></span><br><span class="line">    <span class="keyword">if</span> p := m.read.Load(); p != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> *p</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> readOnly&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæœªåˆå§‹åŒ–ï¼Œåˆ™åœ¨è¯¥å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œå¦åˆ™ç›´æ¥è¿”å›<code>m.read</code></p><hr><p>é€šè¿‡<code>key</code>æ¥è¯»å–<code>read.m</code>ä¸­çš„<code>value</code>ï¼Œç„¶åå­˜åœ¨è¯¥å…ƒç´ åˆ™ç›´æ¥è¿”å›å€¼å°±è¡Œï¼Œå¦åˆ™è¦ä¸Šé”ï¼Œå†åˆ¤æ–­<code>m</code>ä¸­æ˜¯å¦å­˜åœ¨è¯¥<code>key</code>ï¼Œå¦‚æœè¿˜æ˜¯ä¸å­˜åœ¨åˆ™å»<code>dirty</code>ä¸­æŸ¥æ‰¾ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> missLocked() &#123;</span><br><span class="line">    m.misses++</span><br><span class="line">    <span class="keyword">if</span> m.misses &lt; <span class="built_in">len</span>(m.dirty) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// missesè¶…è¿‡dirtyçš„é•¿åº¦ï¼Œåˆ™å°†dirtyæå‡ä¸ºreadï¼Œå¹¶å°†dirtyç½®ä¸ºnil</span></span><br><span class="line">    m.read.Store(&amp;readOnly&#123;m: m.dirty&#125;)</span><br><span class="line">    m.dirty = <span class="literal">nil</span></span><br><span class="line">    m.misses = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><p>å¦‚æœåœ¨<code>read</code>å’Œ<code>dirty</code>éƒ½æ²¡æ‰¾åˆ°ï¼Œåˆ™è¿”å›<code>nil</code>ï¼Œå¦‚æœæ‰¾åˆ°äº†åˆ™è°ƒç”¨<code>load</code>è¿”å›å¯¹åº”çš„å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> load() (value any, ok <span class="type">bool</span>) &#123;</span><br><span class="line">    p := e.p.Load()</span><br><span class="line">    <span class="comment">// ç„¶åpå¤„äºç¡¬åˆ é™¤æˆ–è€…è½¯åˆ é™¤çŠ¶æ€ï¼Œåˆ™è¿”å›nil</span></span><br><span class="line">    <span class="keyword">if</span> p == <span class="literal">nil</span> || p == expunged &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›åœ°å€pæ‰€æŒ‡å‘çš„å€¼</span></span><br><span class="line">    <span class="keyword">return</span> *p, <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-Store"><a href="#4-Store" class="headerlink" title="4 Store"></a>4 Store</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Store(key, value any) &#123;</span><br><span class="line">    _, _ = m.Swap(key, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Store</code>å‡½æ•°æ˜¯é€šè¿‡è°ƒç”¨<code>Swap</code>å‡½æ•°æ¥å®ç°é€»è¾‘åŠŸèƒ½çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Swap(key, value any) (previous any, loaded <span class="type">bool</span>) &#123;</span><br><span class="line">    read := m.loadReadOnly()</span><br><span class="line">    <span class="comment">// å¦‚æœreadä¸­å­˜åœ¨è¯¥keyï¼Œåˆ™å°è¯•è°ƒç”¨trySwapå‡½æ•°ç›´æ¥ä¿®æ”¹</span></span><br><span class="line">    <span class="keyword">if</span> e, ok := read.m[key]; ok &#123;</span><br><span class="line">        <span class="comment">// æ²¡è¢«åˆ é™¤åˆ™ç›´æ¥æ›´æ–°,è¯´æ˜è¿™æ¬¡æ“ä½œå±äºæ›´æ–°è€Œéæ’å…¥</span></span><br><span class="line">        <span class="keyword">if</span> v, ok := e.trySwap(&amp;value); ok &#123;</span><br><span class="line">            <span class="keyword">if</span> v == <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> *v, <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    m.mu.Lock()</span><br><span class="line">    <span class="comment">// double check</span></span><br><span class="line">    read = m.loadReadOnly()</span><br><span class="line">    <span class="keyword">if</span> e, ok := read.m[key]; ok &#123;</span><br><span class="line">        <span class="keyword">if</span> e.unexpungeLocked() &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœp == expungedï¼Œåˆ™å°†readä¸­pçš„çŠ¶æ€æ›´æ–°ä¸ºnilï¼Œç„¶ååœ¨dirtyæ’å…¥è¯¥key</span></span><br><span class="line">            m.dirty[key] = e</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// pä¸ä¸ºnilçš„è¯ï¼Œåˆ™ç›´æ¥æ›´æ–°</span></span><br><span class="line">        <span class="keyword">if</span> v := e.swapLocked(&amp;value); v != <span class="literal">nil</span> &#123;</span><br><span class="line">            loaded = <span class="literal">true</span></span><br><span class="line">            previous = *v</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> e, ok := m.dirty[key]; ok &#123;</span><br><span class="line">        <span class="comment">// readä¸­ä¸å­˜åœ¨è¯¥keyï¼Œä½†æ˜¯dirtyä¸­å­˜åœ¨ï¼Œåˆ™ä¹Ÿæ˜¯ç›´æ¥æ›´æ–°</span></span><br><span class="line">        <span class="keyword">if</span> v := e.swapLocked(&amp;value); v != <span class="literal">nil</span> &#123;</span><br><span class="line">            loaded = <span class="literal">true</span></span><br><span class="line">            previous = *v</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœéƒ½ä¸å­˜åœ¨è¯¥key</span></span><br><span class="line">        <span class="keyword">if</span> !read.amended &#123;</span><br><span class="line">            <span class="comment">// dirtyä¸ºnilï¼Œåˆ™éœ€è¦åˆ›å»ºdirtyï¼Œå¹¶ä»readä¸­æ‹·è´æœªåˆ é™¤çš„å…ƒç´ åˆ°dirtyä¸­</span></span><br><span class="line">            m.dirtyLocked()</span><br><span class="line">            <span class="comment">// å¹¶ä¸”æ›´æ–°amendedå­—æ®µ</span></span><br><span class="line">            m.read.Store(&amp;readOnly&#123;m: read.m, amended: <span class="literal">true</span>&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åœ¨dirtyä¸­å†™å…¥æ–°key</span></span><br><span class="line">        m.dirty[key] = newEntry(value)</span><br><span class="line">    &#125;</span><br><span class="line">    m.mu.Unlock()</span><br><span class="line">    <span class="keyword">return</span> previous, loaded</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> trySwap(i *any) (*any, <span class="type">bool</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        p := e.p.Load()</span><br><span class="line">        <span class="comment">// å¦‚æœpè¢«ç¡¬åˆ é™¤äº†ï¼Œåˆ™ç›´æ¥è¿”å›false</span></span><br><span class="line">        <span class="keyword">if</span> p == expunged &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦åˆ™å°†å…¶å­˜åˆ°entryä¸­</span></span><br><span class="line">        <span class="keyword">if</span> e.p.CompareAndSwap(p, i) &#123;</span><br><span class="line">            <span class="keyword">return</span> p, <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> dirtyLocked() &#123;</span><br><span class="line">    <span class="comment">// dirty ä¸ä¸º nilåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> m.dirty != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    read := m.loadReadOnly()</span><br><span class="line">    m.dirty = <span class="built_in">make</span>(<span class="keyword">map</span>[any]*entry, <span class="built_in">len</span>(read.m))</span><br><span class="line">    <span class="comment">// éå†æœªè¢«åˆ é™¤çš„key</span></span><br><span class="line">    <span class="keyword">for</span> k, e := <span class="keyword">range</span> read.m &#123;</span><br><span class="line">        <span class="keyword">if</span> !e.tryExpungeLocked() &#123;</span><br><span class="line">            m.dirty[k] = e</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="5-Delete"><a href="#5-Delete" class="headerlink" title="5 Delete"></a>5 Delete</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Delete(key any) &#123;</span><br><span class="line">    m.LoadAndDelete(key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>map</code>çš„<code>Delete</code>æ“ä½œéƒ½æ˜¯è°ƒç”¨<code>LoadAndDelete</code>æ¥å®ç°çš„ï¼Œå› æ­¤ç›´æ¥çœ‹å®ƒæ˜¯æ€ä¹ˆå®ç°çš„å³å¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> LoadAndDelete(key any) (value any, loaded <span class="type">bool</span>) &#123;</span><br><span class="line">    read := m.loadReadOnly()</span><br><span class="line">    e, ok := read.m[key]</span><br><span class="line">    <span class="comment">// readä¸­ä¸å­˜åœ¨ï¼Œå¹¶ä¸”dirtyæœ‰readæ²¡æœ‰çš„key</span></span><br><span class="line">    <span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">        <span class="comment">// ä¸Šé”</span></span><br><span class="line">        m.mu.Lock()</span><br><span class="line">        read = m.loadReadOnly()</span><br><span class="line">        e, ok = read.m[key]</span><br><span class="line">        <span class="comment">// double check</span></span><br><span class="line">        <span class="keyword">if</span> !ok &amp;&amp; read.amended &#123;</span><br><span class="line">            <span class="comment">// åœ¨dirtyä¸­æ‰¾åˆ°è¯¥keyï¼Œåˆ™ç›´æ¥åˆ é™¤ï¼Œå¹¶ä¸”è°ƒç”¨missLocked</span></span><br><span class="line">            e, ok = m.dirty[key]</span><br><span class="line">            <span class="built_in">delete</span>(m.dirty, key)</span><br><span class="line">            m.missLocked()</span><br><span class="line">        &#125;</span><br><span class="line">        m.mu.Unlock()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// readä¸­å­˜åœ¨ï¼Œç›´æ¥åˆ é™¤</span></span><br><span class="line">    <span class="keyword">if</span> ok &#123;</span><br><span class="line">        <span class="keyword">return</span> e.<span class="built_in">delete</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// readå’Œdirtyéƒ½ä¸å­˜åœ¨è¯¥keyï¼Œè¿”å›false</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> <span class="built_in">delete</span>() (value any, ok <span class="type">bool</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        p := e.p.Load()</span><br><span class="line">        <span class="comment">// å¦‚æœpä¸ºnilå’Œexpungedåˆ™è¿”å›false</span></span><br><span class="line">        <span class="keyword">if</span> p == <span class="literal">nil</span> || p == expunged &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦è€…å°†å…¶påˆ é™¤ï¼Œç½®ä¸ºnil</span></span><br><span class="line">        <span class="keyword">if</span> e.p.CompareAndSwap(p, <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> *p, <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆè¿™é‡Œåˆ é™¤<code>p</code>çš„æ—¶å€™ä¸æ˜¯ç›´æ¥å°†å…¶ç½®ä¸º<code>expunged</code>è€Œæ˜¯ç½®ä¸º<code>nil</code>å‘¢ï¼Ÿ</p><p>å› ä¸ºåœ¨<code>tryExpungeLocked</code>å‡½æ•°ä¸­ï¼Œä¼šå°†<code>nil</code>è®¾ç½®ä¸º<code>expunged</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *entry)</span></span> tryExpungeLocked() (isExpunged <span class="type">bool</span>) &#123;</span><br><span class="line">    p := e.p.Load()</span><br><span class="line">    <span class="keyword">for</span> p == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// p == nilï¼Œåˆ™å°†å…¶ç½®ä¸ºexpunged</span></span><br><span class="line">        <span class="keyword">if</span> e.p.CompareAndSwap(<span class="literal">nil</span>, expunged) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">        p = e.p.Load()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p == expunged</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°å¦‚æœ key åŒæ—¶å­˜åœ¨äº<code>read</code> å’Œ <code>dirty</code> ä¸­æ—¶ï¼Œåˆ é™¤åªæ˜¯åšäº†ä¸€ä¸ªæ ‡è®°ï¼Œå°†<code>p</code> ç½®ä¸º <code>nil</code>ï¼›è€Œå¦‚æœä»…åœ¨ <code>dirty</code> ä¸­å«æœ‰è¿™ä¸ª <code>key</code> æ—¶ï¼Œä¼šç›´æ¥åˆ é™¤è¿™ä¸ª<code>key</code>ã€‚åŸå› åœ¨äºï¼Œè‹¥ä¸¤è€…éƒ½å­˜åœ¨è¿™ä¸ª <code>key</code>ï¼Œä»…åšæ ‡è®°åˆ é™¤ï¼Œå¯ä»¥åœ¨ä¸‹æ¬¡æŸ¥æ‰¾è¿™ä¸ª<code>key</code> æ—¶ï¼Œå‘½ä¸­ <code>read</code>ï¼Œæå‡æ•ˆç‡ã€‚è‹¥åªæœ‰åœ¨<code>dirty</code> ä¸­å­˜åœ¨æ—¶ï¼Œ<code>read</code> èµ·ä¸åˆ°â€œç¼“å­˜â€çš„ä½œç”¨ï¼Œç›´æ¥åˆ é™¤ã€‚</p><h3 id="6-Range"><a href="#6-Range" class="headerlink" title="6 Range"></a>6 Range</h3><p>ç”±ç”¨æˆ·å®ç°ï¼Œ<code>Range</code>å°†éå†<code>map</code>ä¸­çš„æ‰€æœ‰<code>k-v</code>å¯¹ï¼Œå°†ä»–ä»¬ä¼ ç»™<code>f</code>å‡½æ•°ï¼Œå¦‚æœ<code>f</code>è¿”å›<code>false</code>åˆ™åœæ­¢éå†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Map)</span></span> Range(f <span class="function"><span class="keyword">func</span><span class="params">(key, value any)</span></span> <span class="type">bool</span>) &#123;</span><br><span class="line">    read := m.loadReadOnly()</span><br><span class="line">    <span class="comment">// amendedä¸ºtrue</span></span><br><span class="line">    <span class="keyword">if</span> read.amended &#123;</span><br><span class="line">        m.mu.Lock()</span><br><span class="line">        read = m.loadReadOnly()</span><br><span class="line">        <span class="comment">// double check</span></span><br><span class="line">        <span class="keyword">if</span> read.amended &#123;</span><br><span class="line">            <span class="comment">// å°†dirtyæ‹·è´ç»™read</span></span><br><span class="line">            read = readOnly&#123;m: m.dirty&#125;</span><br><span class="line">            m.read.Store(&amp;read)</span><br><span class="line">            m.dirty = <span class="literal">nil</span></span><br><span class="line">            m.misses = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        m.mu.Unlock()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éå†read</span></span><br><span class="line">    <span class="keyword">for</span> k, e := <span class="keyword">range</span> read.m &#123;</span><br><span class="line">        v, ok := e.load()</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> !f(k, v) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7 æ€»ç»“"></a>7 æ€»ç»“</h3><p>ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°<code>expunge</code>ï¼Ÿ</p><p>å½“<code>key</code>çš„å€¼åœ¨ <code>read</code> ä¸­ä¸º <code>nil</code>ï¼Œéšåç”±å…¶ä»–æ“ä½œè§¦å‘<code>read</code> å‘ <code>dirty</code> å¤åˆ¶ï¼Œ<code>nil</code> è¢«è½¬å˜ä¸º<code>expunge</code>ã€‚æ­¤æ—¶ <code>dirty</code> ä¸ä¸ºç©ºï¼Œä¸”<code>key</code> åœ¨<code>dirty</code> ä¸­ä¸å­˜åœ¨ã€‚</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230913193828380.png" alt="image-20230913193828380" style="zoom:50%;" /></p>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sync.RWMutexæºç å­¦ä¹ </title>
      <link href="/2023/09/08/sync-RWMutex%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/09/08/sync-RWMutex%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç‰¹åˆ«æé†’ï¼Œæœ¬æ–‡æ‰€æ¶‰åŠçš„æºç æ˜¯<code>go1.21.0 darwin/amd64</code><br>æ–‡ä»¶ä½ç½®ï¼šruntime/slice.go</p></blockquote><h3 id="1-æ•°æ®ç»“æ„"><a href="#1-æ•°æ®ç»“æ„" class="headerlink" title="1 æ•°æ®ç»“æ„"></a>1 æ•°æ®ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RWMutex <span class="keyword">struct</span> &#123;</span><br><span class="line">    w           Mutex        <span class="comment">// å†™é”</span></span><br><span class="line">    writerSem   <span class="type">uint32</span>       <span class="comment">// å†™æ“ä½œç­‰å¾…è¯»æ“ä½œå®Œæˆ</span></span><br><span class="line">    readerSem   <span class="type">uint32</span>       <span class="comment">// è¯»æ“ä½œç­‰å¾…å†™æ“ä½œå®Œ</span></span><br><span class="line">    readerCount atomic.Int32 </span><br><span class="line">    readerWait  atomic.Int32 </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> rwmutexMaxReaders = <span class="number">1</span> &lt;&lt; <span class="number">30</span></span><br></pre></td></tr></table></figure><ul><li>readerCountï¼šåœ¨æ²¡æœ‰å†™é”ä»‹å…¥çš„æ—¶å€™ï¼Œè¡¨ç¤ºçš„æ˜¯å½“å‰æ­£åœ¨è¯»æ“ä½œçš„æ•°é‡ã€‚å¦‚æœæœ‰å†™ä»‹å…¥ï¼Œåˆ™<code>readerCount</code>+<code>rwmutexMaxReaders</code>ç­‰äºæ­£åœ¨è¯»æ“ä½œçš„æ•°é‡</li><li>readerWaitï¼šåœ¨èƒ½å¤Ÿè·å–å†™é”å‰ï¼Œè¿˜éœ€è¦ç­‰å¾…å¤šå°‘ä¸ªè¯»åç¨‹é‡Šæ”¾è¯»é”</li></ul><h3 id="2-å†™é”"><a href="#2-å†™é”" class="headerlink" title="2 å†™é”"></a>2 å†™é”</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> Lock() &#123;</span><br><span class="line">    <span class="comment">// é¦–å…ˆä¸å…¶ä»–å†™é”æ“ä½œäº‰Mutex</span></span><br><span class="line">    rw.w.Lock()</span><br><span class="line">    <span class="comment">// ä¸å…¶ä»–å†™æ“ä½œç«äº‰æˆåŠŸ</span></span><br><span class="line">    <span class="comment">// const rwmutexMaxReaders = 1 &lt;&lt; 30</span></span><br><span class="line">    <span class="comment">// readerCountå‡å»rwmutexMaxReadersï¼Œé˜»å¡åé¢çš„è¯»æ“ä½œï¼Œrè¡¨ç¤ºå½“å‰æ­£åœ¨è¿›è¡Œè¯»æ“ä½œçš„æ•°é‡</span></span><br><span class="line">    r := rw.readerCount.Add(-rwmutexMaxReaders) + rwmutexMaxReaders</span><br><span class="line">    <span class="comment">// å‰é¢è¿˜æœ‰è¯»æ“ä½œï¼ŒreaderWait+=rï¼Œå¹¶é˜»å¡æŒ‚èµ·ï¼Œç­‰å¾…å”¤é†’</span></span><br><span class="line">    <span class="keyword">if</span> r != <span class="number">0</span> &amp;&amp; rw.readerWait.Add(r) != <span class="number">0</span> &#123;</span><br><span class="line">        runtime_SemacquireRWMutex(&amp;rw.writerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ºä»€ä¹ˆè·å–å†™é”çš„æ—¶å€™è¦å…ˆå‡å»rwmutexMaxReadersï¼Œé˜»å¡åç»­çš„è¯»æ“ä½œå‘¢ï¼Ÿ</p></blockquote><p>ä¸»è¦æ˜¯é˜²æ­¢åç»­ä¸æ–­çš„è¯»æ“ä½œå¯¼è‡´å†™æ“ä½œè¢«ã€Œé¥¿æ­»ã€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> Unlock() &#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å†™é”</span></span><br><span class="line">    r := rw.readerCount.Add(rwmutexMaxReaders)</span><br><span class="line">    <span class="comment">// å¦‚æœä¹‹å‰å°±æ²¡åŠ è¿‡å†™é”ï¼Œç›´æ¥æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">if</span> r &gt;= rwmutexMaxReaders &#123;</span><br><span class="line">        race.Enable()</span><br><span class="line">        fatal(<span class="string">&quot;sync: Unlock of unlocked RWMutex&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å”¤é†’readerCountä¸ªè¯»æ“ä½œ</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="type">int</span>(r); i++ &#123;</span><br><span class="line">        runtime_Semrelease(&amp;rw.readerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾å†™é”</span></span><br><span class="line">    rw.w.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-è¯»é”"><a href="#3-è¯»é”" class="headerlink" title="3 è¯»é”"></a>3 è¯»é”</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> RLock() &#123;</span><br><span class="line">    <span class="comment">// readerCount+1ï¼Œå¦‚æœå°äº0ï¼Œè¯´æ˜æœ‰å†™é”ï¼Œå› ä¸ºå†™é”ä¼šå‡å»rwmutexMaxReaders</span></span><br><span class="line">    <span class="keyword">if</span> rw.readerCount.Add(<span class="number">1</span>) &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// é˜»å¡æŒ‚èµ·ï¼Œç­‰å¾…å†™é”çš„é‡Šæ”¾</span></span><br><span class="line">        runtime_SemacquireRWMutexR(&amp;rw.readerSem, <span class="literal">false</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> RUnlock() &#123;</span><br><span class="line">    <span class="comment">// readerCount-1ï¼Œå¦‚æœå¤§äºç­‰äº0ç›´æ¥é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> r := rw.readerCount.Add(<span class="number">-1</span>); r &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå°äº0ï¼Œè¯´æ˜å‰é¢æœ‰åç¨‹åœ¨ç­‰å¾…è·å–å†™é”ï¼Œåˆ™ä¼šè¿›å…¥rUnlockSlowæ–¹æ³•ä¸­</span></span><br><span class="line">        rw.rUnlockSlow(r)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> rUnlockSlow(r <span class="type">int32</span>) &#123;</span><br><span class="line">    <span class="comment">// ä¹‹å‰æ²¡æœ‰åŠ è¿‡è¯»é”ï¼Œå› æ­¤é‡Šæ”¾è¯»é”ä¼šç›´æ¥æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">if</span> r+<span class="number">1</span> == <span class="number">0</span> || r+<span class="number">1</span> == -rwmutexMaxReaders &#123;</span><br><span class="line">        race.Enable()</span><br><span class="line">        fatal(<span class="string">&quot;sync: RUnlock of unlocked RWMutex&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// readerWait-1ç­‰äº0ï¼Œè¯´æ˜è¯¥è¯»æ“ä½œæ˜¯æœ€åä¸€ä¸ªè¯»æ“ä½œï¼Œé‡Šæ”¾å®Œå®ƒåï¼Œåº”è¯¥å”¤é†’å†™æ“ä½œ</span></span><br><span class="line">    <span class="keyword">if</span> rw.readerWait.Add(<span class="number">-1</span>) == <span class="number">0</span> &#123;</span><br><span class="line">        runtime_Semrelease(&amp;rw.writerSem, <span class="literal">false</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-Try"><a href="#4-Try" class="headerlink" title="4 Try"></a>4 Try</h3><p><code>rwmutex.go</code>æ–‡ä»¶ä¸­é™¤äº†ä¸Šé¢æåˆ°çš„å‡½æ•°ï¼Œè¿˜æœ‰ä¸¤ä¸ª<code>Try</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°åªåœ¨ç‰¹å®šåœºæ™¯ä¸‹ä½¿ç”¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> TryRLock() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        c := rw.readerCount.Load()</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰å†™æ“ä½œæ­£åœ¨æ‰§è¡Œï¼Œåˆ™è¿”å›false</span></span><br><span class="line">        <span class="keyword">if</span> c &lt; <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// åŒé‡æ ¡éªŒï¼Œå†æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦ä¸­é—´çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å…¶ä»–åç¨‹ä»‹å…¥ï¼Œæ²¡æœ‰åˆ™è¿”å›true</span></span><br><span class="line">        <span class="comment">// å¦åˆ™ç»§ç»­å¾ªç¯</span></span><br><span class="line">        <span class="keyword">if</span> rw.readerCount.CompareAndSwap(c, c+<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rw *RWMutex)</span></span> TryLock() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•è·å–å†™é”å¤±è´¥ï¼Œåˆ™è¿”å›false</span></span><br><span class="line">    <span class="keyword">if</span> !rw.w.TryLock() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰è¯»æ“ä½œåœ¨è¿›è¡Œï¼Œæœ‰åˆ™è¿”å›falseï¼Œå¹¶é‡Šæ”¾å†™é”</span></span><br><span class="line">    <span class="keyword">if</span> !rw.readerCount.CompareAndSwap(<span class="number">0</span>, -rwmutexMaxReaders) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾å†™é”</span></span><br><span class="line">        rw.w.Unlock()</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sync.Mutexæºç å­¦ä¹ </title>
      <link href="/2023/09/06/sync-Mutex%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/09/06/sync-Mutex%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç‰¹åˆ«æé†’ï¼Œæœ¬æ–‡æ‰€æ¶‰åŠçš„æºç æ˜¯<code>go1.21.0 darwin/amd64</code></p><p>æ–‡ä»¶ä½ç½®ï¼šsync/mutex.go</p><p>æ–‡ç« æ‰€æ¶‰åŠçš„goæ±‡ç¼–ä»£ç éƒ½æ˜¯ä»¥_amd64ç»“å°¾çš„æ–‡ä»¶</p></blockquote><h3 id="1-å‰æœŸçŸ¥è¯†"><a href="#1-å‰æœŸçŸ¥è¯†" class="headerlink" title="1 å‰æœŸçŸ¥è¯†"></a>1 å‰æœŸçŸ¥è¯†</h3><h4 id="1-1-é˜»å¡é”"><a href="#1-1-é˜»å¡é”" class="headerlink" title="1.1 é˜»å¡é”"></a>1.1 é˜»å¡é”</h4><p>å°†å½“å‰åç¨‹é˜»å¡æŒ‚èµ·ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾åï¼Œä»¥å›è°ƒçš„æ–¹å¼å°†é˜»å¡åç¨‹é‡æ–°å”¤é†’ï¼Œè¿›è¡Œé”äº‰å¤º</p><h4 id="1-2-è‡ªæ—‹é”"><a href="#1-2-è‡ªæ—‹é”" class="headerlink" title="1.2 è‡ªæ—‹é”"></a>1.2 è‡ªæ—‹é”</h4><p>ç»“åˆ<code>CAS</code>ï¼Œé‡å¤æ ¡éªŒé”çš„çŠ¶æ€å¹¶å°è¯•è·å–é”ï¼Œå§‹ç»ˆå ç”¨<code>cpu</code></p><h4 id="1-3-å¯¹æ¯”"><a href="#1-3-å¯¹æ¯”" class="headerlink" title="1.3 å¯¹æ¯”"></a>1.3 å¯¹æ¯”</h4><div class="table-container"><table><thead><tr><th></th><th>ä¼˜åŠ¿</th><th>åŠ£åŠ¿</th></tr></thead><tbody><tr><td>é˜»å¡/å”¤é†’</td><td>ä¸å ç”¨cpuæ—¶é—´ç‰‡</td><td>éœ€è¦ä¸Šä¸‹æ–‡åˆ‡æ¢</td></tr><tr><td>è‡ªæ—‹</td><td>ä¸ä¼šé˜»å¡å½“å‰åç¨‹</td><td>å ç”¨cpuæ—¶é—´ç‰‡</td></tr></tbody></table></div><h3 id="2-æ•°æ®ç»“æ„"><a href="#2-æ•°æ®ç»“æ„" class="headerlink" title="2 æ•°æ®ç»“æ„"></a>2 æ•°æ®ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Mutex <span class="keyword">struct</span> &#123;</span><br><span class="line">    state <span class="type">int32</span></span><br><span class="line">    sema  <span class="type">uint32</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>stateï¼šçŠ¶æ€è¡¨ç¤ºï¼Œç¬¬1ä½è¡¨ç¤ºæ˜¯å¦ä¸Šé”ï¼Œç¬¬2ä½è¡¨ç¤º<code>mutex</code>æ˜¯å¦è¢«å”¤é†’ï¼Œç¬¬3ä½è¡¨ç¤º<code>mutex</code>æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼</li><li>semaï¼šæ§åˆ¶é”çŠ¶æ€çš„ä¿¡å·é‡</li></ul><h3 id="3-ä¸Šé”"><a href="#3-ä¸Šé”" class="headerlink" title="3 ä¸Šé”"></a>3 ä¸Šé”</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Lock() &#123;</span><br><span class="line">    <span class="comment">// åˆæ¬¡å°è¯•ï¼Œstateä¸º0åˆ™ç›´æ¥æŠ¢é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, <span class="number">0</span>, mutexLocked) &#123;</span><br><span class="line">        <span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">            race.Acquire(unsafe.Pointer(m))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¿«é€ŸæŠ¢é”å¤±è´¥ï¼Œåˆ™è¿›å…¥loclSlowæ…¢é€ŸæŠ¢é”</span></span><br><span class="line">    m.lockSlow()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦ä¸Šé”é€»è¾‘è¿˜æ˜¯åœ¨<code>lockSlow()</code>å‡½æ•°ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> lockSlow() &#123;</span><br><span class="line">    <span class="keyword">var</span> waitStartTime <span class="type">int64</span><span class="comment">// æŠ¢é”æ‰€ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">    starving := <span class="literal">false</span><span class="comment">// æ˜¯å¦å¤„äºé¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">    awoke := <span class="literal">false</span><span class="comment">// æ˜¯å¦å·²æœ‰åç¨‹åœ¨ç­‰å¾…é”</span></span><br><span class="line">    iter := <span class="number">0</span><span class="comment">// è‡ªæ—‹æ¬¡æ•°</span></span><br><span class="line">    old := m.state<span class="comment">// é”çš„state</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸å¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œå·²ç»è¢«ä¸Šé”ï¼Œå¹¶ä¸”æ»¡è¶³è‡ªæ—‹æ¡ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == mutexLocked &amp;&amp; runtime_canSpin(iter) &#123;</span><br><span class="line">            <span class="comment">// å°†mutexWokenç½®ä¸º1ï¼Œè¡¨æ˜è‡ªå·±æ­£åœ¨è‡ªæ—‹ï¼Œå…ˆä¸å”¤é†’å…¶ä»–é˜»å¡çš„åç¨‹ï¼ˆå¦åˆ™è‡ªæ—‹æ— æ„ä¹‰ï¼‰</span></span><br><span class="line">            <span class="keyword">if</span> !awoke &amp;&amp; old&amp;mutexWoken == <span class="number">0</span> &amp;&amp; old&gt;&gt;mutexWaiterShift != <span class="number">0</span> &amp;&amp;</span><br><span class="line">                atomic.CompareAndSwapInt32(&amp;m.state, old, old|mutexWoken) &#123;</span><br><span class="line">                awoke = <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è‡ªæ—‹è°ƒç”¨ç›¸å…³å‡½æ•°</span></span><br><span class="line">            runtime_doSpin()</span><br><span class="line">            <span class="comment">// è‡ªæ—‹æ¬¡æ•°+1</span></span><br><span class="line">            iter++</span><br><span class="line">            old = m.state</span><br><span class="line">            <span class="comment">// ç»§ç»­è‡ªæ—‹</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­çš„<code>CompareAndSwapInt32</code>æ˜¯ä¸€ç§åŸå­æ“ä½œï¼Œæ±‡ç¼–å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯¥æ–‡ä»¶åœ¨runtime/atomic_amd64.s</span></span><br><span class="line"><span class="comment">// bool Cas(int32 *val, int32 old, int32 new)</span></span><br><span class="line"><span class="comment">// Atomically:</span></span><br><span class="line"><span class="comment">//if(*val == old)&#123;</span></span><br><span class="line"><span class="comment">//*val = new;</span></span><br><span class="line"><span class="comment">//return 1;</span></span><br><span class="line"><span class="comment">//&#125; else</span></span><br><span class="line"><span class="comment">//return 0;</span></span><br><span class="line">TEXT Â·Cas(SB),NOSPLIT,$<span class="number">0</span><span class="number">-17</span></span><br><span class="line">    MOVQptr+<span class="number">0</span>(FP), BX</span><br><span class="line">    MOVLold+<span class="number">8</span>(FP), AX</span><br><span class="line">    MOVL<span class="built_in">new</span>+<span class="number">12</span>(FP), CX</span><br><span class="line">    LOCK</span><br><span class="line">    CMPXCHGLCX, <span class="number">0</span>(BX)</span><br><span class="line">    SETEQret+<span class="number">16</span>(FP)</span><br><span class="line">    RET</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­çš„é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯<code>*val</code>è·Ÿ<code>old</code>ç›¸ç­‰ï¼Œåˆ™å°†<code>*val</code>æ›´æ–°ä¸º<code>new</code>å¹¶ä¸”è¿”å›<code>true</code>ï¼Œå¦åˆ™è¿”å›<code>false</code></p><p>åˆ¤æ–­æ˜¯å¦å¯ä»¥è‡ªæ—‹çš„é€»è¾‘åœ¨<code>runtime/proc.go</code>æ–‡ä»¶ä¸­çš„<code>sync_runtime_canSpin</code>å‡½æ•°ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:linkname sync_runtime_canSpin sync.runtime_canSpin</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sync_runtime_canSpin</span><span class="params">(i <span class="type">int</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="comment">// active_spin=4 </span></span><br><span class="line">    <span class="keyword">if</span> i &gt;= active_spin || ncpu &lt;= <span class="number">1</span> || gomaxprocs &lt;= sched.npidle.Load()+sched.nmspinning.Load()+<span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> p := getg().m.p.ptr(); !runqempty(p) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è‡ªæ—‹æ¬¡æ•°<code>iter</code>å¤§äºç­‰äº<code>4</code></li><li><p><code>cpu</code>æ ¸æ•°å°äºç­‰äº1</p></li><li><p>å½“å‰<code>P</code>çš„æ‰§è¡Œé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…æ‰§è¡Œçš„<code>g</code></p></li></ul><p>æ»¡è¶³ä¸Šè¿°ä¸‰ç§æ¡ä»¶ä¹‹ä¸€ï¼Œåˆ™ä¸æ»¡è¶³è‡ªæ—‹æ¡ä»¶ï¼Œä¸èƒ½è¿›å…¥è‡ªæ—‹çŠ¶æ€</p><p><code>runtime_doSpin</code>çš„ç›¸å…³å®ç°ä¹Ÿåœ¨<code>runtime/proc.go</code>ä¸‹çš„<code>sync_runtime_doSpin</code>ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:linkname sync_runtime_doSpin sync.runtime_doSpin</span></span><br><span class="line"><span class="comment">//go:nosplit</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">sync_runtime_doSpin</span><span class="params">()</span></span> &#123;</span><br><span class="line">    procyield(active_spin_cnt)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// procyieldæ˜¯ç”¨æ±‡ç¼–å®ç°çš„ï¼Œæ–‡ä»¶åœ¨runtime/asm_amd64.s</span></span><br><span class="line"><span class="comment">// å…¶ä¸­AXçš„å€¼æ˜¯active_spin_cntï¼Œå¹¶ä¸”active_spin_cnt=30</span></span><br><span class="line">TEXT runtimeÂ·procyield(SB),NOSPLIT,$<span class="number">0</span><span class="number">-0</span></span><br><span class="line">    MOVLcycles+<span class="number">0</span>(FP), AX</span><br><span class="line">again:</span><br><span class="line">    PAUSE</span><br><span class="line">    SUBL$<span class="number">1</span>, AX</span><br><span class="line">    JNZagain</span><br><span class="line">    RET</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ±‡ç¼–ä»£ç å¯ä»¥çœ‹å‡ºï¼Œ<code>procyield</code>å‡½æ•°ä¼šæ‰§è¡Œ30æ¬¡çš„<code>PAUSE</code>æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤ä¼šå ç”¨<code>CPU</code>å¹¶æ¶ˆè€—<code>CPU</code>æ—¶é—´ã€‚</p><hr><p>ç°åœ¨å›åˆ°<code>lockSlow</code>ï¼Œç»§ç»­çœ‹å‰©ä½™çš„å¤„ç†é€»è¾‘ï¼Œæ­¤æ—¶ä¸èƒ½å†è¿›è¡Œè‡ªæ—‹æ“ä½œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤åˆ¶å½“å‰çš„stateçŠ¶æ€ï¼Œç”¨æ¥è®¾ç½®mutexçš„æ–°çŠ¶æ€</span></span><br><span class="line"><span class="built_in">new</span> := old</span><br><span class="line"><span class="comment">// old stateéé¥¥é¥¿æ¨¡å¼</span></span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰åç¨‹æŠ¢é”æˆåŠŸæˆ–è€…å·²ç»æ˜¯ä¸Šé”çŠ¶æ€çš„ï¼Œnew stateéƒ½åº”è¯¥åŠ é”</span></span><br><span class="line"><span class="keyword">if</span> old&amp;mutexStarving == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">new</span> |= mutexLocked</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// old stateå¤„äºåŠ é”çŠ¶æ€æˆ–è€…é¥¥é¥¿çŠ¶æ€ï¼Œå½“å‰åç¨‹éƒ½ä¼šè¢«é˜»å¡ï¼Œåˆ™ç­‰å¾…æ•°é‡+1</span></span><br><span class="line"><span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">new</span> += <span class="number">1</span> &lt;&lt; mutexWaiterShift</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// old stateå·²ç»ä¸Šé”ï¼ˆè¡¨æ˜å½“å‰åç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå¹¶ä¸”å¤„äºé¥¥é¥¿çŠ¶æ€ï¼Œåˆ™å°†new stateæ ‡è®°é¥¥é¥¿æ¨¡å¼</span></span><br><span class="line"><span class="keyword">if</span> starving &amp;&amp; old&amp;mutexLocked != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="built_in">new</span> |= mutexStarving</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å½“å‰åç¨‹è¢«å”¤é†’ï¼Œä¸ç®¡æ˜¯æ‹¿åˆ°é”äº†ï¼Œè¿˜æ˜¯å°†è¦è¿›å…¥é˜»å¡é˜Ÿåˆ—äº†ï¼Œéƒ½åº”è¯¥å–æ¶ˆmutexWokenæ ‡è®°</span></span><br><span class="line"><span class="keyword">if</span> awoke &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexWoken == <span class="number">0</span> &#123;</span><br><span class="line">        throw(<span class="string">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">new</span> &amp;^= mutexWoken</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‰©ä½™ä»£ç é€»è¾‘é€šè¿‡<code>CAS</code>æ¥å°è¯•è®¾ç½®é”çš„çŠ¶æ€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</span><br><span class="line">    <span class="comment">// old stateå¹¶æ²¡æœ‰ä¸Šé”ï¼Œä¹Ÿä¸æ˜¯é¥¥é¥¿çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> old&amp;(mutexLocked|mutexStarving) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// å½“å‰åç¨‹ä¸Šé”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">break</span> </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»ç­‰å¾…è¿‡äº†ï¼Œè¯´æ˜æ˜¯ä»é˜»å¡é˜Ÿåˆ—è¢«å”¤é†’çš„åç¨‹ï¼Œå› ä¸ºæ­¤æ¬¡ä¸Šé”å¤±è´¥ï¼Œæ”¾å›é˜Ÿåˆ—å¤´éƒ¨</span></span><br><span class="line">    queueLifo := waitStartTime != <span class="number">0</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯æ–°æ¥æŠ¢é”çš„ï¼Œåˆ™åˆå§‹åŒ–ç­‰å¾…æ—¶é—´ï¼Œå¹¶ä¸”æ”¾åˆ°é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">    <span class="keyword">if</span> waitStartTime == <span class="number">0</span> &#123;</span><br><span class="line">        waitStartTime = runtime_nanotime()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šè¿‡ä¿¡å·é‡æ¥æ’é˜Ÿè·å–é”ï¼Œé€šè¿‡sleepåŸè¯­é˜»å¡å½“å‰åç¨‹</span></span><br><span class="line">    runtime_SemacquireMutex(&amp;m.sema, queueLifo, <span class="number">1</span>)</span><br><span class="line">    <span class="comment">// sleepç»“æŸï¼Œè¢«å”¤é†’</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰åç¨‹ç­‰å¾…æ—¶é—´è¶…è¿‡1msï¼Œåˆ™è¿›å…¥é¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">    starving = starving || runtime_nanotime()-waitStartTime &gt; starvationThresholdNs</span><br><span class="line">    <span class="comment">// è·å–é”ç›®å‰çŠ¶æ€ï¼ˆå¯èƒ½è¢«å…¶ä»–åç¨‹ä¿®æ”¹è¿‡ï¼‰</span></span><br><span class="line">    old = m.state</span><br><span class="line">    <span class="comment">// å¦‚æœé”æ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œåˆ™é”åº”è¯¥æ˜¯è¢«é‡Šæ”¾çš„çŠ¶æ€ï¼Œå½“å‰åç¨‹æ˜¯è¢«ä¿¡å·é‡å”¤é†’çš„ï¼Œé‚£ä¹ˆé”åº”è¯¥ç›´æ¥äº¤ç»™å½“å‰åç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> old&amp;mutexStarving != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰é”æ˜¯ä¸Šé”çš„æˆ–è€…æœ‰åç¨‹åœ¨å”¤é†’çŠ¶æ€ï¼Œæˆ–è€…é˜»å¡é˜Ÿåˆ—ä¸ºç©ºï¼Œè¿™ä¸ä¸Šé¢æ¡ä»¶å†²çªï¼Œæ˜¯éæ³•çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// å› ä¸ºé¥¥é¥¿æ¨¡å¼ä¸‹ï¼Œé”åº”è¯¥æ˜¯äº¤ç»™é˜»å¡é˜Ÿåˆ—çš„å¤´éƒ¨çš„åç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> old&amp;(mutexLocked|mutexWoken) != <span class="number">0</span> || old&gt;&gt;mutexWaiterShift == <span class="number">0</span> &#123;</span><br><span class="line">            throw(<span class="string">&quot;sync: inconsistent mutex state&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“å‰åç¨‹è·å¾—é”ï¼Œç­‰å¾…é˜Ÿåˆ—-1</span></span><br><span class="line">        delta := <span class="type">int32</span>(mutexLocked - <span class="number">1</span>&lt;&lt;mutexWaiterShift)</span><br><span class="line">        <span class="comment">// å¦‚æœåªå‰©ä¸€ä¸ªç­‰å¾…è€…äº†ï¼Œåˆ™é€€å‡ºé¥¥é¥¿æ¨¡å¼</span></span><br><span class="line">        <span class="keyword">if</span> !starving || old&gt;&gt;mutexWaiterShift == <span class="number">1</span> &#123;</span><br><span class="line">            delta -= mutexStarving</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ›´æ–°mutexçŠ¶æ€ï¼Œä¸»è¦æ˜¯å‡å»ç­‰å¾…è€…æˆ–è€…é€€å‡ºé¥¥é¥¿æ¨¡å¼ï¼Œå¹¶åŠ ä¸Šä¸Šé”çŠ¶æ€</span></span><br><span class="line">        atomic.AddInt32(&amp;m.state, delta)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœé”ä¸æ˜¯é¥¥é¥¿æ¨¡å¼ï¼Œå”¤é†’å½“å‰åç¨‹ï¼Œé‡ç½®è‡ªæ—‹æ¬¡æ•°</span></span><br><span class="line">    awoke = <span class="literal">true</span></span><br><span class="line">    iter = <span class="number">0</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// CASå¤±è´¥ï¼Œé‡æ–°å°è¯•è·å–é”</span></span><br><span class="line">    old = m.state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æ¥çœ‹çœ‹ä¸Šé¢æåˆ°çš„<code>runtime_SemacquireMutex</code>å‡½æ•°ï¼Œé¦–å…ˆæ˜¯è°ƒç”¨<code>runtime/sema.go/poll_runtime_Semacquire</code>å‡½æ•°ï¼Œæ¥ç€å®ƒåˆè°ƒç”¨<code>semacquire1</code>å‡½æ•°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//go:linkname poll_runtime_Semacquire internal/poll.runtime_Semacquire</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">poll_runtime_Semacquire</span><span class="params">(addr *<span class="type">uint32</span>)</span></span> &#123;</span><br><span class="line">    semacquire1(addr, <span class="literal">false</span>, semaBlockProfile, <span class="number">0</span>, waitReasonSemacquire)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">semacquire1</span><span class="params">(addr *<span class="type">uint32</span>, lifo <span class="type">bool</span>, profile semaProfileFlags, skipframes <span class="type">int</span>, reason waitReason)</span></span> &#123;</span><br><span class="line">    gp := getg()</span><br><span class="line">    <span class="keyword">if</span> gp != gp.m.curg &#123;</span><br><span class="line">        throw(<span class="string">&quot;semacquire not on the G stack&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŠ¢å åˆ°ä¿¡å·é‡ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> cansemacquire(addr) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æŠ¢åˆ°ä¿¡å·é‡:</span></span><br><span class="line">    <span class="comment">//ç­‰å¾…è€…+1</span></span><br><span class="line">    <span class="comment">//ç»§ç»­å°è¯•æŠ¢ä¿¡å·é‡ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›</span></span><br><span class="line">    <span class="comment">//å°†è‡ªå·±å…¥é˜Ÿ</span></span><br><span class="line">    <span class="comment">//sleep</span></span><br><span class="line">    <span class="comment">//(waiter descriptor is dequeued by signaler)</span></span><br><span class="line">    s := acquireSudog()</span><br><span class="line">    root := semtable.rootFor(addr)</span><br><span class="line">    t0 := <span class="type">int64</span>(<span class="number">0</span>)</span><br><span class="line">    s.releasetime = <span class="number">0</span></span><br><span class="line">    s.acquiretime = <span class="number">0</span></span><br><span class="line">    s.ticket = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> profile&amp;semaBlockProfile != <span class="number">0</span> &amp;&amp; blockprofilerate &gt; <span class="number">0</span> &#123;</span><br><span class="line">        t0 = cputicks()</span><br><span class="line">        s.releasetime = <span class="number">-1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> profile&amp;semaMutexProfile != <span class="number">0</span> &amp;&amp; mutexprofilerate &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> t0 == <span class="number">0</span> &#123;</span><br><span class="line">            t0 = cputicks()</span><br><span class="line">        &#125;</span><br><span class="line">        s.acquiretime = t0</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// åŠ é”</span></span><br><span class="line">        lockWithRank(&amp;root.lock, lockRankRoot)</span><br><span class="line">        <span class="comment">// å½“å‰ç­‰å¾…æ•°é‡+1</span></span><br><span class="line">        root.nwait.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="comment">// å°è¯•è·å–ä¿¡å·é‡</span></span><br><span class="line">        <span class="keyword">if</span> cansemacquire(addr) &#123;</span><br><span class="line">            root.nwait.Add(<span class="number">-1</span>)</span><br><span class="line">            unlock(&amp;root.lock)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…¥é˜Ÿ</span></span><br><span class="line">        root.queue(addr, s, lifo)</span><br><span class="line">        <span class="comment">// å½“å‰åç¨‹ç­‰å¾…ï¼Œè®©è°ƒåº¦èµ·è°ƒç”¨å…¶ä»–çš„åç¨‹</span></span><br><span class="line">        goparkunlock(&amp;root.lock, reason, traceBlockSync, <span class="number">4</span>+skipframes)</span><br><span class="line">        <span class="keyword">if</span> s.ticket != <span class="number">0</span> || cansemacquire(addr) &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> s.releasetime &gt; <span class="number">0</span> &#123;</span><br><span class="line">        blockevent(s.releasetime-t0, <span class="number">3</span>+skipframes)</span><br><span class="line">    &#125;</span><br><span class="line">    releaseSudog(s)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>runtime_SemacquireMutex</code>å‡½æ•°çš„ä½œç”¨å°±æ˜¯ä½¿ç”¨ä½¿ç”¨ä¿¡å·é‡ä¿è¯èµ„æºä¸ä¼šè¢«ä¸¤ä¸ªåç¨‹è·å–</p><h3 id="4-è§£é”"><a href="#4-è§£é”" class="headerlink" title="4 è§£é”"></a>4 è§£é”</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> Unlock() &#123;</span><br><span class="line">    <span class="keyword">if</span> race.Enabled &#123;</span><br><span class="line">        _ = m.state</span><br><span class="line">        race.Release(unsafe.Pointer(m))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¿«é€Ÿè§£é”</span></span><br><span class="line">    <span class="built_in">new</span> := atomic.AddInt32(&amp;m.state, -mutexLocked)</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">new</span> != <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸ç­‰äº0ï¼Œä»£è¡¨å¿«é€Ÿè§£é”å¤±è´¥ï¼Œå¼€å§‹æ…¢é€Ÿè§£é”</span></span><br><span class="line">        m.unlockSlow(<span class="built_in">new</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Mutex)</span></span> unlockSlow(<span class="built_in">new</span> <span class="type">int32</span>) &#123;</span><br><span class="line">    <span class="comment">// å·²ç»è¢«è§£é”ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">new</span>+mutexLocked)&amp;mutexLocked == <span class="number">0</span> &#123;</span><br><span class="line">        fatal(<span class="string">&quot;sync: unlock of unlocked mutex&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­£å¸¸æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">new</span>&amp;mutexStarving == <span class="number">0</span> &#123;</span><br><span class="line">        old := <span class="built_in">new</span></span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            <span class="comment">// æ²¡æœ‰é˜»å¡çš„åç¨‹ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="comment">// æœ‰é˜»å¡çš„åç¨‹ä½†æ˜¯ä»å¤„äºmutexWokenæˆ–è€…å·²ç»è¢«ä¸Šé”æˆ–è€…å¤„äºé¥¥é¥¿æ¨¡å¼ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> old&gt;&gt;mutexWaiterShift == <span class="number">0</span> || old&amp;(mutexLocked|mutexWoken|mutexStarving) != <span class="number">0</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å”¤é†’ä¸€ä¸ªåç¨‹ï¼Œé˜»å¡æ•°é‡å‡1ï¼Œå¹¶å°†mutexWokenç½®ä¸ºtrue</span></span><br><span class="line">            <span class="built_in">new</span> = (old - <span class="number">1</span>&lt;&lt;mutexWaiterShift) | mutexWoken</span><br><span class="line">            <span class="keyword">if</span> atomic.CompareAndSwapInt32(&amp;m.state, old, <span class="built_in">new</span>) &#123;</span><br><span class="line">                runtime_Semrelease(&amp;m.sema, <span class="literal">false</span>, <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            old = m.state</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// é¥¥é¥¿æ¨¡å¼ï¼Œç›´æ¥å°†é”äº¤ç»™ä¸‹ä¸€ä¸ªç­‰å¾…è€…</span></span><br><span class="line">        runtime_Semrelease(&amp;m.sema, <span class="literal">true</span>, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>sliceæºç å­¦ä¹ </title>
      <link href="/2023/09/01/slice%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/09/01/slice%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç‰¹åˆ«æé†’ï¼Œæœ¬æ–‡æ‰€æ¶‰åŠçš„æºç æ˜¯<code>go1.21.0 darwin/amd64</code><br>æ–‡ä»¶ä½ç½®ï¼šruntime/slice.go</p></blockquote><h3 id="1-æ•°æ®ç»“æ„"><a href="#1-æ•°æ®ç»“æ„" class="headerlink" title="1 æ•°æ®ç»“æ„"></a>1 æ•°æ®ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">    array unsafe.Pointer</span><br><span class="line">    <span class="built_in">len</span>   <span class="type">int</span></span><br><span class="line">    <span class="built_in">cap</span>   <span class="type">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>arrayï¼šæŒ‡å‘å­˜å‚¨å…ƒç´ å†…å­˜ç©ºé—´çš„èµ·å§‹åœ°ç‚¹</li><li>lenï¼šåˆ‡ç‰‡çš„é•¿åº¦</li><li>capï¼šåˆ‡ç‰‡çš„å®¹é‡</li></ul><h3 id="2-åˆå§‹åŒ–"><a href="#2-åˆå§‹åŒ–" class="headerlink" title="2 åˆå§‹åŒ–"></a>2 åˆå§‹åŒ–</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeslice</span><span class="params">(et *_type, <span class="built_in">len</span>, <span class="built_in">cap</span> <span class="type">int</span>)</span></span> unsafe.Pointer &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­åˆ†é…çš„å†…å­˜æ˜¯å¦ä¼šæº¢å‡º</span></span><br><span class="line">    mem, overflow := math.MulUintptr(et.Size_, <span class="type">uintptr</span>(<span class="built_in">cap</span>))</span><br><span class="line">    <span class="keyword">if</span> overflow || mem &gt; maxAlloc || <span class="built_in">len</span> &lt; <span class="number">0</span> || <span class="built_in">len</span> &gt; <span class="built_in">cap</span> &#123;</span><br><span class="line">        mem, overflow := math.MulUintptr(et.Size_, <span class="type">uintptr</span>(<span class="built_in">len</span>))</span><br><span class="line">        <span class="keyword">if</span> overflow || mem &gt; maxAlloc || <span class="built_in">len</span> &lt; <span class="number">0</span> &#123;</span><br><span class="line">            panicmakeslicelen()</span><br><span class="line">        &#125;</span><br><span class="line">        panicmakeslicecap()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ†é…å†…å­˜</span></span><br><span class="line">    <span class="keyword">return</span> mallocgc(mem, et, <span class="literal">true</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-æ‰©å®¹"><a href="#3-æ‰©å®¹" class="headerlink" title="3 æ‰©å®¹"></a>3 æ‰©å®¹</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">growslice</span><span class="params">(oldPtr unsafe.Pointer, newLen, oldCap, num <span class="type">int</span>, et *_type)</span></span> slice &#123;</span><br><span class="line">    <span class="comment">// æ—§åˆ‡ç‰‡çš„é•¿åº¦</span></span><br><span class="line">    oldLen := newLen - num</span><br><span class="line">    <span class="keyword">if</span> newLen &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(errorString(<span class="string">&quot;growslice: len out of range&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å…ƒç´ å¤§å°ä¸º0ï¼Œåˆ™ç›´æ¥åˆ†é…</span></span><br><span class="line">    <span class="keyword">if</span> et.Size_ == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// append should not create a slice with nil pointer but non-zero len.</span></span><br><span class="line">        <span class="comment">// We assume that append doesn&#x27;t need to preserve oldPtr in this case.</span></span><br><span class="line">        <span class="keyword">return</span> slice&#123;unsafe.Pointer(&amp;zerobase), newLen, newLen&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ–°åˆ‡ç‰‡çš„å®¹é‡å¤§å°</span></span><br><span class="line">    newcap := oldCap</span><br><span class="line">    doublecap := newcap + newcap</span><br><span class="line">    <span class="comment">// å¦‚æœæ–°åˆ‡ç‰‡çš„é•¿åº¦å¤§äºæ—§åˆ‡ç‰‡å®¹é‡çš„ä¸¤å€ï¼Œåˆ™å°†æ–°åˆ‡ç‰‡çš„é•¿åº¦èµ‹å€¼ç»™å®¹é‡</span></span><br><span class="line">    <span class="keyword">if</span> newLen &gt; doublecap &#123;</span><br><span class="line">        newcap = newLen</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> threshold = <span class="number">256</span></span><br><span class="line">        <span class="comment">// æ—§åˆ‡ç‰‡çš„å®¹é‡å°äº256</span></span><br><span class="line">        <span class="keyword">if</span> oldCap &lt; threshold &#123;</span><br><span class="line">            <span class="comment">// ä¸¤å€æ‰©å®¹</span></span><br><span class="line">            newcap = doublecap</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¸€ç›´å¢åŠ ï¼Œç›´åˆ°å¤§äºåˆ‡ç‰‡çš„é•¿åº¦</span></span><br><span class="line">            <span class="keyword">for</span> <span class="number">0</span> &lt; newcap &amp;&amp; newcap &lt; newLen &#123;</span><br><span class="line">                <span class="comment">// æ‰©å®¹é€Ÿåº¦ä¸º1/4çš„åŸæ¥å®¹é‡+å›ºå®šå€¼192</span></span><br><span class="line">                newcap += (newcap + <span class="number">3</span>*threshold) / <span class="number">4</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è¶…è¿‡int32ç±»å‹å¤§å°ï¼Œåˆ™å°†é•¿åº¦èµ‹å€¼ç»™å®¹é‡</span></span><br><span class="line">            <span class="keyword">if</span> newcap &lt;= <span class="number">0</span> &#123;</span><br><span class="line">                newcap = newLen</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> overflow <span class="type">bool</span></span><br><span class="line">    <span class="keyword">var</span> lenmem, newlenmem, capmem <span class="type">uintptr</span></span><br><span class="line">    <span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> et.Size_ == <span class="number">1</span>:<span class="comment">// å…ƒç´ å¤§å°ä¸º1</span></span><br><span class="line">        lenmem = <span class="type">uintptr</span>(oldLen)</span><br><span class="line">        newlenmem = <span class="type">uintptr</span>(newLen)</span><br><span class="line">        capmem = roundupsize(<span class="type">uintptr</span>(newcap))</span><br><span class="line">        overflow = <span class="type">uintptr</span>(newcap) &gt; maxAlloc</span><br><span class="line">        newcap = <span class="type">int</span>(capmem)</span><br><span class="line">    <span class="keyword">case</span> et.Size_ == goarch.PtrSize:<span class="comment">// å…ƒç´ æ˜¯æŒ‡é’ˆç±»å‹</span></span><br><span class="line">        lenmem = <span class="type">uintptr</span>(oldLen) * goarch.PtrSize</span><br><span class="line">        newlenmem = <span class="type">uintptr</span>(newLen) * goarch.PtrSize</span><br><span class="line">        capmem = roundupsize(<span class="type">uintptr</span>(newcap) * goarch.PtrSize)</span><br><span class="line">        overflow = <span class="type">uintptr</span>(newcap) &gt; maxAlloc/goarch.PtrSize</span><br><span class="line">        newcap = <span class="type">int</span>(capmem / goarch.PtrSize)</span><br><span class="line">    <span class="keyword">case</span> isPowerOfTwo(et.Size_):<span class="comment">// å…ƒç´ å¤§å°æ˜¯2çš„å¹‚</span></span><br><span class="line">        <span class="keyword">var</span> shift <span class="type">uintptr</span></span><br><span class="line">        <span class="keyword">if</span> goarch.PtrSize == <span class="number">8</span> &#123;</span><br><span class="line">            shift = <span class="type">uintptr</span>(sys.TrailingZeros64(<span class="type">uint64</span>(et.Size_))) &amp; <span class="number">63</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            shift = <span class="type">uintptr</span>(sys.TrailingZeros32(<span class="type">uint32</span>(et.Size_))) &amp; <span class="number">31</span></span><br><span class="line">        &#125;<span class="comment">// é€šè¿‡ç§»ä½æ“ä½œï¼Œæ€§èƒ½æ›´é«˜æ•ˆ</span></span><br><span class="line">        lenmem = <span class="type">uintptr</span>(oldLen) &lt;&lt; shift</span><br><span class="line">        newlenmem = <span class="type">uintptr</span>(newLen) &lt;&lt; shift</span><br><span class="line">        capmem = roundupsize(<span class="type">uintptr</span>(newcap) &lt;&lt; shift)</span><br><span class="line">        overflow = <span class="type">uintptr</span>(newcap) &gt; (maxAlloc &gt;&gt; shift)</span><br><span class="line">        newcap = <span class="type">int</span>(capmem &gt;&gt; shift)</span><br><span class="line">        capmem = <span class="type">uintptr</span>(newcap) &lt;&lt; shift</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        lenmem = <span class="type">uintptr</span>(oldLen) * et.Size_</span><br><span class="line">        newlenmem = <span class="type">uintptr</span>(newLen) * et.Size_</span><br><span class="line">        capmem, overflow = math.MulUintptr(et.Size_, <span class="type">uintptr</span>(newcap))</span><br><span class="line">        capmem = roundupsize(capmem)</span><br><span class="line">        newcap = <span class="type">int</span>(capmem / et.Size_)</span><br><span class="line">        capmem = <span class="type">uintptr</span>(newcap) * et.Size_</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> overflow || capmem &gt; maxAlloc &#123;</span><br><span class="line">        <span class="built_in">panic</span>(errorString(<span class="string">&quot;growslice: len out of range&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ–°çš„å†…å­˜åœ°å€</span></span><br><span class="line">    <span class="keyword">var</span> p unsafe.Pointer</span><br><span class="line">    <span class="keyword">if</span> et.PtrBytes == <span class="number">0</span> &#123;<span class="comment">// æ— æŒ‡é’ˆ</span></span><br><span class="line">        p = mallocgc(capmem, <span class="literal">nil</span>, <span class="literal">false</span>)</span><br><span class="line">        memclrNoHeapPointers(add(p, newlenmem), capmem-newlenmem)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æœ‰æŒ‡é’ˆ</span></span><br><span class="line">        p = mallocgc(capmem, et, <span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">if</span> lenmem &gt; <span class="number">0</span> &amp;&amp; writeBarrier.enabled &#123;</span><br><span class="line">            bulkBarrierPreWriteSrcOnly(<span class="type">uintptr</span>(p), <span class="type">uintptr</span>(oldPtr), lenmem-et.Size_+et.PtrBytes)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    memmove(p, oldPtr, lenmem)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> slice&#123;p, newLen, newcap&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰©å®¹è§„åˆ™ï¼š</p><ol><li>å¦‚æœæ–°åˆ‡ç‰‡çš„é•¿åº¦å¤§äºæ—§åˆ‡ç‰‡å®¹é‡çš„ä¸¤å€ï¼Œåˆ™ç›´æ¥å°†æ–°åˆ‡ç‰‡çš„é•¿åº¦ä½œä¸ºå®¹é‡</li><li>å®¹é‡å°äº256ï¼Œç›´æ¥ä¸¤å€æ‰©å®¹</li><li>å¤§äº256ï¼Œåˆ™å¾ªç¯æ‰©å®¹åŠ ä¸Š1/4å®¹é‡å’Œä¸€ä¸ªå›ºå®šå€¼192ï¼Œ</li></ol><h3 id="4-åˆ‡ç‰‡æ‹·è´"><a href="#4-åˆ‡ç‰‡æ‹·è´" class="headerlink" title="4 åˆ‡ç‰‡æ‹·è´"></a>4 åˆ‡ç‰‡æ‹·è´</h3><h4 id="4-1-èµ‹å€¼æ‹·è´"><a href="#4-1-èµ‹å€¼æ‹·è´" class="headerlink" title="4.1 èµ‹å€¼æ‹·è´"></a>4.1 èµ‹å€¼æ‹·è´</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s1 := []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;</span><br><span class="line">s2 := s1[<span class="number">1</span>:]</span><br></pre></td></tr></table></figure><p>è¿™ç§é€šè¿‡èµ‹å€¼æ¥æ‹·è´çš„ï¼Œä¸¤è€…ä¼šå…±ç”¨ä¸€ä¸ªåº•å±‚æ•°ç»„ï¼Œæ„æ€å°±æ˜¯ä¸¤è€…æŒ‡å‘çš„å…ƒç´ æ˜¯ç›¸åŒçš„ï¼Œå³</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230901214335034.png" alt="image-20230901214335034" style="zoom:40%;" /></p><h4 id="4-2-copyæˆ–è€…slicecopy"><a href="#4-2-copyæˆ–è€…slicecopy" class="headerlink" title="4.2 copyæˆ–è€…slicecopy"></a>4.2 copyæˆ–è€…slicecopy</h4><p>å¦‚æœä¸æƒ³è¦ä¸¤ä¸ªæŒ‡å‘çš„åŒä¸€ä¸ªæ•°ç»„ï¼Œåˆ™é€šè¿‡<code>copy</code>æˆ–è€…<code>slicecopy</code>æ¥è¿›è¡Œæ‹·è´ï¼Œä¸¤ç§æ‹·è´æ–¹å¼éƒ½ä¼šé€šè¿‡ <code>runtime.memmove</code>å°†æ•´å—å†…å­˜çš„å†…å®¹æ‹·è´åˆ°ç›®æ ‡çš„å†…å­˜åŒºåŸŸä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">slicecopy</span><span class="params">(toPtr unsafe.Pointer, toLen <span class="type">int</span>, fromPtr unsafe.Pointer, fromLen <span class="type">int</span>, width <span class="type">uintptr</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> fromLen == <span class="number">0</span> || toLen == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    n := fromLen</span><br><span class="line">    <span class="keyword">if</span> toLen &lt; n &#123;</span><br><span class="line">        n = toLen</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> width == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> n</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> size == <span class="number">1</span> &#123; <span class="comment">// common case worth about 2x to do here</span></span><br><span class="line">        *(*<span class="type">byte</span>)(toPtr) = *(*<span class="type">byte</span>)(fromPtr) <span class="comment">// known to be a byte pointer</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        memmove(toPtr, fromPtr, size)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230901214757321.png" alt="image-20230901214757321" style="zoom:40%;" /></p><h3 id="5-è¿½åŠ å’Œåˆ é™¤"><a href="#5-è¿½åŠ å’Œåˆ é™¤" class="headerlink" title="5 è¿½åŠ å’Œåˆ é™¤"></a>5 è¿½åŠ å’Œåˆ é™¤</h3><p>è¿½åŠ æ“ä½œæ¯”è¾ƒç®€å•é€šè¿‡<code>append()</code>å³å¯å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s := []<span class="type">int</span>&#123;<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;  </span><br><span class="line">s = <span class="built_in">append</span>(s,<span class="number">5</span>)<span class="comment">// [2,3,4,5]</span></span><br></pre></td></tr></table></figure><p>åˆ é™¤æ“ä½œæœ‰å¦‚ä¸‹å‡ ç§æƒ…å†µ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := []<span class="type">int</span>&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;</span><br><span class="line">s = s[<span class="number">1</span>:]<span class="comment">// [1,2,3,4]</span></span><br><span class="line"></span><br><span class="line">s = <span class="built_in">append</span>(s[:<span class="number">2</span>],s[<span class="number">3</span>:]...)<span class="comment">// [0,1,3,4]</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mapæºç å­¦ä¹ </title>
      <link href="/2023/09/01/map%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/09/01/map%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç‰¹åˆ«æé†’ï¼Œæœ¬æ–‡æ‰€æ¶‰åŠçš„æºç æ˜¯<code>go1.21.0 darwin/amd64</code></p><p>æ–‡ä»¶ä½ç½®ï¼šruntime/map.go</p><p>å“ˆå¸Œè¡¨ä½œä¸ºä¸€ç§éå¸¸å¸¸è§çš„æ•°æ®ç»“æ„ï¼Œåœ¨å…¶å®ƒè¯­è¨€ä¸­ä¹Ÿéƒ½ä¼šæœ‰å‡ºç°ï¼Œå› æ­¤æœ¬æ–‡ä¸å¯¹å“ˆå¸Œè¡¨çš„æ¦‚å¿µã€ç”¨æ³•åšè§£é‡Šï¼Œä¸“æ³¨äºgoè¯­è¨€ä¸­çš„æºç å­¦ä¹ ã€‚</p></blockquote><h3 id="1-æ•°æ®ç»“æ„"><a href="#1-æ•°æ®ç»“æ„" class="headerlink" title="1 æ•°æ®ç»“æ„"></a>1 æ•°æ®ç»“æ„</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">    count     <span class="type">int</span> <span class="comment">// å½“å‰mapä¸­çš„å…ƒç´ æ•°é‡</span></span><br><span class="line">    flags     <span class="type">uint8</span></span><br><span class="line">    B         <span class="type">uint8</span> </span><br><span class="line">    noverflow <span class="type">uint16</span> </span><br><span class="line">    hash0     <span class="type">uint32</span> <span class="comment">// å“ˆå¸Œç§å­ï¼Œåœ¨åˆ›å»ºmapæ—¶å¾—åˆ°çš„ä¸€ä¸ªéšæœºæ•°</span></span><br><span class="line">    buckets    unsafe.Pointer <span class="comment">// æ¡¶æ•°ç»„</span></span><br><span class="line">    oldbuckets unsafe.Pointer <span class="comment">// æ‰©å®¹è¿‡ç¨‹ä¸­æ—§çš„æ¡¶æ•°ç»„</span></span><br><span class="line">    nevacuate  <span class="type">uintptr</span>        </span><br><span class="line">    extra *mapextra <span class="comment">// é¢å¤–è®°å½•çš„ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>flagsï¼šæ ‡å¿—ä½<ul><li>iterator = 1ï¼šå¯èƒ½æœ‰è¿­ä»£å™¨åœ¨éå†<code>buckets</code></li><li>oldIterator  = 2ï¼šå¯èƒ½æœ‰è¿­ä»£å™¨åœ¨éå†<code>oldbuckets</code>ï¼Œç”¨äºæ‰©å®¹æœŸé—´</li><li>hashWriting  = 4ï¼šæ ‡è®°ä¸€ä¸ª<code>g</code>æ­£åœ¨å†™<code>map</code></li><li>sameSizeGrow = 8ï¼šç­‰é‡æ‰©å®¹</li></ul></li><li>Bï¼šæ¡¶æ•°é‡çš„æŒ‡æ•°ï¼Œå³<code>len(buckets)</code>$=2^B$</li><li><p>noverflowï¼šæº¢å‡ºåŒçš„æ•°é‡ï¼Œå½“å…¶æ¥è¿‘$2^{15}-1$æ—¶ä¸ºè¿‘ä¼¼å€¼</p></li><li><p>nevacuateï¼šæ‰©å®¹è¿‡ç¨‹ä¸­çš„è¿›åº¦æ ‡è¯†ï¼ˆindexå°äºå®ƒçš„æ¡¶å·²ç»è¢«è½¬ç§»åˆ°æ–°æ¡¶ä¸­äº†ï¼‰</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> mapextra <span class="keyword">struct</span> &#123;</span><br><span class="line">    overflow    *[]*bmap</span><br><span class="line">    oldoverflow *[]*bmap</span><br><span class="line">    nextOverflow *bmap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“<code>map</code>ä¸­çš„<code>kev</code>å’Œ<code>value</code>ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼Œ<code>overflow</code>å’Œ<code>oldoverflow</code>æ‰è¢«ä½¿ç”¨</p><ul><li>overflowï¼š<code>hmap.buckets</code> ä½¿ç”¨çš„æº¢å‡ºæ¡¶</li><li>oldoverflowï¼š<code>hmap.oldbuckets</code>ä½¿ç”¨çš„æº¢å‡ºæ¡¶</li><li>nextOverflowï¼šä¸‹ä¸€ä¸ªå¯ä»¥ç”¨çš„æº¢å‡ºæ¡¶</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> bmap <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// bucketCnt=8</span></span><br><span class="line">    tophash [bucketCnt]<span class="type">uint8</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>tophashï¼š $\leq5$æ—¶å­˜æ”¾çš„æ˜¯çŠ¶æ€ã€‚$\gt5$æ—¶å­˜æ”¾çš„æ˜¯é«˜8ä½çš„<code>hash</code>å€¼ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­<code>key</code>æ˜¯å¦å­˜åœ¨<ul><li>emptyRest = 0ï¼š æ­¤å•å…ƒä¸ºç©ºï¼Œä¸”æ›´é«˜ç´¢å¼•çš„å•å…ƒä¹Ÿä¸ºç©º</li><li>emptyOne = 1ï¼š æ­¤å•å…ƒä¸ºç©º</li><li>evacuatedX = 2ï¼š ç”¨äºè¡¨ç¤ºæ‰©å®¹è¿ç§»åˆ°æ–°æ¡¶å‰åŠæ®µåŒºé—´ï¼Œå³ç´¢å¼•æ²¡å˜</li><li>evacuatedY = 3ï¼š ç”¨äºè¡¨ç¤ºæ‰©å®¹è¿ç§»åˆ°æ–°æ¡¶ååŠæ®µåŒºé—´ï¼Œå³åœ¨æ–°æ¡¶ä¸­çš„ç´¢å¼•=æ—§æ¡¶ç´¢å¼•+æ‰©å®¹å‰å®¹é‡å¤§å°</li><li>evacuatedEmpty = 4ï¼š ç”¨äºè¡¨ç¤ºæ­¤æ¡¶å·²è¿ç§»å®Œæˆ</li><li>minTopHash = 5ï¼š æœ€å°çš„ç©ºæ¡¶æ ‡è®°å€¼ï¼Œå°äºå…¶åˆ™æ˜¯ç©ºæ¡¶æ ‡å¿—</li></ul></li></ul><p>åœ¨<code>runtime/map.go</code>æ–‡ä»¶ä¸­<code>bmap</code>åªåŒ…å«äº†ä¸€ä¸ªç®€å•çš„<code>tophash</code>å­—æ®µï¼Œä½†æ˜¯åœ¨è¿è¡ŒæœŸé—´ä¼šæ ¹æ®<code>key</code>å’Œ<code>value</code>çš„ç±»å‹å¯¹<code>bmap</code>çš„ç»“æ„è¿›è¡Œé‡å»ºå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> bmap <span class="keyword">struct</span> &#123;</span><br><span class="line">    topbits  [<span class="number">8</span>]<span class="type">uint8</span></span><br><span class="line">    keys     [<span class="number">8</span>]keytype</span><br><span class="line">    elems    [<span class="number">8</span>]elemype</span><br><span class="line">    overflow <span class="type">uintptr</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç›¸å…³ä»£ç åœ¨ï¼šcmd/compile/internal/reflectdata/reflect.go:   MapBucketType</p></blockquote><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230831164229965.png" alt="image-20230831164229965"></p><h3 id="2-æ„é€ æ–¹æ³•"><a href="#2-æ„é€ æ–¹æ³•" class="headerlink" title="2 æ„é€ æ–¹æ³•"></a>2 æ„é€ æ–¹æ³•</h3><p>åˆ›å»º<code>map</code>æ—¶ï¼Œå®é™…ä¸Šä¼šè°ƒç”¨<code>makemap()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•åˆ†æå¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makemap</span><span class="params">(t *maptype, hint <span class="type">int</span>, h *hmap)</span></span> *hmap</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mem, overflow := math.MulUintptr(<span class="type">uintptr</span>(hint), t.Bucket.Size_)</span><br><span class="line"><span class="keyword">if</span> overflow || mem &gt; maxAlloc &#123;</span><br><span class="line">    hint = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>hint</code>æ˜¯ä¸º<code>map</code>æ‹Ÿåˆ†é…çš„å®¹é‡ï¼Œå†åˆ†é…å‰ä¼šå¯¹æ‹Ÿåˆ†é…çš„å†…å­˜å¤§å°è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¶…è¿‡é™åˆ¶å¤§å°ï¼Œåˆ™ä¼šå°†<code>hint</code>è®¾ç½®ä¸ºé›¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> h == <span class="literal">nil</span> &#123;</span><br><span class="line">    h = <span class="built_in">new</span>(hmap)</span><br><span class="line">&#125;</span><br><span class="line">h.hash0 = fastrand()</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–<code>h</code>ï¼Œå¹¶è®¾ç½®å“ˆå¸Œç§å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">B := <span class="type">uint8</span>(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> overLoadFactor(hint, B) &#123;</span><br><span class="line">    B++</span><br><span class="line">&#125;</span><br><span class="line">h.B = B</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆå§‹åŒ–<code>B</code>ä¸º0ï¼Œç„¶åæ ¹æ®$\frac{hint}{6}&gt;2^B$å¦‚æœæˆç«‹åˆ™B+1ï¼Œæœ€åç›´åˆ°Bä¸æˆç«‹ä¸ºæ­¢ï¼Œå³è®©$\frac{hint}{2^B}$è´Ÿè½½å› å­å°äºç­‰äº6</p><p>map é¢„åˆ†é…å®¹é‡ã€æ¡¶æ•°ç»„é•¿åº¦æŒ‡æ•°ã€æ¡¶æ•°ç»„é•¿åº¦ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹è¡¨ï¼š</p><div class="table-container"><table><thead><tr><th>kvå¯¹æ•°é‡</th><th>æŒ‡æ•°B</th><th>é•¿åº¦$2^B$</th></tr></thead><tbody><tr><td>0~8</td><td>0</td><td>1</td></tr><tr><td>9~12</td><td>1</td><td>2</td></tr><tr><td>13~24</td><td>2</td><td>4</td></tr><tr><td>25~48</td><td>3</td><td>8</td></tr><tr><td>$2^{B-1}\times6+1$~$ 2^B \times 6$</td><td>B</td><td>$2^B$</td></tr></tbody></table></div><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> h.B != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> nextOverflow *bmap</span><br><span class="line">    h.buckets, nextOverflow = makeBucketArray(t, h.B, <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">if</span> nextOverflow != <span class="literal">nil</span> &#123;</span><br><span class="line">        h.extra = <span class="built_in">new</span>(mapextra)</span><br><span class="line">        h.extra.nextOverflow = nextOverflow</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>makeBucketArray</code>åˆå§‹åŒ–æ¡¶æ•°ç»„<code>buckets</code>ï¼Œå¦‚æœ<code>map</code>å®¹é‡è¿‡å¤§ï¼Œä¼šæå‰ç”³è¯·æº¢å‡ºæ¡¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeBucketArray</span><span class="params">(t *maptype, b <span class="type">uint8</span>, dirtyalloc unsafe.Pointer)</span></span> (buckets unsafe.Pointer, nextOverflow *bmap) &#123;</span><br><span class="line">    base := bucketShift(b)</span><br><span class="line">    nbuckets := base</span><br><span class="line">    <span class="keyword">if</span> b &gt;= <span class="number">4</span> &#123;</span><br><span class="line">        nbuckets += bucketShift(b - <span class="number">4</span>)</span><br><span class="line">        sz := t.Bucket.Size_ * nbuckets</span><br><span class="line">        up := roundupsize(sz)</span><br><span class="line">        <span class="keyword">if</span> up != sz &#123;</span><br><span class="line">            nbuckets = up / t.Bucket.Size_</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> dirtyalloc == <span class="literal">nil</span> &#123;</span><br><span class="line">        buckets = newarray(t.Bucket, <span class="type">int</span>(nbuckets))</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        buckets = dirtyalloc</span><br><span class="line">        size := t.Bucket.Size_ * nbuckets</span><br><span class="line">        <span class="keyword">if</span> t.Bucket.PtrBytes != <span class="number">0</span> &#123;</span><br><span class="line">            memclrHasPointers(buckets, size)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            memclrNoHeapPointers(buckets, size)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> base != nbuckets &#123;</span><br><span class="line">        nextOverflow = (*bmap)(add(buckets, base*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">        last := (*bmap)(add(buckets, (nbuckets<span class="number">-1</span>)*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">        last.setoverflow(t, (*bmap)(buckets))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buckets, nextOverflow</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>B</code>å¤§äº4çš„è¯ï¼Œä¼šé¢å¤–å¤šåˆ›å»º$2^{B-4}$ä¸ªæº¢å‡ºæ¡¶ï¼ˆå†…å­˜å¯¹é½ï¼‰ï¼Œå¹¶å°†<code>h.nextOverflow</code>æŒ‡å‘ç¬¬ä¸€ä¸ªæº¢å‡ºæ¡¶çš„åœ°å€ï¼Œæœ€åä¸€ä¸ªæº¢å‡ºæ¡¶çš„åœ°å€è®¾ç½®ä¸º<code>h.buckets</code>(æ–¹ä¾¿åˆ¤æ–­æº¢å‡ºæ¡¶å·²ç»ç”¨å®Œ)</p><h3 id="3-è¯»æ“ä½œ"><a href="#3-è¯»æ“ä½œ" class="headerlink" title="3 è¯»æ“ä½œ"></a>3 è¯»æ“ä½œ</h3><p><code>map</code>çš„è¯»æ“ä½œä¸€èˆ¬æ˜¯é€šè¿‡ä¸‹æ ‡æˆ–è€…éå†è¿›è¡Œçš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">value = hash[key]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v := <span class="keyword">range</span> hash &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ç§æ–¹å¼éƒ½èƒ½å¤Ÿè¯»å–ï¼Œä½†æ˜¯æ‰€ä½¿ç”¨åˆ°çš„å‡½æ•°å’Œåº•å±‚çš„åŸç†æ˜¯ä¸åŒçš„</p><h4 id="3-1-é€šè¿‡keyæ¥è¯»å–"><a href="#3-1-é€šè¿‡keyæ¥è¯»å–" class="headerlink" title="3.1 é€šè¿‡keyæ¥è¯»å–"></a>3.1 é€šè¿‡keyæ¥è¯»å–</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">value := hash[key]<span class="comment">// =&gt; v     := mapaccess1(maptype, hash, &amp;key)</span></span><br><span class="line">value,ok := hash[key]<span class="comment">// =&gt; v, ok := mapaccess2(maptype, hash, &amp;key)</span></span><br></pre></td></tr></table></figure><ul><li>å½“åªéœ€è¦ä¸€ä¸ªè¿”å›å€¼æ—¶ï¼Œä¼šè°ƒç”¨<code>mapaccess1()</code>å‡½æ•°</li><li>å½“éœ€è¦ä¸¤ä¸ªè¿”å›å€¼æ—¶ï¼Œä¼šè°ƒç”¨<code>mapaccess2()</code>å‡½æ•°</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> h == <span class="literal">nil</span> || h.count == <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> t.HashMightPanic() &#123;</span><br><span class="line">        t.Hasher(key, <span class="number">0</span>) <span class="comment">// see issue 23734</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1 å¦‚æœ<code>h</code>æœªåˆå§‹åŒ–æˆ–è€…<code>map</code>ä¸­çš„<code>k-v</code>å¯¹ä¸º0ï¼Œåˆ™ä¼šç›´æ¥è¿”å›ä¸€ä¸ªé›¶å€¼å¯¹è±¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123;</span><br><span class="line">    fatal(<span class="string">&quot;concurrent map read and map write&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2 å¦‚æœæ­¤æ—¶æœ‰å…¶å®ƒçš„<code>g</code>åœ¨å¯¹<code>map</code>è¿›è¡Œå†™æ“ä½œï¼Œåˆ™ç›´æ¥è¿”å›<code>fatal</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hash := t.Hasher(key, <span class="type">uintptr</span>(h.hash0))</span><br><span class="line">m := bucketMask(h.B)</span><br><span class="line">b := (*bmap)(add(h.buckets, (hash&amp;m)*<span class="type">uintptr</span>(t.BucketSize)))</span><br></pre></td></tr></table></figure><p>3 é€šè¿‡<code>MapType.Hasher()</code>æ–¹æ³•å¾—åˆ°<code>key</code>å¯¹åº”çš„<code>hash</code>å€¼å¹¶å¯¹æ¡¶æ•°é‡å–æ¨¡ï¼Œè·å–å¯¹åº”æ¡¶çš„ç´¢å¼•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> c := h.oldbuckets; c != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !h.sameSizeGrow() &#123;</span><br><span class="line">        <span class="comment">// There used to be half as many buckets; mask down one more power of two.</span></span><br><span class="line">        m &gt;&gt;= <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    oldb := (*bmap)(add(c, (hash&amp;m)*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">    <span class="keyword">if</span> !evacuated(oldb) &#123;</span><br><span class="line">        b = oldb</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4 åˆ¤æ–­<code>map</code>æ˜¯å¦æ­£åœ¨æ‰©å®¹ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦è¿›è¡Œå¢é‡æ‰©å®¹ï¼Œå€˜è‹¥æ˜¯çš„è¯ï¼Œéœ€è¦å°†mé™¤ä»¥2ï¼Œå› ä¸ºæ—§æ¡¶çš„é•¿åº¦åªæ˜¯æ–°æ¡¶çš„ä¸€åŠï¼Œç„¶åé€šè¿‡<code>evacuated</code>åˆ¤æ–­è¦æ‰¾çš„æ¡¶æ˜¯å¦åœ¨æ—§çš„æ¡¶æ•°ç»„é‡Œé¢ï¼Œå¦‚æœæ˜¯åˆ™éœ€è¦å»æ—§çš„æ¡¶æ•°ç»„å½“ä¸­å»æ‰¾ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">top := tophash(hash)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tophash</span><span class="params">(hash <span class="type">uintptr</span>)</span></span> <span class="type">uint8</span> &#123;</span><br><span class="line">    top := <span class="type">uint8</span>(hash &gt;&gt; (goarch.PtrSize*<span class="number">8</span> - <span class="number">8</span>))</span><br><span class="line">    <span class="keyword">if</span> top &lt; minTopHash &#123;</span><br><span class="line">        top += minTopHash</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> top</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5 è·å–<code>hash</code>å€¼çš„é«˜å…«ä½ï¼Œå¦‚æœè¯¥å€¼å°äº5ï¼Œä¼šåŠ ä¸Š5ï¼Œä»¥é¿å¼€0~4è¿™ä¸ªåŒºé—´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">bucketloop:</span><br><span class="line">    <span class="keyword">for</span> ; b != <span class="literal">nil</span>; b = b.overflow(t) &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; bucketCnt; i++ &#123;</span><br><span class="line">            <span class="keyword">if</span> b.tophash[i] != top &#123;</span><br><span class="line">                <span class="keyword">if</span> b.tophash[i] == emptyRest &#123;</span><br><span class="line">                    <span class="keyword">break</span> bucketloop</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            k := add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">            <span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">                k = *((*unsafe.Pointer)(k))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> t.Key.Equal(key, k) &#123;</span><br><span class="line">                e := add(unsafe.Pointer(b), dataOffset+bucketCnt*<span class="type">uintptr</span>(t.KeySize)+i*<span class="type">uintptr</span>(t.ValueSize))</span><br><span class="line">                <span class="keyword">if</span> t.IndirectElem() &#123;</span><br><span class="line">                    e = *((*unsafe.Pointer)(e))</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> e</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> unsafe.Pointer(&amp;zeroVal[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><p>6 å¤–å±‚<code>for</code>å¾ªç¯ä¼šéå†è¦æŸ¥æ‰¾çš„é‚£ä¸ªæ¡¶åŠå…¶åç»­çš„æº¢å‡ºæ¡¶ï¼Œé‡Œå±‚<code>for</code>å¾ªç¯éå†æ¡¶å†…çš„<code>key-value</code>å¯¹ã€‚éå†æ—¶é¦–å…ˆæŸ¥è¯¢é«˜8ä½çš„<code>tophash</code>å€¼ï¼Œå¦‚æœå’Œ<code>key</code>çš„å¯¹åº”ä¸ä¸Šï¼Œå¹¶ä¸”å½“å‰ä½ç½®çš„<code>tophash</code>ä¸º0ï¼Œåˆ™åé¢æ²¡æœ‰å…ƒç´ ï¼Œç›´æ¥ç»“æŸè¿™ä¸ªæ¡¶çš„éå†ã€‚å€˜è‹¥æ‰¾åˆ°äº†ç›¸ç­‰çš„<code>key</code>ï¼Œåˆ™é€šè¿‡åœ°å€åç§»çš„æ–¹å¼å–åˆ° <code>value</code> å¹¶è¿”å›ï¼Œå¦‚æœéå†äº†æ‰€æœ‰æ¡¶éƒ½æ²¡æ‰¾åˆ°ï¼Œåˆ™è¿”å›ä¸€ä¸ªé›¶å€¼ã€‚</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230829203844637.png" alt="image-20230829203844637" style="zoom:40%;" /></p><h3 id="4-å†™æ“ä½œ"><a href="#4-å†™æ“ä½œ" class="headerlink" title="4 å†™æ“ä½œ"></a>4 å†™æ“ä½œ</h3><p>å†™æ“ä½œçš„å®ç°ç”±<code>mapassign</code>å‡½æ•°å®ç°</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›å¾…æ›´æ–°çš„valueåœ°å€</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapassign</span><span class="params">(t *maptype, h *hmap, key unsafe.Pointer)</span></span> unsafe.Pointer &#123;</span><br><span class="line">    hash := t.hasher(key, <span class="type">uintptr</span>(h.hash0))</span><br><span class="line">    <span class="comment">// æ¡¶ä¸ºç©ºï¼Œåˆ™åˆ†é…ä¸€ä¸ªæ¡¶</span></span><br><span class="line">    <span class="keyword">if</span> h.buckets == <span class="literal">nil</span> &#123;</span><br><span class="line">        h.buckets = newobject(t.bucket) <span class="comment">// newarray(t.bucket, 1)</span></span><br><span class="line">    &#125;</span><br><span class="line">again:</span><br><span class="line">    bucket := hash &amp; bucketMask(h.B)<span class="comment">//è·å–ç›®æ ‡æ¡¶åºå·</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¿˜å¤„äºæ‰©å®¹ä¸­ï¼Œæˆ‘ä»¬è¦è®©è¿™ä¸ªkeyå¯¹åº”çš„æ—§æ¡¶ç«‹é©¬è¿ç§»åˆ°æ–°æ¡¶</span></span><br><span class="line">    <span class="keyword">if</span> h.growing() &#123;</span><br><span class="line">        growWork(t, h, bucket)<span class="comment">//è§æ‰©å®¹</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// bå°±æ˜¯ç›®æ ‡æ¡¶</span></span><br><span class="line">    b := (*bmap)(add(h.buckets, bucket*<span class="type">uintptr</span>(t.bucketsize)))</span><br><span class="line">  top := tophash(hash)<span class="comment">//hashé«˜8ä½</span></span><br><span class="line">    <span class="keyword">var</span> inserti *<span class="type">uint8</span><span class="comment">//tophash</span></span><br><span class="line">    <span class="keyword">var</span> insertk unsafe.Pointer<span class="comment">//key</span></span><br><span class="line">    <span class="keyword">var</span> elem unsafe.Pointer<span class="comment">//value</span></span><br><span class="line">bucketloop:</span><br><span class="line">    <span class="comment">// å¤–å¾ªç¯æ˜¯éå†æ¡¶ï¼Œå†…å¾ªç¯æ˜¯éå†æ¯ä¸ªæ¡¶çš„8ä¸ªkvå¯¹</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; bucketCnt; i++ &#123;</span><br><span class="line">            <span class="keyword">if</span> b.tophash[i] != top &#123;</span><br><span class="line">                <span class="comment">// æ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªç©ºçš„å­˜æ”¾åœ°å€</span></span><br><span class="line">                <span class="keyword">if</span> isEmpty(b.tophash[i]) &amp;&amp; inserti == <span class="literal">nil</span> &#123;</span><br><span class="line">                    inserti = &amp;b.tophash[i]</span><br><span class="line">                    insertk = add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.keysize))</span><br><span class="line">                    elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*<span class="type">uintptr</span>(t.keysize)+i*<span class="type">uintptr</span>(t.elemsize))</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å¦‚æœåç»­çš„æ‰€æœ‰celléƒ½æ˜¯ç©ºçš„äº†ï¼Œæ²¡å¿…è¦å†æŸ¥è¯¢</span></span><br><span class="line">                <span class="keyword">if</span> b.tophash[i] == emptyRest &#123;</span><br><span class="line">                    <span class="keyword">break</span> bucketloop</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            k := add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.keysize))</span><br><span class="line">            <span class="comment">// tophashç›¸åŒåï¼Œå†æ¯”è¾ƒkeyè¿›è¡Œç¡®è®¤</span></span><br><span class="line">            <span class="keyword">if</span> !t.key.equal(key, k) &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//å¹¶å°†å¾…æ›´æ–°çš„valueåœ°å€è¿”å›</span></span><br><span class="line">            elem = add(unsafe.Pointer(b), dataOffset+bucketCnt*<span class="type">uintptr</span>(t.keysize)+i*<span class="type">uintptr</span>(t.elemsize))</span><br><span class="line">            <span class="keyword">goto</span> done</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//å–ä¸‹ä¸€ä¸ªæº¢å‡ºæ¡¶</span></span><br><span class="line">        ovf := b.overflow(t)</span><br><span class="line">        <span class="keyword">if</span> ovf == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        b = ovf</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸‹é¢å°±æ˜¯mapæ²¡æœ‰å­˜keyçš„æƒ…å†µ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½“ä¸å¤„äºæ‰©å®¹æ—¶ï¼Œè¶…è¿‡è´Ÿè½½å› å­æˆ–è€…å¤ªå¤šæº¢å‡ºæ¡¶ï¼Œå³æº¢å‡ºæ¡¶ä¸ªæ•°å¤§äºç­‰äº1&lt;&lt; min(h.B,15)</span></span><br><span class="line">    <span class="keyword">if</span> !h.growing() &amp;&amp; (overLoadFactor(h.count+<span class="number">1</span>, h.B) || tooManyOverflowBuckets(h.noverflow, h.B)) &#123;</span><br><span class="line">        hashGrow(t, h)<span class="comment">// åˆ†é…æ–°æ¡¶ï¼Œä½†è¿˜ä¸è¿ç§»æ—§æ¡¶ï¼Œè§æ‰©å®¹éƒ¨åˆ†</span></span><br><span class="line">        <span class="keyword">goto</span> again </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ²¡æ‰¾åˆ°ä»»ä½•ç©ºä½</span></span><br><span class="line">    <span class="keyword">if</span> inserti == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="comment">// ä»æº¢å‡ºæ¡¶æ± æ‹¿æˆ–è€…åˆ†é…æº¢å‡ºæ¡¶å†…å­˜ï¼Œè§ä¸‹æ–‡</span></span><br><span class="line">        newb := h.newoverflow(t, b)</span><br><span class="line">        inserti = &amp;newb.tophash[<span class="number">0</span>]</span><br><span class="line">        insertk = add(unsafe.Pointer(newb), dataOffset)</span><br><span class="line">        elem = add(insertk, bucketCnt*<span class="type">uintptr</span>(t.keysize))</span><br><span class="line">    &#125;</span><br><span class="line">    *inserti = top<span class="comment">// è®¾ç½®tophash</span></span><br><span class="line">    h.count++<span class="comment">// mapå…ƒç´ æ•°é‡+1</span></span><br><span class="line">done:</span><br><span class="line">    <span class="keyword">return</span> elem<span class="comment">//å°†å­˜å–valueçš„åœ°å€è¿”å›</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230831170342743.png" alt="image-20230831170342743" style="zoom:40%;" /></p><h3 id="5-åˆ é™¤æ“ä½œ"><a href="#5-åˆ é™¤æ“ä½œ" class="headerlink" title="5 åˆ é™¤æ“ä½œ"></a>5 åˆ é™¤æ“ä½œ</h3><p><code>map</code>ç›¸å…³çš„åˆ é™¤æ“ä½œåœ¨<code>mapdelete()</code>å‡½æ•°ä¸‹é¢ï¼Œä¸æ›´æ–°æ“ä½œç±»ä¼¼ï¼Œå¤šäº†ä¸€ä¸ªä¿®æ”¹å½“å‰<code>tophash</code>çŠ¶æ€çš„æ­¥éª¤</p><p>é¦–å…ˆä¼šå°†å½“å‰çš„<code>tophash[i]</code>æ›´æ–°ä¸º<code>emptyOne</code>ï¼Œè¿™ä¸ªä¸ä»…ä»…æ˜¯æ“ä½œè‡ªå·±çš„<code>tophash[i]</code>è¿˜è¦åˆ¤æ–­å®ƒçš„ä¸‹ä¸€ä¸ªæ˜¯ä¸æ˜¯<code>emptyRest</code>ï¼Œå¦‚æœä¸‹ä¸€ä¸ªä¸º<code>emptyRest</code>ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°†<code>tophash[i]</code>è¿›ä¸€æ­¥æ›´æ–°ä¸º<code>emptyRest</code>ï¼Œå¹¶ä¸”è¿˜éœ€è¦åˆ¤æ–­ä¹‹å‰çš„<code>tophash</code>å¦‚æœä¹‹å‰çš„ä¸º<code>emptyOne</code>åˆ™è¦ä¿®æ”¹ä¸º<code>emptyRest</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mapdelete</span><span class="params">(t *maptype, h *hmap, key unsafe.Pointer)</span></span> &#123;</span><br><span class="line">  <span class="comment">// hä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> h == <span class="literal">nil</span> || h.count == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> t.HashMightPanic() &#123;</span><br><span class="line">            t.Hasher(key, <span class="number">0</span>) <span class="comment">// see issue 23734</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// å½“å‰æœ‰goroutineåœ¨å†™ï¼Œåˆ™è¿”å›fatal</span></span><br><span class="line">    <span class="keyword">if</span> h.flags&amp;hashWriting != <span class="number">0</span> &#123;</span><br><span class="line">        fatal(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    hash := t.Hasher(key, <span class="type">uintptr</span>(h.hash0))</span><br><span class="line">    h.flags ^= hashWriting</span><br><span class="line">    <span class="comment">// æ‰¾åˆ°å¯¹åº”çš„æ¡¶</span></span><br><span class="line">    bucket := hash &amp; bucketMask(h.B)</span><br><span class="line">  <span class="comment">// æ­£åœ¨æ‰©å®¹ï¼Œå…ˆååŠ©è¿ç§»ï¼Œå†åˆ é™¤</span></span><br><span class="line">    <span class="keyword">if</span> h.growing() &#123;</span><br><span class="line">        growWork(t, h, bucket)</span><br><span class="line">    &#125;</span><br><span class="line">    b := (*bmap)(add(h.buckets, bucket*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">    bOrig := b</span><br><span class="line">    top := tophash(hash)</span><br><span class="line">search:</span><br><span class="line">    <span class="keyword">for</span> ; b != <span class="literal">nil</span>; b = b.overflow(t) &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="type">uintptr</span>(<span class="number">0</span>); i &lt; bucketCnt; i++ &#123;</span><br><span class="line">            <span class="keyword">if</span> b.tophash[i] != top &#123;</span><br><span class="line">                <span class="keyword">if</span> b.tophash[i] == emptyRest &#123;</span><br><span class="line">                    <span class="keyword">break</span> search</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            k := add(unsafe.Pointer(b), dataOffset+i*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">            k2 := k</span><br><span class="line">            <span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">                k2 = *((*unsafe.Pointer)(k2))</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> !t.Key.Equal(key, k2) &#123;</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Only clear key if there are pointers in it.</span></span><br><span class="line">            <span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">                *(*unsafe.Pointer)(k) = <span class="literal">nil</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> t.Key.PtrBytes != <span class="number">0</span> &#123;</span><br><span class="line">                memclrHasPointers(k, t.Key.Size_)</span><br><span class="line">            &#125;</span><br><span class="line">            e := add(unsafe.Pointer(b), dataOffset+bucketCnt*<span class="type">uintptr</span>(t.KeySize)+i*<span class="type">uintptr</span>(t.ValueSize))</span><br><span class="line">            <span class="keyword">if</span> t.IndirectElem() &#123;</span><br><span class="line">                *(*unsafe.Pointer)(e) = <span class="literal">nil</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> t.Elem.PtrBytes != <span class="number">0</span> &#123;</span><br><span class="line">                memclrHasPointers(e, t.Elem.Size_)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                memclrNoHeapPointers(e, t.Elem.Size_)</span><br><span class="line">            &#125;</span><br><span class="line">      <span class="comment">// æ›´æ–°çŠ¶æ€</span></span><br><span class="line">            b.tophash[i] = emptyOne</span><br><span class="line">      <span class="comment">// æ²¡æœ‰åä¸€ä¸ªkvå¯¹æˆ–è€…åä¸€ä¸ªkvå¯¹æ˜¯emptyOneçŠ¶æ€ï¼Œä¸éœ€è¦è¿›ä¸€æ­¥æ›´æ–°çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">if</span> i == bucketCnt<span class="number">-1</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> b.overflow(t) != <span class="literal">nil</span> &amp;&amp; b.overflow(t).tophash[<span class="number">0</span>] != emptyRest &#123;</span><br><span class="line">                    <span class="keyword">goto</span> notLast</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> b.tophash[i+<span class="number">1</span>] != emptyRest &#123;</span><br><span class="line">                    <span class="keyword">goto</span> notLast</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> &#123; <span class="comment">// ä»åå¾€å‰ï¼Œå°†ä¹‹å‰çš„emptyOneéƒ½æ”¹ä¸ºemptyRest</span></span><br><span class="line">                b.tophash[i] = emptyRest</span><br><span class="line">                <span class="keyword">if</span> i == <span class="number">0</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> b == bOrig &#123;</span><br><span class="line">                        <span class="keyword">break</span> <span class="comment">// beginning of initial bucket, we&#x27;re done.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    c := b</span><br><span class="line">                    <span class="keyword">for</span> b = bOrig; b.overflow(t) != c; b = b.overflow(t) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                    i = bucketCnt - <span class="number">1</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    i--</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> b.tophash[i] != emptyOne &#123;</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        notLast:</span><br><span class="line">            h.count--</span><br><span class="line">            <span class="keyword">if</span> h.count == <span class="number">0</span> &#123;</span><br><span class="line">                h.hash0 = fastrand()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span> search</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> h.flags&amp;hashWriting == <span class="number">0</span> &#123;</span><br><span class="line">        fatal(<span class="string">&quot;concurrent map writes&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    h.flags &amp;^= hashWriting</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="6-æ‰©å®¹æ“ä½œ"><a href="#6-æ‰©å®¹æ“ä½œ" class="headerlink" title="6 æ‰©å®¹æ“ä½œ"></a>6 æ‰©å®¹æ“ä½œ</h3><ul><li>ç­‰é‡æ‰©å®¹ï¼šè´Ÿè½½å› å­æ²¡è¶…è¿‡6ï¼Œä½†æ˜¯æº¢å‡ºæ¡¶çš„æ•°é‡å¤§äºç­‰äº$1&lt;&lt;min(B,15)$ï¼Œæ–°æ¡¶æ•°ç»„çš„é•¿åº¦è·Ÿæ—§çš„ä¸€æ ·ï¼Œç›¸å½“äºæ˜¯å°†<code>k-v</code>å¯¹é‡æ–°<code>hash</code></li><li>å¢é‡æ‰©å®¹ï¼šè´Ÿè½½å› å­è¶…è¿‡6ï¼Œæ–°æ¡¶æ•°ç»„çš„é•¿åº¦æ˜¯æ—§çš„ä¸¤å€</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hashGrow</span><span class="params">(t *maptype, h *hmap)</span></span> &#123;</span><br><span class="line">    bigger := <span class="type">uint8</span>(<span class="number">1</span>)</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç­‰é‡æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> !overLoadFactor(h.count+<span class="number">1</span>, h.B) &#123;</span><br><span class="line">        bigger = <span class="number">0</span></span><br><span class="line">        h.flags |= sameSizeGrow</span><br><span class="line">    &#125;</span><br><span class="line">    oldbuckets := h.buckets</span><br><span class="line">    <span class="comment">// å¢é‡æ‰©å®¹ä¸­æ–°æ¡¶å˜ä¸ºæ—§æ¡¶ä¸¤å€ï¼Œç­‰é‡æ‰©å®¹æ˜¯æ•°é‡ä¸å˜</span></span><br><span class="line">    newbuckets, nextOverflow := makeBucketArray(t, h.B+bigger, <span class="literal">nil</span>)</span><br><span class="line">    flags := h.flags &amp;^ (iterator | oldIterator)</span><br><span class="line">    <span class="keyword">if</span> h.flags&amp;iterator != <span class="number">0</span> &#123;</span><br><span class="line">        flags |= oldIterator</span><br><span class="line">    &#125;</span><br><span class="line">    h.B += bigger</span><br><span class="line">    h.flags = flags</span><br><span class="line">    h.oldbuckets = oldbuckets</span><br><span class="line">    h.buckets = newbuckets</span><br><span class="line">    h.nevacuate = <span class="number">0</span></span><br><span class="line">    h.noverflow = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> h.extra != <span class="literal">nil</span> &amp;&amp; h.extra.overflow != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> h.extra.oldoverflow != <span class="literal">nil</span> &#123;</span><br><span class="line">            throw(<span class="string">&quot;oldoverflow is not nil&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        h.extra.oldoverflow = h.extra.overflow</span><br><span class="line">        h.extra.overflow = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> nextOverflow != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> h.extra == <span class="literal">nil</span> &#123;</span><br><span class="line">            h.extra = <span class="built_in">new</span>(mapextra)</span><br><span class="line">        &#125;</span><br><span class="line">        h.extra.nextOverflow = nextOverflow</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥å‡½æ•°çš„é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€å•ï¼Œå¹¶ä¸”<code>hashGrow</code>åªåœ¨<code>mapassign</code>ä¸­å‡ºç°ï¼Œå°±æ˜¯è¯´åªæœ‰åœ¨æ–°å€¼æ’å…¥çš„æ—¶å€™æ‰å¯èƒ½è§¦å‘æ‰©å®¹ã€‚</p><p>ä¸‹é¢æ¥åˆ†æ<code>growWork()</code>å‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">growWork</span><span class="params">(t *maptype, h *hmap, bucket <span class="type">uintptr</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// è¿ç§»æŒ‡å®šçš„æ—§æ¡¶</span></span><br><span class="line">    evacuate(t, h, bucket&amp;h.oldbucketmask())</span><br><span class="line">    <span class="keyword">if</span> h.growing() &#123;</span><br><span class="line">    <span class="comment">// é¢å¤–å†è¿ç§»ä¸€ä¸ªæ¡¶</span></span><br><span class="line">    <span class="comment">// nevacuateå°±æ˜¯è®°å½•è¿ç§»çš„è¿›åº¦ï¼Œæ‰€æœ‰åºå·å°äºè¿™ä¸ªçš„æ¡¶éƒ½å·²ç»è¿ç§»</span></span><br><span class="line">        evacuate(t, h, h.nevacuate)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä½¿ç”¨çš„æ˜¯æ¸è¿›å¼æ‰©å®¹ï¼Œå› æ­¤åœ¨æ’å…¥å’Œåˆ é™¤æ“ä½œä¸­ï¼Œå¦‚æœæ­¤æ—¶<code>map</code>æ­£åœ¨æ‰©å®¹ï¼Œåˆ™æ¯ä¸€ä¸ªæ“ä½œéƒ½ä¼šåˆ©ç”¨<code>growWork()</code>å‡½æ•°è¿ç§»æœ€å¤šä¸¤ä¸ªæ¡¶ï¼Œä¸€ä¸ªæ˜¯å½“æ—¶æ“ä½œçš„æ¡¶ï¼Œè¿˜æœ‰ä¸€ä¸ªå°±æ˜¯<code>nevacuate</code>æŒ‡å‘çš„æ¡¶ï¼Œå¦å¤–è¦æ³¨æ„çš„æ˜¯è¿™é‡Œçš„ä¸€ä¸ªæ¡¶æ˜¯åŒ…æ‹¬å®ƒæ‰€æŒ‡å‘çš„æº¢å‡ºæ¡¶çš„ã€‚å…·ä½“çš„è¿ç§»é€»è¾‘åœ¨<code>evacuate()</code>å‡½æ•°ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»£è¡¨äº†kvå¯¹çš„è¿ç§»ç›®çš„åœ°</span></span><br><span class="line"><span class="keyword">type</span> evacDst <span class="keyword">struct</span> &#123;</span><br><span class="line">    b *bmap          <span class="comment">// è¿ç§»åˆ°çš„ç›®çš„æ¡¶</span></span><br><span class="line">    i <span class="type">int</span>            <span class="comment">// è¿ç§»åˆ°çš„kvå¯¹åœ¨æ¡¶å†…çš„åºå·</span></span><br><span class="line">    k unsafe.Pointer <span class="comment">// è¿ç§»åˆ°çš„kvå¯¹çš„keyä½ç½®</span></span><br><span class="line">    e unsafe.Pointer <span class="comment">// è¿ç§»åˆ°çš„kvå¯¹çš„valueä½ç½®</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// oldbucketè¡¨ç¤ºè¦è¿ç§»çš„æ¡¶åºå·</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">evacuate</span><span class="params">(t *maptype, h *hmap, oldbucket <span class="type">uintptr</span>)</span></span> &#123;</span><br><span class="line">    b := (*bmap)(add(h.oldbuckets, oldbucket*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">    newbit := h.noldbuckets()<span class="comment">// æ—§æ¡¶ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">if</span> !evacuated(b) &#123;</span><br><span class="line">        <span class="keyword">var</span> xy [<span class="number">2</span>]evacDst<span class="comment">// æ–°æ¡¶çš„å‰ä¸€åŠå’Œåä¸€åŠ</span></span><br><span class="line">        x := &amp;xy[<span class="number">0</span>]</span><br><span class="line">        x.b = (*bmap)(add(h.buckets, oldbucket*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">        x.k = add(unsafe.Pointer(x.b), dataOffset)</span><br><span class="line">        x.e = add(x.k, bucketCnt*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">        <span class="comment">// å¢é‡æ‰©å®¹ï¼Œæœ‰åä¸€åŠ</span></span><br><span class="line">        <span class="keyword">if</span> !h.sameSizeGrow() &#123;</span><br><span class="line">            y := &amp;xy[<span class="number">1</span>]</span><br><span class="line">            y.b = (*bmap)(add(h.buckets, (oldbucket+newbit)*<span class="type">uintptr</span>(t.BucketSize)))</span><br><span class="line">            y.k = add(unsafe.Pointer(y.b), dataOffset)</span><br><span class="line">            y.e = add(y.k, bucketCnt*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‰é¢å·²ç»å°†è¦è¿ç§»åˆ°çš„ä½ç½®è®°å½•ä¸‹æ¥</span></span><br><span class="line">        <span class="comment">// å°†è¿™ä¸ªæ¡¶åŠå…¶æº¢å‡ºæ¡¶éƒ½è¿ç§»</span></span><br><span class="line">        <span class="keyword">for</span> ; b != <span class="literal">nil</span>; b = b.overflow(t) &#123;</span><br><span class="line">            k := add(unsafe.Pointer(b), dataOffset)</span><br><span class="line">            e := add(k, bucketCnt*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">            <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; bucketCnt; i, k, e = i+<span class="number">1</span>, add(k, <span class="type">uintptr</span>(t.KeySize)), add(e, <span class="type">uintptr</span>(t.ValueSize)) &#123;</span><br><span class="line">                top := b.tophash[i]</span><br><span class="line">                <span class="comment">// å½“å‰ä½ç½®å·²å®Œæˆè¿ç§»ï¼ŒçŠ¶æ€ç½®ä¸ºevacuatedEmpty</span></span><br><span class="line">                <span class="keyword">if</span> isEmpty(top) &#123;</span><br><span class="line">                    b.tophash[i] = evacuatedEmpty</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> top &lt; minTopHash &#123;</span><br><span class="line">                    throw(<span class="string">&quot;bad map state&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                k2 := k</span><br><span class="line">                <span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">                    k2 = *((*unsafe.Pointer)(k2))</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">var</span> useY <span class="type">uint8</span></span><br><span class="line">                <span class="keyword">if</span> !h.sameSizeGrow() &#123;</span><br><span class="line">                    hash := t.Hasher(k2, <span class="type">uintptr</span>(h.hash0))</span><br><span class="line">                    <span class="keyword">if</span> h.flags&amp;iterator != <span class="number">0</span> &amp;&amp; !t.ReflexiveKey() &amp;&amp; !t.Key.Equal(k2, k2) &#123;</span><br><span class="line">                        useY = top &amp; <span class="number">1</span></span><br><span class="line">                        top = tophash(hash)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ç¬¬n+1ä½æ˜¯å¦ç­‰äº1ï¼Œåé¢nä½è·Ÿæ—§æ¡¶ä¸€æ ·</span></span><br><span class="line">                        <span class="keyword">if</span> hash&amp;newbit != <span class="number">0</span> &#123;</span><br><span class="line">                            useY = <span class="number">1</span></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> evacuatedX+<span class="number">1</span> != evacuatedY || evacuatedX^<span class="number">1</span> != evacuatedY &#123;</span><br><span class="line">                    throw(<span class="string">&quot;bad evacuatedN&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                b.tophash[i] = evacuatedX + useY <span class="comment">// evacuatedX + 1 == evacuatedY</span></span><br><span class="line">                dst := &amp;xy[useY]                 <span class="comment">// è¿ç§»ç›®çš„åœ°</span></span><br><span class="line">                <span class="comment">// ç›®çš„æ¡¶8ä¸ªkvå¯¹æ»¡äº†</span></span><br><span class="line">                <span class="keyword">if</span> dst.i == bucketCnt &#123;</span><br><span class="line">          <span class="comment">// ç”Ÿæˆä¸€ä¸ªæ–°çš„æº¢å‡ºæ¡¶</span></span><br><span class="line">                    dst.b = h.newoverflow(t, dst.b)</span><br><span class="line">                    dst.i = <span class="number">0</span></span><br><span class="line">                    dst.k = add(unsafe.Pointer(dst.b), dataOffset)</span><br><span class="line">                    dst.e = add(dst.k, bucketCnt*<span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">                &#125;</span><br><span class="line">                dst.b.tophash[dst.i&amp;(bucketCnt<span class="number">-1</span>)] = top <span class="comment">// mask dst.i as an optimization, to avoid a bounds check</span></span><br><span class="line">                <span class="keyword">if</span> t.IndirectKey() &#123;</span><br><span class="line">                    *(*unsafe.Pointer)(dst.k) = k2 <span class="comment">// copy pointer</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    typedmemmove(t.Key, dst.k, k) <span class="comment">// copy elem</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> t.IndirectElem() &#123;</span><br><span class="line">                    *(*unsafe.Pointer)(dst.e) = *(*unsafe.Pointer)(e)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    typedmemmove(t.Elem, dst.e, e)</span><br><span class="line">                &#125;</span><br><span class="line">                dst.i++</span><br><span class="line">                dst.k = add(dst.k, <span class="type">uintptr</span>(t.KeySize))</span><br><span class="line">                dst.e = add(dst.e, <span class="type">uintptr</span>(t.ValueSize))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> h.flags&amp;oldIterator == <span class="number">0</span> &amp;&amp; t.Bucket.PtrBytes != <span class="number">0</span> &#123;</span><br><span class="line">            b := add(h.oldbuckets, oldbucket*<span class="type">uintptr</span>(t.BucketSize))</span><br><span class="line">            ptr := add(b, dataOffset)</span><br><span class="line">            n := <span class="type">uintptr</span>(t.BucketSize) - dataOffset</span><br><span class="line">            memclrHasPointers(ptr, n)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> oldbucket == h.nevacuate &#123;</span><br><span class="line">        advanceEvacuationMark(h, t, newbit)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆå¢é‡æ‰©å®¹ï¼Œæ—§æ¡¶åªä¼šå‡ºç°åœ¨æ–°æ¡¶çš„ä¸¤ä¸ªä½ç½®</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230831213704412.png" alt="image-20230831213704412"></p><p>è¿ç§»å®Œ<code>nevacuate</code>æ¡¶åï¼Œå®ƒä¼š+1ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½+1çš„è¿™ä¸ªæ¡¶ä¹‹å‰è¢«è¿ç§»è¿‡äº†ï¼Œæ‰€ä»¥éœ€è¦ç»§ç»­å¾€åæ‰¾åˆ°ä¸€ä¸ªè¿˜æœªæ²¡è¿ç§»çš„æ¡¶ï¼Œè¯¥é€»è¾‘åœ¨<code>advanceEvacuationMark</code>å‡½æ•°ä¸­ï¼š</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230831213326389.png" alt="image-20230831213326389" style="zoom:40%;" /></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">advanceEvacuationMark</span><span class="params">(h *hmap, t *maptype, newbit <span class="type">uintptr</span>)</span></span> &#123;</span><br><span class="line">    h.nevacuate++</span><br><span class="line">    <span class="comment">// å¾€åæœ€å¤šçœ‹1024ä¸ªæ¡¶</span></span><br><span class="line">    stop := h.nevacuate + <span class="number">1024</span></span><br><span class="line">    <span class="comment">// newbitæ˜¯æ—§æ¡¶çš„æ•°é‡</span></span><br><span class="line">    <span class="keyword">if</span> stop &gt; newbit &#123;</span><br><span class="line">        stop = newbit</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†nevacuateæŒ‡å‘ç¬¬ä¸€ä¸ªæœªè¿ç§»çš„æ¡¶</span></span><br><span class="line">    <span class="keyword">for</span> h.nevacuate != stop &amp;&amp; bucketEvacuated(t, h, h.nevacuate) &#123;</span><br><span class="line">        h.nevacuate++</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ‰€æœ‰æ—§æ¡¶å…¨éƒ¨è¿ç§»å®Œ</span></span><br><span class="line">    <span class="keyword">if</span> h.nevacuate == newbit &#123; <span class="comment">// newbit == # of oldbuckets</span></span><br><span class="line">    <span class="comment">// é‡Šæ”¾æ—§æ¡¶</span></span><br><span class="line">        h.oldbuckets = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">if</span> h.extra != <span class="literal">nil</span> &#123;</span><br><span class="line">            h.extra.oldoverflow = <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">// å°†è¿ç§»æ ‡å¿—æ¸…é™¤ï¼Œç»“æŸæ‰©å®¹çŠ¶æ€</span></span><br><span class="line">        h.flags &amp;^= sameSizeGrow</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>channelæºç å­¦ä¹ </title>
      <link href="/2023/08/27/channel%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
      <url>/2023/08/27/channel%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç‰¹åˆ«æé†’ï¼Œæœ¬æ–‡æ‰€æ¶‰åŠçš„æºç æ˜¯<code>go1.21.0 darwin/amd64</code></p><p>æ–‡ä»¶ä½ç½®ï¼šruntime/trace/chan.go</p></blockquote><h3 id="1-åŸºæœ¬æ•°æ®ç»“æ„"><a href="#1-åŸºæœ¬æ•°æ®ç»“æ„" class="headerlink" title="1 åŸºæœ¬æ•°æ®ç»“æ„"></a>1 åŸºæœ¬æ•°æ®ç»“æ„</h3><h4 id="1-1hchan"><a href="#1-1hchan" class="headerlink" title="1.1hchan"></a>1.1hchan</h4><p><code>Go</code>è¯­è¨€çš„<code>channel</code>åœ¨è¿è¡Œæ—¶ä½¿ç”¨<code>runtime.hchan</code>ç»“æ„ä½“æ¥è¡¨ç¤ºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hchan <span class="keyword">struct</span> &#123;</span><br><span class="line">    qcount   <span class="type">uint</span>           <span class="comment">// å·²ç»å­˜æ”¾çš„å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    dataqsiz <span class="type">uint</span>           <span class="comment">// å®¹é‡</span></span><br><span class="line">    buf      unsafe.Pointer <span class="comment">// å­˜æ”¾å…ƒç´ çš„ç¯å½¢ç¼“å†²åŒº</span></span><br><span class="line">    elemsize <span class="type">uint16</span><span class="comment">// å…ƒç´ ç±»å‹çš„å¤§å°</span></span><br><span class="line">    closed   <span class="type">uint32</span><span class="comment">// channelæ˜¯å¦å…³é—­</span></span><br><span class="line">    elemtype *_type <span class="comment">// å…ƒç´ ç±»å‹</span></span><br><span class="line">    sendx    <span class="type">uint</span>   <span class="comment">// channelå‘é€æ“ä½œå¤„ç†çš„ä½ç½®</span></span><br><span class="line">    recvx    <span class="type">uint</span>   <span class="comment">// channelæ¥æ”¶æ“ä½œå¤„ç†çš„ä½ç½®</span></span><br><span class="line">    recvq    waitq  <span class="comment">// å› æ¥æ”¶è€Œé™·å…¥é˜»å¡çš„åç¨‹é˜Ÿåˆ—ï¼Œå³ï¼ˆ &lt;-ch ï¼‰</span></span><br><span class="line">    sendq    waitq  <span class="comment">// å› å‘é€è€Œé™·å…¥é˜»å¡çš„åç¨‹é˜Ÿåˆ—ï¼Œå³ï¼ˆ ch&lt;- ï¼‰</span></span><br><span class="line"></span><br><span class="line">    lock mutex</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-2-waitq"><a href="#1-2-waitq" class="headerlink" title="1.2 waitq"></a>1.2 waitq</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é˜»å¡çš„åç¨‹é˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨</span></span><br><span class="line"><span class="keyword">type</span> waitq <span class="keyword">struct</span> &#123;</span><br><span class="line">    first *sudog<span class="comment">// è¡¨å¤´</span></span><br><span class="line">    last  *sudog<span class="comment">// è¡¨å°¾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="1-3-sudog"><a href="#1-3-sudog" class="headerlink" title="1.3 sudog"></a>1.3 sudog</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> sudog <span class="keyword">struct</span> &#123;</span><br><span class="line">    g *g</span><br><span class="line">    next *sudog</span><br><span class="line">    prev *sudog</span><br><span class="line">    elem unsafe.Pointer <span class="comment">// æŒ‡å‘æ•°æ®å…ƒç´  (å¯èƒ½æŒ‡å‘æ ˆ)</span></span><br><span class="line">    acquiretime <span class="type">int64</span></span><br><span class="line">    releasetime <span class="type">int64</span></span><br><span class="line">    ticket      <span class="type">uint32</span></span><br><span class="line">    isSelect <span class="type">bool</span></span><br><span class="line">    success  <span class="type">bool</span></span><br><span class="line">    parent   *sudog <span class="comment">// semaRoot äºŒå‰æ ‘</span></span><br><span class="line">    waitlink *sudog <span class="comment">// g.waiting list or semaRoot</span></span><br><span class="line">    waittail *sudog <span class="comment">// semaRoot</span></span><br><span class="line">    c        *hchan <span class="comment">// channel</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>sudogï¼šå¯¹<code>goroutine</code>çš„å°è£…ï¼Œè¡¨ç¤ºä¸€ä¸ªåœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­çš„<code>g</code></p></li><li><p>gï¼šåç¨‹</p></li><li>nextï¼šé“¾è¡¨çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li><li>prevï¼šé“¾è¡¨çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</li><li>elemï¼šæŒ‡å‘æ•°æ®</li><li>isSelectï¼šè¡¨ç¤º<code>g</code>æ˜¯å¦è¢«é€‰æ‹©</li><li>successï¼šè¡¨ç¤º<code>channel</code>c ä¸Šçš„é€šä¿¡æ˜¯å¦æˆåŠŸ</li></ul><p>ç›´æ¥çœ‹æ•°æ®ç»“æ„çš„å®šä¹‰ï¼Œå¯èƒ½ä¼šæœ‰ç‚¹ä¸ç†è§£ï¼Œä¸‹é¢é€šè¿‡å›¾æ¥è¾…åŠ©ç†è§£</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230825143137015.png" alt="image-20230825143137015"></p><blockquote><p>å›¾ç‰‡æ¥æº:<a href="https://halfrost.com/go_channel/#toc-6">https://halfrost.com/go_channel/#toc-6</a></p></blockquote><p>å…¶ä¸­<code>sendx</code>å¯èƒ½æŒ‡å‘çš„æ˜¯<code>5</code>è¾¹ä¸Šé‚£å—è¿˜æ²¡æœ‰æ•°æ®çš„åŒºåŸŸï¼Œå³å¦‚æœæ‰§è¡Œ ch &lt;- data$ï¼Œé‚£ä¹ˆ<code>data</code>å°†è¢«å­˜å‚¨åˆ°è¿™å—åŒºåŸŸã€‚</p><p>åŒç†<code>recvx</code>æŒ‡å‘çš„æ˜¯<code>0</code>ï¼Œå¦‚æœæ‰§è¡Œ<code>&lt;-ch</code>é¦–å…ˆä¼šå¾—åˆ° 0ï¼Œç„¶å<code>recvx</code>ä¼šæŒ‡å‘ä¸‹ä¸€ä¸ª</p><p>å¦‚æœ<code>buf</code>ä¸­å­˜æ”¾çš„å…ƒç´ å·²ç»è¾¾åˆ°å®¹é‡ï¼Œæ­¤æ—¶è¿˜æœ‰<code>g</code>åœ¨æ‰§è¡Œå‘é€æ“ä½œç»™<code>ch</code>çš„è¯ï¼Œå³<code>ch&lt;-data</code>åˆ™ä¼šè¢«æ·»åŠ åˆ°<code>sendq</code>é˜Ÿåˆ—ä¸­å»ï¼Œç›´åˆ°é€šé“ä¸­çš„å…ƒç´ ä¸å†æ˜¯æ»¡çš„ã€‚</p><p>åŒç†<code>buf</code>æ˜¯ç©ºçš„ï¼Œ æ­¤æ—¶è¿˜æœ‰<code>g</code>åœ¨æ‰§è¡Œæ¥æ”¶æ“ä½œçš„è¯ï¼Œå³<code>&lt;-ch</code>åˆ™ä¼šè¢«æ·»åŠ åˆ°<code>recvq</code>é˜Ÿåˆ—ä¸­å»ï¼Œç›´åˆ°é€šé“ä¸­æœ‰å…ƒç´ ã€‚</p><h3 id="2-åˆ›å»º-channel"><a href="#2-åˆ›å»º-channel" class="headerlink" title="2 åˆ›å»º channel"></a>2 åˆ›å»º channel</h3><p>åˆ›å»º<code>channel</code>çš„å‡½æ•°æœ‰ä¸¤ä¸ªï¼ŒåŸå‹å¦‚ä¸‹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan64</span><span class="params">(t *chantype, size <span class="type">int64</span>)</span></span> *hchan</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan</span><span class="params">(t *chantype, size <span class="type">int</span>)</span></span> *hchan</span><br></pre></td></tr></table></figure><p><code>makechan64</code>æ–¹æ³•åªæ˜¯åˆ¤æ–­ä¸€ä¸‹ä¼ å…¥çš„<code>size</code>æ˜¯å¦åœ¨<code>int32</code>èŒƒå›´å†…</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan64</span><span class="params">(t *chantype, size <span class="type">int64</span>)</span></span> *hchan &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="type">int64</span>(<span class="type">int</span>(size)) != size &#123;</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;makechan: size out of range&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> makechan(t, <span class="type">int</span>(size))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦çš„å®ç°è¿˜æ˜¯åœ¨<code>makechan</code>ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makechan</span><span class="params">(t *chantype, size <span class="type">int</span>)</span></span> *hchan &#123;</span><br><span class="line">    elem := t.Elem</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç¼–è¯‘å™¨æ£€æŸ¥å•ä¸ªå…ƒç´ çš„å¤§å°ä¸èƒ½è¶…è¿‡64KB</span></span><br><span class="line">    <span class="keyword">if</span> elem.Size_ &gt;= <span class="number">1</span>&lt;&lt;<span class="number">16</span> &#123;</span><br><span class="line">        throw(<span class="string">&quot;makechan: invalid channel element type&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">// æ£€æŸ¥æ˜¯å¦å¯¹é½</span></span><br><span class="line">    <span class="keyword">if</span> hchanSize%maxAlign != <span class="number">0</span> || elem.Align_ &gt; maxAlign &#123;</span><br><span class="line">        throw(<span class="string">&quot;makechan: bad alignment&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¼“å†²åŒºå¤§å°æ£€æŸ¥ï¼Œåˆ¤æ–­æ˜¯å¦æº¢å‡º</span></span><br><span class="line">    mem, overflow := math.MulUintptr(elem.Size_, <span class="type">uintptr</span>(size))</span><br><span class="line">    <span class="keyword">if</span> overflow || mem &gt; maxAlloc-hchanSize || size &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;makechan: size out of range&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> c *hchan</span><br><span class="line">    <span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> mem == <span class="number">0</span>:</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—æˆ–è€…å…ƒç´ å¤§å°ä¸º0æ—¶</span></span><br><span class="line">        c = (*hchan)(mallocgc(hchanSize, <span class="literal">nil</span>, <span class="literal">true</span>))</span><br><span class="line">        <span class="comment">// Rac ç«äº‰æ£€æŸ¥ä½¿ç”¨è¿™ä¸ªåœ°å€è¿›è¡ŒåŒæ­¥æ“ä½œ</span></span><br><span class="line">        c.buf = c.raceaddr()</span><br><span class="line">    <span class="keyword">case</span> elem.PtrBytes == <span class="number">0</span>:</span><br><span class="line">        <span class="comment">// å…ƒç´ ä¸åŒ…å«æŒ‡é’ˆæ—¶ï¼Œä¸€æ¬¡æ€§åˆ†é…hchanå’Œbufçš„å†…å­˜</span></span><br><span class="line">        c = (*hchan)(mallocgc(hchanSize+mem, <span class="literal">nil</span>, <span class="literal">true</span>))</span><br><span class="line">        c.buf = add(unsafe.Pointer(c), hchanSize)</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// å…ƒç´ åŒ…å«æŒ‡é’ˆæ—¶,åˆ™åˆ†åˆ«ç”³è¯·hchanå’Œbufçš„ç©ºé—´ï¼Œä¸¤è€…æ— éœ€è¿ç»­</span></span><br><span class="line">        c = <span class="built_in">new</span>(hchan)</span><br><span class="line">        c.buf = mallocgc(mem, elem, <span class="literal">true</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†å…¶ä½™å­—æ®µèµ‹åˆå§‹å€¼</span></span><br><span class="line">    c.elemsize = <span class="type">uint16</span>(elem.Size_)</span><br><span class="line">    c.elemtype = elem</span><br><span class="line">    c.dataqsiz = <span class="type">uint</span>(size)</span><br><span class="line">    lockInit(&amp;c.lock, lockRankHchan)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> debugChan &#123;</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;makechan: chan=&quot;</span>, c, <span class="string">&quot;; elemsize=&quot;</span>, elem.Size_, <span class="string">&quot;; dataqsiz=&quot;</span>, size, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-å‘é€æ•°æ®"><a href="#3-å‘é€æ•°æ®" class="headerlink" title="3 å‘é€æ•°æ®"></a>3 å‘é€æ•°æ®</h3><p>å‘é€æ•°æ®çš„æ“ä½œæœ‰ä¸¤ä¸ªå‡½æ•°<code>chansend1()</code>å’Œ<code>chansend()</code>ï¼Œä¸è¿‡å®ç°é€»è¾‘éƒ½åœ¨åè€…ï¼Œæ‰€ä»¥ç›´æ¥çœ‹å®ƒæ€ä¹ˆå®ç°çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">chansend</span><span class="params">(c *hchan, ep unsafe.Pointer, block <span class="type">bool</span>, callerpc <span class="type">uintptr</span>)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­ channel æ˜¯å¦ä¸ºnil</span></span><br><span class="line">    <span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> !block &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonChanSendNilChan, traceBlockForever, <span class="number">2</span>)</span><br><span class="line">        throw(<span class="string">&quot;unreachable&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">  lock(&amp;c.lock)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;send on closed channel&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é¦–å…ˆå¯¹<code>channel</code>è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå·²ç»è¢«<code>GC</code>å›æ”¶ï¼Œå¾€ä¸€ä¸ª<code>nil</code>çš„é€šé“å‘é€æ•°æ®ä¼šå‘é€é˜»å¡ã€‚<code>gopark</code>ä¼šå¼•å‘ä»¥ waitReasonChanSendNilChan ä¸ºåŸå› çš„ä¼‘çœ ï¼Œå¹¶æŠ›å‡ºä¸€ä¸ª<code>unreachable</code>çš„é”™è¯¯ã€‚</li><li>å…¶æ¬¡å‘å·²ç»å…³é—­çš„<code>channel</code>å‘é€æ•°æ®æ—¶ä¼šæŠ¥â€send on closed channelâ€çš„é”™è¯¯</li></ul><p>ä¸‹é¢å°†å‘é€è¿‡ç¨‹åˆ†ä¸ºä¸‰ç§æƒ…å†µ</p><h4 id="3-1-å†™æ—¶å­˜åœ¨é˜»å¡çš„è¯»åç¨‹â€”â€”ç›´æ¥å‘é€"><a href="#3-1-å†™æ—¶å­˜åœ¨é˜»å¡çš„è¯»åç¨‹â€”â€”ç›´æ¥å‘é€" class="headerlink" title="3.1 å†™æ—¶å­˜åœ¨é˜»å¡çš„è¯»åç¨‹â€”â€”ç›´æ¥å‘é€"></a>3.1 å†™æ—¶å­˜åœ¨é˜»å¡çš„è¯»åç¨‹â€”â€”ç›´æ¥å‘é€</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> sg := c.recvq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">        send(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå­˜åœ¨é˜»å¡çš„è¯»åç¨‹æ—¶ï¼Œä¼šç›´æ¥ä»<code>recvq</code>ä¸­å–å‡ºæœ€å…ˆé™·å…¥ç­‰å¾…ï¼ˆéµå¾ª FIFO åŸåˆ™ï¼‰çš„<code>Goroutine</code>å¹¶ç›´æ¥å‘å®ƒå‘é€æ•°æ®ï¼Œç»•è¿‡ç¼“å†²åŒº</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230825220928571.png" alt="image-20230825220928571" style="zoom:33%;" /></p><p>å‘é€æ—¶çš„å…·ä½“çš„æ‰§è¡Œé€»è¾‘ç”±<code>send()</code>å‡½æ•°æ¥å®Œæˆï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">send</span><span class="params">(c *hchan, sg *sudog, ep unsafe.Pointer, unlockf <span class="keyword">func</span>()</span></span>, skip <span class="type">int</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> sg.elem != <span class="literal">nil</span> &#123;</span><br><span class="line">        sendDirect(c.elemtype, sg, ep)</span><br><span class="line">        sg.elem = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    gp := sg.g</span><br><span class="line">    unlockf()</span><br><span class="line">    gp.param = unsafe.Pointer(sg)</span><br><span class="line">    sg.success = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">        sg.releasetime = cputicks()</span><br><span class="line">    &#125;</span><br><span class="line">    goready(gp, skip+<span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>send()</code>å‡½æ•°ä¸»è¦å®Œæˆäº† 2 ä»¶äº‹æƒ…ï¼š</p><ol><li>è°ƒç”¨<code>sendDirect()</code>å‡½æ•°å°†å‘é€çš„æ•°æ®ç›´æ¥æ‹·è´åˆ°<code>x = &lt;-ch</code>è¡¨è¾¾å¼ä¸­å˜é‡<code>x</code>æ‰€åœ¨çš„å†…å­˜åœ°å€ä¸Šï¼Œä½¿ç”¨çš„æ˜¯<code>memmove()</code>å‡½æ•°ã€‚</li><li>è°ƒç”¨<code>goready()</code>å°†ç­‰å¾…æ¥æ”¶çš„<code>g</code>çš„çŠ¶æ€ä»<code>Gwaiting</code>æˆ–è€…<code>Gscanwaiting</code>å˜æˆ<code>Grunnable</code>ï¼Œå¹¶æŠŠè¯¥<code>g</code>æ”¾åˆ°<code>runnext</code>ä¸­ï¼Œå¤„ç†å™¨åœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶ä¼šç«‹å³è¿è¡Œå®ƒï¼Œå…·ä½“é€»è¾‘å¯ä»¥çœ‹<code>runqput()</code>å‡½æ•°çš„ä»£ç ã€‚éœ€è¦æ³¨æ„æ˜¯ï¼Œ<strong>å‘é€æ•°æ®çš„è¿‡ç¨‹å¹¶æ²¡æœ‰ç«‹å³æ‰§è¡Œæ¥æ”¶å‘çš„<code>g</code>ï¼Œåªæ˜¯å°†<code>g</code>æ”¾åˆ°<code>runnext</code>ä¸­ï¼Œä¸‹ä¸€æ¬¡è°ƒåº¦çš„æ—¶å€™å†æ‰§è¡Œã€‚</strong></li></ol><h4 id="3-2-channel-å¸¦æœ‰ç¼“å†²åŒºï¼Œç©ºé—´è¿˜æœªæ»¡å¹¶ä¸”ä¸å­˜åœ¨é˜»å¡çš„è¯»åç¨‹"><a href="#3-2-channel-å¸¦æœ‰ç¼“å†²åŒºï¼Œç©ºé—´è¿˜æœªæ»¡å¹¶ä¸”ä¸å­˜åœ¨é˜»å¡çš„è¯»åç¨‹" class="headerlink" title="3.2 channel å¸¦æœ‰ç¼“å†²åŒºï¼Œç©ºé—´è¿˜æœªæ»¡å¹¶ä¸”ä¸å­˜åœ¨é˜»å¡çš„è¯»åç¨‹"></a>3.2 channel å¸¦æœ‰ç¼“å†²åŒºï¼Œç©ºé—´è¿˜æœªæ»¡å¹¶ä¸”ä¸å­˜åœ¨é˜»å¡çš„è¯»åç¨‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> c.qcount &lt; c.dataqsiz &#123;</span><br><span class="line">        qp := chanbuf(c, c.sendx)</span><br><span class="line">        <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">            racenotify(c, c.sendx, <span class="literal">nil</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        typedmemmove(c.elemtype, qp, ep)</span><br><span class="line">        c.sendx++</span><br><span class="line">        <span class="keyword">if</span> c.sendx == c.dataqsiz &#123;</span><br><span class="line">            c.sendx = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        c.qcount++</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>qcount</code>è¿˜æ²¡æœ‰æ»¡ï¼Œåˆ™è°ƒç”¨<code>chanbuf()</code> è·å– <code>sendx</code> ç´¢å¼•çš„å…ƒç´ æŒ‡é’ˆå€¼ã€‚è°ƒç”¨ <code>typedmemmove()</code> æ–¹æ³•å°†å‘é€çš„å€¼æ‹·è´åˆ°ç¼“å†²åŒº <code>buf</code> ä¸­ã€‚æ‹·è´å®Œæˆï¼Œéœ€è¦ç»´æŠ¤ <code>sendx</code>ç´¢å¼•ä¸‹æ ‡å€¼å’Œ<code>qcount</code> ä¸ªæ•°ã€‚è¿™é‡Œå°† <code>buf</code> ç¼“å†²åŒºè®¾è®¡æˆç¯å½¢çš„ï¼Œç´¢å¼•å€¼å¦‚æœåˆ°äº†é˜Ÿå°¾ï¼Œä¸‹ä¸€ä¸ªä½ç½®é‡æ–°å›åˆ°é˜Ÿå¤´ã€‚</p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826133707785.png" alt="image-20230826133707785" style="zoom:50%;" /></p><blockquote><p>å›¾ç‰‡æ¥æºï¼š<a href="https://halfrost.com/go_channel/#toc-10">https://halfrost.com/go_channel/#toc-10</a></p></blockquote><h4 id="3-3-channel-å¸¦æœ‰ç¼“å†²åŒºï¼Œç©ºé—´å·²æ»¡å¹¶ä¸”ä¸å­˜åœ¨é˜»å¡çš„è¯»åç¨‹"><a href="#3-3-channel-å¸¦æœ‰ç¼“å†²åŒºï¼Œç©ºé—´å·²æ»¡å¹¶ä¸”ä¸å­˜åœ¨é˜»å¡çš„è¯»åç¨‹" class="headerlink" title="3.3 channel å¸¦æœ‰ç¼“å†²åŒºï¼Œç©ºé—´å·²æ»¡å¹¶ä¸”ä¸å­˜åœ¨é˜»å¡çš„è¯»åç¨‹"></a>3.3 channel å¸¦æœ‰ç¼“å†²åŒºï¼Œç©ºé—´å·²æ»¡å¹¶ä¸”ä¸å­˜åœ¨é˜»å¡çš„è¯»åç¨‹</h4><p>è¿™æ—¶å‘<code>channel</code>å‘é€æ•°æ®ä¼šè¿›å…¥é˜»å¡çŠ¶æ€</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gp := getg()</span><br><span class="line">mysg := acquireSudog()</span><br><span class="line">mysg.releasetime = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">    mysg.releasetime = <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line">mysg.elem = ep</span><br><span class="line">mysg.waitlink = <span class="literal">nil</span></span><br><span class="line">mysg.g = gp</span><br><span class="line">mysg.isSelect = <span class="literal">false</span></span><br><span class="line">mysg.c = c</span><br><span class="line">gp.waiting = mysg</span><br><span class="line">gp.param = <span class="literal">nil</span></span><br><span class="line">c.sendq.enqueue(mysg)</span><br><span class="line">gp.parkingOnChan.Store(<span class="literal">true</span>)</span><br><span class="line">gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanSend, traceBlockChanSend, <span class="number">2</span>)</span><br><span class="line">KeepAlive(ep)</span><br></pre></td></tr></table></figure><ul><li>è°ƒç”¨<code>getg()</code>æ–¹æ³•è·å–å½“å‰<code>g</code>çš„æŒ‡é’ˆï¼Œç»‘å®šåˆ°ä¸€ä¸ª<code>sudog</code>ä¸Š</li><li><p>è°ƒç”¨<code>acquireSudog()</code>æ–¹æ³•è·å–ä¸€ä¸ª<code>sudog</code></p></li><li><p>è°ƒç”¨<code>c.sendq.enqueue()</code>æ–¹æ³•å°†é…ç½®å¥½çš„<code>sudog</code>åŠ å…¥é˜Ÿåˆ—</p></li><li>è°ƒç”¨<code>gopark()</code>æŒ‚èµ·å½“å‰<code>g</code>ï¼ŒçŠ¶æ€ä¸º<code>waitReasonChanSend</code>ï¼Œé˜»å¡ç­‰å¾…<code>channel</code>å‘é€</li><li>è°ƒç”¨<code>KeepAlive()</code>ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œç­‰å¾…å…¶å®ƒåç¨‹å–èµ°å…ƒç´ </li></ul><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826135153228.png" alt="image-20230826135153228" style="zoom:50%;" /></p><blockquote><p>å›¾ç‰‡æ¥æºï¼š<a href="https://halfrost.com/go_channel/#toc-10">https://halfrost.com/go_channel/#toc-10</a></p></blockquote><h3 id="4-æ¥æ”¶æ•°æ®"><a href="#4-æ¥æ”¶æ•°æ®" class="headerlink" title="4 æ¥æ”¶æ•°æ®"></a>4 æ¥æ”¶æ•°æ®</h3><p>æ¥æ”¶æ•°æ®çš„å®ç°æ˜¯åœ¨<code>chanrecv()</code>å‡½æ•°ä¸‹å®ç°çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»ä¸€ä¸ªä¸ºnilçš„é€šé“ä¸­æ¥æ”¶æ•°æ®ä¼šå‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> !block &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    gopark(<span class="literal">nil</span>, <span class="literal">nil</span>, waitReasonChanReceiveNilChan, traceBlockForever, <span class="number">2</span>)</span><br><span class="line">    throw(<span class="string">&quot;unreachable&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€šé“å·²ç»å…³é—­ä¸”ä¸å­˜åœ¨ç¼“å­˜æ•°æ®ä¹Ÿä¼šå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c.qcount == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">            raceacquire(c.raceaddr())</span><br><span class="line">        &#125;</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">            typedmemclr(c.elemtype, ep)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1-è¯»æ—¶å­˜åœ¨é˜»å¡çš„å†™åç¨‹"><a href="#4-1-è¯»æ—¶å­˜åœ¨é˜»å¡çš„å†™åç¨‹" class="headerlink" title="4.1 è¯»æ—¶å­˜åœ¨é˜»å¡çš„å†™åç¨‹"></a>4.1 è¯»æ—¶å­˜åœ¨é˜»å¡çš„å†™åç¨‹</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> sg := c.sendq.dequeue(); sg != <span class="literal">nil</span> &#123;</span><br><span class="line">        recv(c, sg, ep, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; unlock(&amp;c.lock) &#125;, <span class="number">3</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>ä»é˜»å¡çš„<code>sendq</code>ä¸­è·å–å¤´éƒ¨çš„<code>g</code></li><li>å¦‚æœç¼“å†²åŒºå¤§å°ä¸º 0ï¼Œåˆ™ç›´æ¥è¯»å–å†™åç¨‹å…ƒç´ ï¼Œå¹¶å”¤é†’å®ƒï¼Œè¿™ç§æƒ…å†µåªä¼šå‘ç”Ÿä¸€æ¬¡<code>copy</code>æ“ä½œå³å°†é˜»å¡çš„<code>g</code>æ‰€ä¿å­˜çš„å…ƒç´ å¤åˆ¶åˆ°<code>read</code></li></ul><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826151104338.png" alt="image-20230826151104338" style="zoom:50%;" /></p><ul><li>å¦‚æœæœ‰ç¼“å†²åŒºï¼Œåˆ™è¯»å–å¤´éƒ¨å…ƒç´ ï¼Œå¹¶å°†å¤„äºç­‰å¾…å‘é€çš„<code>g</code>çš„å…ƒç´ å†™å…¥ç¼“å†²åŒºçš„å°¾éƒ¨ï¼ˆå³åˆšåˆšè¯»å–çš„ä½ç½®ï¼Œå› ä¸ºæ˜¯ç¯å½¢çš„ï¼‰ï¼Œè¿™ç§æƒ…å†µä¼šå‘é€ä¸¤æ¬¡<code>copy</code>æ“ä½œï¼Œå…ˆå°†ç¼“å†²åŒº<code>recvx</code>å¤„çš„å…ƒç´ æ‹·è´åˆ°<code>read</code>ï¼Œç„¶åå°†é˜»å¡çš„<code>g</code>çš„å…ƒç´ æ‹·è´åˆ°<code>sendx</code>æ‰€å¤„çš„åœ°å€ã€‚</li></ul><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826150504865.png" alt="image-20230826150504865" style="zoom:40%;" /></p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826151355877.png" alt="image-20230826151355877" style="zoom:40%;" /></p><blockquote><p>å›¾ç‰‡æ¥æºï¼š<a href="https://halfrost.com/go_channel/#toc-16">https://halfrost.com/go_channel/#toc-16</a></p></blockquote><h4 id="4-2-è¯»å–æ—¶æ— é˜»å¡çš„å†™åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ "><a href="#4-2-è¯»å–æ—¶æ— é˜»å¡çš„å†™åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ " class="headerlink" title="4.2 è¯»å–æ—¶æ— é˜»å¡çš„å†™åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ "></a>4.2 è¯»å–æ—¶æ— é˜»å¡çš„å†™åç¨‹ä¸”ç¼“å†²åŒºæœ‰å…ƒç´ </h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> c.qcount &gt; <span class="number">0</span> &#123;</span><br><span class="line">        qp := chanbuf(c, c.recvx)</span><br><span class="line">        <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">            racenotify(c, c.recvx, <span class="literal">nil</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ep != <span class="literal">nil</span> &#123;</span><br><span class="line">            typedmemmove(c.elemtype, ep, qp)</span><br><span class="line">        &#125;</span><br><span class="line">        typedmemclr(c.elemtype, qp)</span><br><span class="line">        c.recvx++</span><br><span class="line">        <span class="keyword">if</span> c.recvx == c.dataqsiz &#123;</span><br><span class="line">            c.recvx = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        c.qcount--</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>ç›´æ¥å°†<code>recvx</code>å¤„çš„å…ƒç´ æ‹·è´ç»™<code>read</code>ï¼Œç„¶åå°†å¯¹åº”çš„å±æ€§æ“ä½œï¼Œ<code>qcount</code>å‡ 1ï¼Œ<code>recvx</code>++ï¼Œå¦‚æœç­‰äºå®¹é‡ï¼Œåˆ™å½’ 0ï¼Œå¯ä»¥ç†è§£ä¸ºå–æ¨¡æ“ä½œ<code>(recvx++)%qcount</code></p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826151746532.png" alt="image-20230826151746532" style="zoom:40%;" /></p><h4 id="4-3-è¯»æ—¶æ²¡æœ‰é˜»å¡çš„å†™åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ "><a href="#4-3-è¯»æ—¶æ²¡æœ‰é˜»å¡çš„å†™åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ " class="headerlink" title="4.3 è¯»æ—¶æ²¡æœ‰é˜»å¡çš„å†™åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ "></a>4.3 è¯»æ—¶æ²¡æœ‰é˜»å¡çš„å†™åç¨‹ä¸”ç¼“å†²åŒºæ— å…ƒç´ </h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gp := getg()</span><br><span class="line">mysg := acquireSudog()</span><br><span class="line">mysg.releasetime = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> t0 != <span class="number">0</span> &#123;</span><br><span class="line">    mysg.releasetime = <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line">mysg.elem = ep</span><br><span class="line">mysg.waitlink = <span class="literal">nil</span></span><br><span class="line">gp.waiting = mysg</span><br><span class="line">mysg.g = gp</span><br><span class="line">mysg.isSelect = <span class="literal">false</span></span><br><span class="line">mysg.c = c</span><br><span class="line">gp.param = <span class="literal">nil</span></span><br><span class="line">c.recvq.enqueue(mysg)</span><br><span class="line">gp.parkingOnChan.Store(<span class="literal">true</span>)</span><br><span class="line">gopark(chanparkcommit, unsafe.Pointer(&amp;c.lock), waitReasonChanReceive, traceBlockChanRecv, <span class="number">2</span>)</span><br></pre></td></tr></table></figure><ul><li>è°ƒç”¨<code>getg()</code>æ–¹æ³•è·å–å½“å‰<code>g</code>çš„æŒ‡é’ˆï¼Œç»‘å®šåˆ°ä¸€ä¸ª<code>sudog</code>ä¸Š</li><li><p>è°ƒç”¨<code>acquireSudog()</code>æ–¹æ³•è·å–ä¸€ä¸ª<code>sudog</code></p></li><li><p>è°ƒç”¨<code>c.recvq.enqueue()</code>æ–¹æ³•å°†é…ç½®å¥½çš„<code>sudog</code>åŠ å…¥é˜Ÿåˆ—</p></li><li>è°ƒç”¨<code>gopark()</code>æŒ‚èµ·å½“å‰<code>g</code>ï¼ŒçŠ¶æ€ä¸º<code>waitReasonChanReceive</code>ï¼Œé˜»å¡ç­‰å¾…<code>channel</code>æ¥æ”¶</li></ul><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826152412808.png" alt="image-20230826152412808" style="zoom:50%;" /></p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826152442123.png" alt="image-20230826152442123" style="zoom:40%;" /></p><blockquote><p>å›¾ç‰‡æ¥æº<a href="https://halfrost.com/go_channel/#toc-16">https://halfrost.com/go_channel/#toc-16</a></p></blockquote><h3 id="5-å…³é—­-Channel"><a href="#5-å…³é—­-Channel" class="headerlink" title="5 å…³é—­ Channel"></a>5 å…³é—­ Channel</h3><p>å…³é—­é€šé“çš„å®ç°åœ¨<code>closechan()</code>å‡½æ•°ä¸­:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> c == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;close of nil channel&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lock(&amp;c.lock)</span><br><span class="line">    <span class="keyword">if</span> c.closed != <span class="number">0</span> &#123;</span><br><span class="line">        unlock(&amp;c.lock)</span><br><span class="line">        <span class="built_in">panic</span>(plainError(<span class="string">&quot;close of closed channel&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">        callerpc := getcallerpc()</span><br><span class="line">        racewritepc(c.raceaddr(), callerpc, abi.FuncPCABIInternal(closechan))</span><br><span class="line">        racerelease(c.raceaddr())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.closed = <span class="number">1</span></span><br></pre></td></tr></table></figure><p>å½“å…³é—­<code>channel</code>æ˜¯<code>nil</code>æˆ–è€…æ˜¯ä¸€ä¸ªå·²ç»å…³é—­çš„<code>channel</code>æ—¶ï¼Œä¼šç›´æ¥<code>panic</code>ï¼Œå½“ä¸å­˜åœ¨è¿™ä¸¤ç§æƒ…å†µçš„æ—¶å€™ï¼Œæ ‡è®°<code>channel</code>çŠ¶æ€ä¸º<code>close</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> glist gList</span><br><span class="line"><span class="comment">// release all readers</span></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    sg := c.recvq.dequeue()</span><br><span class="line">    <span class="keyword">if</span> sg == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sg.elem != <span class="literal">nil</span> &#123;</span><br><span class="line">        typedmemclr(c.elemtype, sg.elem)</span><br><span class="line">        sg.elem = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">        sg.releasetime = cputicks()</span><br><span class="line">    &#125;</span><br><span class="line">    gp := sg.g</span><br><span class="line">    gp.param = unsafe.Pointer(sg)</span><br><span class="line">    sg.success = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">        raceacquireg(gp, c.raceaddr())</span><br><span class="line">    &#125;</span><br><span class="line">    glist.push(gp)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†<code>recvq</code>é˜Ÿåˆ—ä¸­çš„<code>sudog</code>åŠ å…¥åˆ°å¾…æ¸…é™¤çš„é˜Ÿåˆ—<code>glist</code>ä¸­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// release all writers (they will panic)</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        sg := c.sendq.dequeue()</span><br><span class="line">        <span class="keyword">if</span> sg == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        sg.elem = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">if</span> sg.releasetime != <span class="number">0</span> &#123;</span><br><span class="line">            sg.releasetime = cputicks()</span><br><span class="line">        &#125;</span><br><span class="line">        gp := sg.g</span><br><span class="line">        gp.param = unsafe.Pointer(sg)</span><br><span class="line">        sg.success = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">if</span> raceenabled &#123;</span><br><span class="line">            raceacquireg(gp, c.raceaddr())</span><br><span class="line">        &#125;</span><br><span class="line">        glist.push(gp)</span><br><span class="line">    &#125;</span><br><span class="line">    unlock(&amp;c.lock)</span><br></pre></td></tr></table></figure><p>å°†<code>sendq</code>é˜Ÿåˆ—ä¸­çš„<code>sudog</code>åŠ å…¥åˆ°å¾…æ¸…é™¤çš„é˜Ÿåˆ—<code>glist</code>ä¸­ï¼Œè¿™é‡Œå¯èƒ½ä¼šäº§ç”Ÿ<code>panic</code></p><p><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230826153540944.png" alt="image-20230826153540944"></p><blockquote><p>å›¾ç‰‡æ¥æºï¼š<a href="https://halfrost.com/go_channel/#toc-16">https://halfrost.com/go_channel/#toc-16</a></p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> !glist.empty() &#123;</span><br><span class="line">    gp := glist.pop()</span><br><span class="line">    gp.schedlink = <span class="number">0</span></span><br><span class="line">    goready(gp, <span class="number">3</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¼šä¸ºæ‰€æœ‰è¢«é˜»å¡çš„ <code>g</code> è°ƒç”¨<code>goready</code> è§¦å‘è°ƒåº¦ã€‚å°†æ‰€æœ‰<code>glist</code>ä¸­çš„<code>g</code> çŠ¶æ€ä»<code>_Gwaiting</code>è®¾ç½®ä¸º <code>_Grunnable</code>çŠ¶æ€ï¼Œç­‰å¾…è°ƒåº¦å™¨çš„è°ƒåº¦ã€‚</p><h3 id="6-çŠ¶æ€æ€»ç»“"><a href="#6-çŠ¶æ€æ€»ç»“" class="headerlink" title="6 çŠ¶æ€æ€»ç»“"></a>6 çŠ¶æ€æ€»ç»“</h3><div class="table-container"><table><thead><tr><th>chan state</th><th>nil</th><th>open</th><th>closed</th></tr></thead><tbody><tr><td>send</td><td>blocked</td><td>allowed</td><td>panic</td></tr><tr><td>receive</td><td>blocked</td><td>allowed</td><td>allowed</td></tr></tbody></table></div><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul><li><a href="https://speakerdeck.com/kavya719/understanding-channels?slide=32">kavyaâ€™s Understanding Channels</a></li><li><a href="https://halfrost.com/go_channel/#toc-0">https://halfrost.com/go_channel/#toc-0</a></li><li><a href="https://mp.weixin.qq.com/s/QgNndPgN1kqxWh-ijSofkw">https://mp.weixin.qq.com/s/QgNndPgN1kqxWh-ijSofkw</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>contextæºç å­¦ä¹ </title>
      <link href="/2023/08/23/Context%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
      <url>/2023/08/23/Context%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç‰¹åˆ«æé†’ï¼Œæœ¬æ–‡æ‰€æ¶‰åŠçš„æºç æ˜¯<code>go1.21.0 darwin/amd64</code></p></blockquote><h3 id="1-ä»€ä¹ˆæ˜¯Context"><a href="#1-ä»€ä¹ˆæ˜¯Context" class="headerlink" title="1. ä»€ä¹ˆæ˜¯Context"></a>1. ä»€ä¹ˆæ˜¯Context</h3><p>åœ¨å¤šä¸ªgoroutineä¹‹é—´ä¼ é€’ä¸Šä¸‹æ–‡çš„å¯¹è±¡ï¼Œä¼ é€’çš„ä¿¡æ¯åŒ…æ‹¬å–æ¶ˆä¿¡å·ã€æˆªæ­¢æ—¶é—´ä»¥åŠå…¶ä»–ä¸€äº›è·¨apiè¾¹ç•Œçš„å€¼</p><h3 id="2-æ ¸å¿ƒæ•°æ®ç»“æ„"><a href="#2-æ ¸å¿ƒæ•°æ®ç»“æ„" class="headerlink" title="2. æ ¸å¿ƒæ•°æ®ç»“æ„"></a>2. æ ¸å¿ƒæ•°æ®ç»“æ„</h3><h4 id="2-1-Context"><a href="#2-1-Context" class="headerlink" title="2.1 Context"></a>2.1 Context</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">    Deadline() (deadline time.Time, ok <span class="type">bool</span>)</span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    Err() <span class="type">error</span></span><br><span class="line">    Value(key any) any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Context</code>å®šä¹‰ä¸º<code>Interface</code>ï¼Œå®šä¹‰äº†4ä¸ªæ ¸å¿ƒå‡½æ•°ï¼š</p><ul><li>Dealineï¼šè¿”å›<code>context</code>çš„è¿‡æœŸæ—¶é—´å’Œä¸€ä¸ª<code>bool</code>å€¼åˆ¤æ–­æ˜¯å¦è®¾ç½®äº†deadline</li><li>Doneï¼šè¿”å›<code>context</code>ä¸­çš„<code>channel</code>ï¼Œè¯¥<code>channel</code>ä¼šåœ¨å½“å‰å·¥ä½œå®Œæˆæˆ–è€…ä¸Šä¸‹æ–‡è¢«å–æ¶ˆåå…³é—­ï¼Œå¤šæ¬¡è°ƒç”¨è¿”å›çš„æ˜¯åŒä¸€ä¸ª<code>channel</code>ï¼Œå¦‚æœè¯¥<code>context</code>æ˜¯ä¸èƒ½è¢«å–æ¶ˆçš„ï¼Œåˆ™ä¼šè¿”å›<code>nil</code></li><li>Errï¼šè¿”å›<code>context</code>ç»“æŸçš„åŸå› </li><li>Valueï¼šè¿”å›<code>contxet</code>ä¸­å­˜å‚¨çš„keyå¯¹åº”çš„å€¼</li></ul><h4 id="2-2-error"><a href="#2-2-error" class="headerlink" title="2.2 error"></a>2.2 error</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Canceled = errors.New(<span class="string">&quot;context canceled&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DeadlineExceeded <span class="type">error</span> = deadlineExceededError&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> deadlineExceededError <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(deadlineExceededError)</span></span> Error() <span class="type">string</span>   &#123; <span class="keyword">return</span> <span class="string">&quot;context deadline exceeded&quot;</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(deadlineExceededError)</span></span> Timeout() <span class="type">bool</span>   &#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(deadlineExceededError)</span></span> Temporary() <span class="type">bool</span> &#123; <span class="keyword">return</span> <span class="literal">true</span> &#125;</span><br></pre></td></tr></table></figure><ul><li>Canceledï¼š<code>context</code>è¢«cancelæ—¶ä¼šè¿”å›è¯¥ç±»é”™è¯¯</li><li>DeadlineExceededï¼š<code>context</code>è¶…æ—¶æ—¶ä¼šè¿”å›è¯¥ç±»é”™è¯¯</li></ul><h3 id="3-å…·ä½“å®ç°"><a href="#3-å…·ä½“å®ç°" class="headerlink" title="3 å…·ä½“å®ç°"></a>3 å…·ä½“å®ç°</h3><h3 id=""><a href="#" class="headerlink" title=""></a><img src="https://mxshop-yakult.oss-cn-hangzhou.aliyuncs.com/img/image-20230823100804205.png" alt="image-20230823100804205" style="zoom: 33%;" /></h3><h4 id="3-1-emptyCtx"><a href="#3-1-emptyCtx" class="headerlink" title="3.1 emptyCtx"></a>3.1 emptyCtx</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> emptyCtx <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(emptyCtx)</span></span> Deadline() (deadline time.Time, ok <span class="type">bool</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(emptyCtx)</span></span> Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(emptyCtx)</span></span> Err() <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(emptyCtx)</span></span> Value(key any) any &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>emptyCtx</code>æ˜¯ä¸€ä¸ªç©ºçš„<code>context</code>ï¼Œä¹‹å‰çš„ä¸€äº›ç‰ˆæœ¬ä¸­æ˜¯ç›´æ¥å°†å®ƒå®šä¹‰ä¸ºä¸€ä¸ª<code>int</code>ç±»å‹</p><h4 id="3-2-backgroundCtx"><a href="#3-2-backgroundCtx" class="headerlink" title="3.2 backgroundCtx"></a>3.2 backgroundCtx</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> backgroundCtx <span class="keyword">struct</span>&#123; emptyCtx &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(backgroundCtx)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;context.Background&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Background</span><span class="params">()</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">return</span> backgroundCtx&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Background()</code>è¿”å›ä¸€ä¸ªénilä½†æ˜¯ä¸ºç©ºçš„<code>context</code>ã€‚å®ƒä¸èƒ½è¢«å–æ¶ˆï¼Œæ²¡æœ‰ä»»ä½•å€¼ï¼Œä¹Ÿæ²¡æœ‰æˆªæ­¢æ—¶é—´ã€‚é€šå¸¸è¢«ä¸»å‡½æ•°ã€åˆå§‹åŒ–ã€æµ‹è¯•ä»¥åŠä½œä¸ºä¼ å…¥è¯·æ±‚çš„é¡¶å±‚<code>context</code>ä½¿ç”¨ã€‚</p><h4 id="3-3-todoCtx"><a href="#3-3-todoCtx" class="headerlink" title="3.3 todoCtx"></a>3.3 todoCtx</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> todoCtx <span class="keyword">struct</span>&#123; emptyCtx &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(todoCtx)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;context.TODO&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TODO</span><span class="params">()</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">return</span> todoCtx&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TODO()</code>åŒæ ·è¿”å›ä¸€ä¸ªénilä½†æ˜¯ä¸ºç©ºçš„<code>context</code>ã€‚åœ¨ä»£ç ä¸æ¸…æ¥šåº”è¯¥ä½¿ç”¨å“ªä¸ªä¸Šä¸‹æ–‡æˆ–è€…ä¸Šä¸‹æ–‡å°šä¸å¯ç”¨æ—¶ï¼Œåº”è¯¥ä½¿ç”¨<code>context.TODO</code></p><h4 id="3-4-cancelCtx"><a href="#3-4-cancelCtx" class="headerlink" title="3.4 cancelCtx"></a>3.4 cancelCtx</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> cancelCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    Context</span><br><span class="line"></span><br><span class="line">    mu       sync.Mutex            <span class="comment">// protects following fields</span></span><br><span class="line">    done     atomic.Value          <span class="comment">// of chan struct&#123;&#125;, created lazily, closed by first cancel call</span></span><br><span class="line">    children <span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125; <span class="comment">// set to nil by the first cancel call</span></span><br><span class="line">    err      <span class="type">error</span>                 <span class="comment">// set to non-nil by the first cancel call</span></span><br><span class="line">    cause    <span class="type">error</span>                 <span class="comment">// set to non-nil by the first cancel call</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>cancelCtx</code>æ˜¯å–æ¶ˆæœºåˆ¶çš„å…³é”®</p><ul><li><p>å…¶ç»“æ„ä½“åµŒå…¥äº†ä¸€ä¸ª`Contextï¼Œä½œä¸ºå…¶çˆ¶ç±»</p></li><li><p>muï¼šå†…ç½®ä¸€æŠŠé”ï¼Œç”¨äºå¤šgoroutineå¹¶å‘åœºæ™¯ä¸‹çš„èµ„æºè·å–</p></li><li>doneï¼šåŸå­ç±»å‹çš„å€¼ï¼Œå®é™…ç±»å‹ä¸º<code>chan struct&#123;&#125;</code>ï¼Œç”¨æ¥ååº”<code>cancelCtx</code>çš„ç”Ÿå‘½å‘¨æœŸ</li><li>childrenï¼šä¸€ä¸ªé›†åˆï¼Œä¿å­˜äº†æ‰€æœ‰è¯¥<code>cancelCtx</code>çš„å­<code>context</code></li><li><p>errï¼šè®°å½•<code>cancelCtx</code>å‘ç”Ÿçš„é”™è¯¯</p></li><li><p>causeï¼šè®°å½•<code>calcelCtx</code>è¢«å–æ¶ˆçš„åŸå› </p></li></ul><h5 id="3-4-1-Valueæ–¹æ³•"><a href="#3-4-1-Valueæ–¹æ³•" class="headerlink" title="3.4.1 Valueæ–¹æ³•"></a>3.4.1 Valueæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// &amp;cancelCtxKey is the key that a cancelCtx returns itself for.</span></span><br><span class="line"><span class="keyword">var</span> cancelCtxKey <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span></span> Value(key any) any &#123;</span><br><span class="line">    <span class="keyword">if</span> key == &amp;cancelCtxKey &#123;</span><br><span class="line">        <span class="keyword">return</span> c</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value(c.Context, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>key</code>çš„å€¼ä¸º<code>&amp;cancelCtxKey</code>ï¼Œåˆ™è¿”å›<code>cancelCtx</code>æœ¬èº«çš„æŒ‡é’ˆï¼Œå¦åˆ™è¿”å›å¯¹åº”<code>key</code>å­˜å‚¨çš„<code>value</code>å€¼</p><h5 id="3-4-2-Doneæ–¹æ³•"><a href="#3-4-2-Doneæ–¹æ³•" class="headerlink" title="3.4.2 Doneæ–¹æ³•"></a>3.4.2 Doneæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span></span> Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125; &#123;</span><br><span class="line">    d := c.done.Load()</span><br><span class="line">    <span class="keyword">if</span> d != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> d.(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">    d = c.done.Load()</span><br><span class="line">    <span class="keyword">if</span> d == <span class="literal">nil</span> &#123;</span><br><span class="line">        d = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">        c.done.Store(d)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> d.(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å‰é¢æåˆ°<code>done</code>å±æ€§æ˜¯ä¸€ä¸ªåŸå­ç±»å‹çš„å€¼,å› æ­¤é€šè¿‡<code>atomic</code>åŒ…ä¸­çš„<code>Load()</code>å‡½æ•°è·å–å®ƒçš„å€¼,å¦‚æœå®ƒå·²ç»å­˜åœ¨åˆ™ç›´æ¥è¿”å›</li><li>å¦‚æœä¸å­˜åœ¨åˆ™å…ˆåŠ é”ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„<code>chan struct&#123;&#125;</code>ï¼Œç„¶åé€šè¿‡<code>Store()</code>èµ‹å€¼ç»™<code>done</code>ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ˜¯ä¸€ä¸ªæ‡’åŠ è½½æœºåˆ¶ï¼Œåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨<code>c.Done()</code>çš„æ—¶å€™ï¼Œè¯¥å±æ€§æ‰è¢«åˆ›å»ºï¼Œè¿”å›å€¼ï¼Œç„¶åè§£é”</li></ul><h5 id="3-4-3-Erræ–¹æ³•"><a href="#3-4-3-Erræ–¹æ³•" class="headerlink" title="3.4.3 Erræ–¹æ³•"></a>3.4.3 Erræ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span></span> Err() <span class="type">error</span> &#123;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    err := c.err</span><br><span class="line">    c.mu.Unlock()</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ é”ã€è¯»å–å€¼ã€è§£é”ã€è¿”å›ç»“æœ</p><h5 id="3-4-4-propagateCancelæ–¹æ³•"><a href="#3-4-4-propagateCancelæ–¹æ³•" class="headerlink" title="3.4.4 propagateCancelæ–¹æ³•"></a>3.4.4 propagateCancelæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span></span> propagateCancel(parent Context, child canceler) &#123;</span><br><span class="line">    c.Context = parent</span><br><span class="line"></span><br><span class="line">    done := parent.Done()</span><br><span class="line">    <span class="keyword">if</span> done == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// parent is never canceled</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-done:</span><br><span class="line">        <span class="comment">// parent is already canceled</span></span><br><span class="line">        child.cancel(<span class="literal">false</span>, parent.Err(), Cause(parent))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> p, ok := parentCancelCtx(parent); ok &#123;</span><br><span class="line">        <span class="comment">// parent is a *cancelCtx, or derives from one.</span></span><br><span class="line">        p.mu.Lock()</span><br><span class="line">        <span class="keyword">if</span> p.err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// parent has already been canceled</span></span><br><span class="line">            child.cancel(<span class="literal">false</span>, p.err, p.cause)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> p.children == <span class="literal">nil</span> &#123;</span><br><span class="line">                p.children = <span class="built_in">make</span>(<span class="keyword">map</span>[canceler]<span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            p.children[child] = <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        p.mu.Unlock()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> a, ok := parent.(afterFuncer); ok &#123;</span><br><span class="line">        <span class="comment">// parent implements an AfterFunc method.</span></span><br><span class="line">        c.mu.Lock()</span><br><span class="line">        stop := a.AfterFunc(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            child.cancel(<span class="literal">false</span>, parent.Err(), Cause(parent))</span><br><span class="line">        &#125;)</span><br><span class="line">        c.Context = stopCtx&#123;</span><br><span class="line">            Context: parent,</span><br><span class="line">            stop:    stop,</span><br><span class="line">        &#125;</span><br><span class="line">        c.mu.Unlock()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    goroutines.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-parent.Done():</span><br><span class="line">            child.cancel(<span class="literal">false</span>, parent.Err(), Cause(parent))</span><br><span class="line">        <span class="keyword">case</span> &lt;-child.Done():</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ–¹æ³•æ¯”è¾ƒå…³é”®ï¼Œä¼šæ„å»ºçˆ¶å­ä¸Šä¸‹æ–‡ä¹‹é—´çš„å…³è”ï¼Œå½“çˆ¶ä¸Šä¸‹æ–‡è¢«å–æ¶ˆæ—¶ï¼Œå­ä¸Šä¸‹æ–‡ä¹Ÿä¼šè¢«å–æ¶ˆï¼Œä¸ä¼šå‡ºç°çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µ</p><ul><li>é¦–å…ˆå°†<code>parent</code>èµ‹å€¼ç»™<code>Context</code>å±æ€§</li><li>å¦‚æœçˆ¶ä¸Šä¸‹æ–‡ä¸ä¼šå–æ¶ˆï¼Œåˆ™ç›´æ¥è¿”å›</li><li>å¦‚æœçˆ¶ä¸Šä¸‹æ–‡å·²ç»å–æ¶ˆï¼Œåˆ™ç›´æ¥ç»ˆæ­¢å­ä¸Šä¸‹æ–‡</li><li>å¦‚æœçˆ¶ä¸Šä¸‹æ–‡æ˜¯å¯ä»¥å–æ¶ˆçš„ä¸Šä¸‹æ–‡ç±»å‹ï¼Œå³<code>cancelCtx</code>ï¼Œåˆ™å…ˆåŠ é”ã€ç„¶åå°†å…¶åŠ å…¥åˆ°çˆ¶ä¸Šä¸‹æ–‡çš„<code>children</code>ä¸­ï¼Œæœ€åè§£é”</li><li>å¦‚æœçˆ¶ä¸Šä¸‹æ–‡å®ç°äº†<code>AfterFunc</code>æ–¹æ³•ï¼Œåˆ™åœ¨ä¸Šä¸‹æ–‡è¢«å–æ¶ˆåï¼Œå°†å­ä¸Šä¸‹æ–‡ä¹Ÿå–æ¶ˆï¼Œé€šè¿‡è°ƒç”¨ä¸€ä¸ª<code>stop()</code>å‡½æ•°æ¥å®ç°çš„</li><li>å¦‚æœéƒ½æ²¡æ»¡è¶³å‰é¢çš„æ¡ä»¶ï¼Œåˆ™å¯åŠ¨ä¸€ä¸ªåç¨‹ç›‘æ§parentçŠ¶æ€ï¼Œå€˜è‹¥çˆ¶ä¸Šä¸‹æ–‡ç»ˆæ­¢ï¼Œåˆ™ç»ˆæ­¢å­ä¸Šä¸‹æ–‡</li></ul><blockquote><p>è¿›ä¸€æ­¥è§‚å¯Ÿ<code>parentCancelCtx</code>æ˜¯å¦‚ä½•æ ¡éªŒ<code>parent</code>æ˜¯å¦ä¸º<code>cancelCtx</code>ç±»å‹çš„</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> closedchan = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="built_in">close</span>(closedchan)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">parentCancelCtx</span><span class="params">(parent Context)</span></span> (*cancelCtx, <span class="type">bool</span>) &#123;</span><br><span class="line">    done := parent.Done()</span><br><span class="line">    <span class="keyword">if</span> done == closedchan || done == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    p, ok := parent.Value(&amp;cancelCtxKey).(*cancelCtx)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    pdone, _ := p.done.Load().(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> pdone != done &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p, <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>closedchan</code>è¡¨ç¤ºä¸€ä¸ªå·²ç»å…³é—­çš„é€šé“</li><li>å€˜è‹¥<code>parent</code>çš„<code>channel</code>å·²ç»è¢«å…³é—­æˆ–è€…æ˜¯ä¸ä¼šè¢«<code>cancel</code>çš„ç±»å‹ï¼Œåˆ™ç›´æ¥è¿”å›<code>false</code></li><li>å€˜è‹¥ç”¨<code>&amp;cancelCtxKey</code>èƒ½å–åˆ°å€¼å¹¶ä¸”å¾—åˆ°çš„å€¼æ˜¯<code>parent</code>æœ¬èº«,è¿”å›<code>true</code>ï¼ˆ<code>cancelCtx</code>çš„çº¦å®šï¼Œ<code>key</code>ä¸º<code>&amp;cancelCtxKey</code>çš„æ—¶å€™ï¼Œè¿”å›çš„æ˜¯<code>cancelCtx</code>æœ¬èº«çš„æŒ‡é’ˆï¼‰</li></ul><h5 id="3-4-5-Stringæ–¹æ³•"><a href="#3-4-5-Stringæ–¹æ³•" class="headerlink" title="3.4.5 Stringæ–¹æ³•"></a>3.4.5 Stringæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> contextName(c.Context) + <span class="string">&quot;.WithCancel&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›<code>cancelCtx</code>çš„åå­—</p><h5 id="3-4-6-cancelæ–¹æ³•"><a href="#3-4-6-cancelæ–¹æ³•" class="headerlink" title="3.4.6 cancelæ–¹æ³•"></a>3.4.6 cancelæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *cancelCtx)</span></span> cancel(removeFromParent <span class="type">bool</span>, err, cause <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;context: internal error: missing cancel error&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> cause == <span class="literal">nil</span> &#123;</span><br><span class="line">        cause = err</span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> c.err != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.mu.Unlock()</span><br><span class="line">        <span class="keyword">return</span> <span class="comment">// already canceled</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.err = err</span><br><span class="line">    c.cause = cause</span><br><span class="line">    d, _ := c.done.Load().(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">    <span class="keyword">if</span> d == <span class="literal">nil</span> &#123;</span><br><span class="line">        c.done.Store(closedchan)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">close</span>(d)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> child := <span class="keyword">range</span> c.children &#123;</span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> acquiring the child&#x27;s lock while holding parent&#x27;s lock.</span></span><br><span class="line">        child.cancel(<span class="literal">false</span>, err, cause)</span><br><span class="line">    &#125;</span><br><span class="line">    c.children = <span class="literal">nil</span></span><br><span class="line">    c.mu.Unlock()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> removeFromParent &#123;</span><br><span class="line">        removeChild(c.Context, c)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¯¥æ–¹æ³•æ¥æ”¶ä¸‰ä¸ªå‚æ•°ï¼Œ<code>removeFromParent</code>æ˜¯ä¸€ä¸ª<code>bool</code>å€¼ï¼Œè¡¨ç¤ºéœ€è¦ä»å½“å‰<code>context</code>çš„çˆ¶<code>context</code>çš„<code>children</code>ä¸­åˆ é™¤</li><li>åŠ é”ï¼Œåˆ¤æ–­è‡ªå·±çš„<code>err</code>æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œè¯´æ˜å·²ç»è¢«<code>cancel</code>ï¼Œç›´æ¥è¿”å›</li><li>å¤„ç† <code>cancelCtx</code> çš„ <code>channel</code>ï¼Œè‹¥<code>channel</code> æ­¤å‰æœªåˆå§‹åŒ–ï¼Œåˆ™ç›´æ¥æ³¨å…¥ä¸€ä¸ª <code>closedChan</code>ï¼Œå¦åˆ™å…³é—­è¯¥ <code>channel</code></li><li>éå†è¯¥<code>cancelCtx</code>çš„å­<code>context</code>ï¼Œä¾æ¬¡å°†å…¶<code>cancel</code></li><li>è§£é”ï¼Œæœ€åæ ¹æ®ä¼ å…¥çš„å‚æ•°<code>removeFromParent</code>ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰‹åŠ¨æŠŠ <code>cancelCtx</code> ä» <code>parent</code> çš„<code>children</code> é›†åˆä¸­ç§»é™¤</li></ul><blockquote><p>èµ°è¿› <code>removeChild</code> æ–¹æ³•ä¸­ï¼Œè§‚å¯Ÿå¦‚ä½•å°† <code>cancelCtx</code> ä»<code>parent</code> çš„<code>children</code> é›†åˆ ä¸­ç§»é™¤ï¼š</p></blockquote><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeChild</span><span class="params">(parent Context, child canceler)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> s, ok := parent.(stopCtx); ok &#123;</span><br><span class="line">        s.stop()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    p, ok := parentCancelCtx(parent)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    p.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> p.children != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">delete</span>(p.children, child)</span><br><span class="line">    &#125;</span><br><span class="line">    p.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœ<code>parent</code>ä¸æ˜¯<code>cancelCtx</code>ç±»å‹çš„ï¼Œåˆ™ç›´æ¥è¿”å›ï¼ˆå› ä¸ºåªæœ‰ <code>cancelCtx</code> æ‰æœ‰ <code>children</code>é›†åˆï¼‰</li><li>åŠ é”ï¼Œå°†é›†åˆä¸­<code>key</code>ä¸º<code>child</code>çš„åˆ é™¤ï¼Œè§£é”</li></ul><h4 id="3-5-timerCtx"><a href="#3-5-timerCtx" class="headerlink" title="3.5 timerCtx"></a>3.5 timerCtx</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> timerCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    cancelCtx</span><br><span class="line">    timer *time.Timer <span class="comment">// Under cancelCtx.mu.</span></span><br><span class="line"></span><br><span class="line">    deadline time.Time</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>timerCtx</code>åœ¨<code>cancelCtx</code>çš„åŸºç¡€ä¸Šï¼Œåˆåšäº†ä¸€å±‚å°è£…ï¼Œæ–°å¢äº†ä¸€ä¸ª<code>time.Timer</code>ç”¨äºå®šæ—¶ç»ˆæ­¢<code>context</code>ï¼Œå¦å¤–æ–°å¢ä¸€ä¸ª<code>deadline</code>ç”¨äºè®°å½•è¿‡æœŸæ—¶é—´</p><h5 id="3-5-1-Deadlineæ–¹æ³•"><a href="#3-5-1-Deadlineæ–¹æ³•" class="headerlink" title="3.5.1 Deadlineæ–¹æ³•"></a>3.5.1 Deadlineæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *timerCtx)</span></span> Deadline() (deadline time.Time, ok <span class="type">bool</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> c.deadline, <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›è¿‡æœŸæ—¶é—´</p><h5 id="3-5-2-Stringæ–¹æ³•"><a href="#3-5-2-Stringæ–¹æ³•" class="headerlink" title="3.5.2 Stringæ–¹æ³•"></a>3.5.2 Stringæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *timerCtx)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> contextName(c.cancelCtx.Context) + <span class="string">&quot;.WithDeadline(&quot;</span> +</span><br><span class="line">        c.deadline.String() + <span class="string">&quot; [&quot;</span> +</span><br><span class="line">        time.Until(c.deadline).String() + <span class="string">&quot;])&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›<code>context</code>çš„åå­—åŠ ä¸Šè¿‡æœŸæ—¶é—´</p><h5 id="3-5-3-cancelæ–¹æ³•"><a href="#3-5-3-cancelæ–¹æ³•" class="headerlink" title="3.5.3 cancelæ–¹æ³•"></a>3.5.3 cancelæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *timerCtx)</span></span> cancel(removeFromParent <span class="type">bool</span>, err, cause <span class="type">error</span>) &#123;</span><br><span class="line">    c.cancelCtx.cancel(<span class="literal">false</span>, err, cause)</span><br><span class="line">    <span class="keyword">if</span> removeFromParent &#123;</span><br><span class="line">        <span class="comment">// Remove this timerCtx from its parent cancelCtx&#x27;s children.</span></span><br><span class="line">        removeChild(c.cancelCtx.Context, c)</span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">if</span> c.timer != <span class="literal">nil</span> &#123;</span><br><span class="line">        c.timer.Stop()</span><br><span class="line">        c.timer = <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç»§æ‰¿<code>cancelCtx</code>çš„<code>cancel</code>æ–¹æ³•ï¼Œè¿›è¡Œå¤„ç†</li><li>åˆ¤æ–­æ˜¯å¦éœ€è¦ä» <code>parent</code> çš„ <code>children</code> é›†åˆ ä¸­ç§»é™¤ï¼Œè‹¥æ˜¯åˆ™è¿›è¡Œå¤„ç†</li><li>åŠ é”ã€åœæ­¢<code>time.Timer</code>ã€è§£é”è¿”å›</li></ul><h4 id="3-6-valueCtx"><a href="#3-6-valueCtx" class="headerlink" title="3.6 valueCtx"></a>3.6 valueCtx</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> valueCtx <span class="keyword">struct</span> &#123;</span><br><span class="line">    Context</span><br><span class="line">    key, val any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>valueCtx</code>åŒæ ·ç»§æ‰¿äº†<code>Context</code>ï¼ŒåŒæ—¶ä¸€ä¸ª<code>valueCtx</code>åªèƒ½å­˜å‚¨ä¸€å¯¹<code>kv</code></p><h5 id="3-6-1-Stringæ–¹æ³•"><a href="#3-6-1-Stringæ–¹æ³•" class="headerlink" title="3.6.1 Stringæ–¹æ³•"></a>3.6.1 Stringæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *valueCtx)</span></span> String() <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> contextName(c.Context) + <span class="string">&quot;.WithValue(type &quot;</span> +</span><br><span class="line">        reflectlite.TypeOf(c.key).String() +</span><br><span class="line">        <span class="string">&quot;, val &quot;</span> + stringify(c.val) + <span class="string">&quot;)&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿”å›<code>valueCtx</code>çš„åå­—ä»¥åŠå­˜å‚¨çš„<code>kv</code>å€¼</p><h5 id="3-6-2-Valueæ–¹æ³•"><a href="#3-6-2-Valueæ–¹æ³•" class="headerlink" title="3.6.2 Valueæ–¹æ³•"></a>3.6.2 Valueæ–¹æ³•</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *valueCtx)</span></span> Value(key any) any &#123;</span><br><span class="line">    <span class="keyword">if</span> c.key == key &#123;</span><br><span class="line">        <span class="keyword">return</span> c.val</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value(c.Context, key)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœå‚æ•°çš„<code>key</code>ç­‰äºä»–æ‰€ä¿å­˜çš„<code>key</code>åˆ™è¿”å›æ‰€ä¿å­˜çš„<code>value</code></li><li>å¦åˆ™å»<code>parent</code>çš„<code>Context</code>å»æ‰¾</li></ul><p>è¿›ä¸€æ­¥è§‚å¯Ÿæ˜¯å¦‚ä½•åœ¨<code>parent</code>ä¸­å¯»æ‰¾çš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">value</span><span class="params">(c Context, key any)</span></span> any &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> ctx := c.(<span class="keyword">type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> *valueCtx:</span><br><span class="line">            <span class="keyword">if</span> key == ctx.key &#123;</span><br><span class="line">                <span class="keyword">return</span> ctx.val</span><br><span class="line">            &#125;</span><br><span class="line">            c = ctx.Context</span><br><span class="line">        <span class="keyword">case</span> *cancelCtx:</span><br><span class="line">            <span class="keyword">if</span> key == &amp;cancelCtxKey &#123;</span><br><span class="line">                <span class="keyword">return</span> c</span><br><span class="line">            &#125;</span><br><span class="line">            c = ctx.Context</span><br><span class="line">        <span class="keyword">case</span> withoutCancelCtx:</span><br><span class="line">            <span class="keyword">if</span> key == &amp;cancelCtxKey &#123;</span><br><span class="line">                <span class="comment">// This implements Cause(ctx) == nil</span></span><br><span class="line">                <span class="comment">// when ctx is created using WithoutCancel.</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            c = ctx.c</span><br><span class="line">        <span class="keyword">case</span> *timerCtx:</span><br><span class="line">            <span class="keyword">if</span> key == &amp;cancelCtxKey &#123;</span><br><span class="line">                <span class="keyword">return</span> &amp;ctx.cancelCtx</span><br><span class="line">            &#125;</span><br><span class="line">            c = ctx.Context</span><br><span class="line">        <span class="keyword">case</span> backgroundCtx, todoCtx:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> c.Value(key)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨ä¸€ä¸ª for å¾ªç¯ï¼Œä¸€ç›´å¾€ä¸Šå»çˆ¶ä¸Šä¸‹æ–‡ä¸­å¯»æ‰¾</li><li>å…¶ä¸­ä¸åŒçš„ä¸Šä¸‹æ–‡ç±»å‹ä¼šæœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼›</li><li>æ‰¾åˆ°åŒ¹é…çš„ keyï¼Œåˆ™å°†è¯¥value è¿›è¡Œè¿”å›.</li></ul><h3 id="4-åˆ›å»ºcontext"><a href="#4-åˆ›å»ºcontext" class="headerlink" title="4 åˆ›å»ºcontext"></a>4 åˆ›å»ºcontext</h3><h4 id="4-1-cancelCtx"><a href="#4-1-cancelCtx" class="headerlink" title="4.1 cancelCtx"></a>4.1 cancelCtx</h4><p>æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ä¸ªä¸å¸¦<code>cause</code>ï¼Œä¸€ä¸ªå¸¦æœ‰<code>cause</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span></span> (ctx Context, cancel CancelFunc) &#123;</span><br><span class="line">    c := withCancel(parent)</span><br><span class="line">    <span class="keyword">return</span> c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled, <span class="literal">nil</span>) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancelCause</span><span class="params">(parent Context)</span></span> (ctx Context, cancel CancelCauseFunc) &#123;</span><br><span class="line">    c := withCancel(parent)</span><br><span class="line">    <span class="keyword">return</span> c, <span class="function"><span class="keyword">func</span><span class="params">(cause <span class="type">error</span>)</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled, cause) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2-withoutCancelCtx"><a href="#4-2-withoutCancelCtx" class="headerlink" title="4.2 withoutCancelCtx"></a>4.2 withoutCancelCtx</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithoutCancel</span><span class="params">(parent Context)</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">if</span> parent == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;cannot create context from nil parent&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> withoutCancelCtx&#123;parent&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-3-Deadline"><a href="#4-3-Deadline" class="headerlink" title="4.3 Deadline"></a>4.3 Deadline</h4><p>åŒæ ·æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ä¸ªä¸å¸¦<code>cause</code>ï¼Œä¸€ä¸ªå¸¦æœ‰<code>cause</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadline</span><span class="params">(parent Context, d time.Time)</span></span> (Context, CancelFunc) &#123;</span><br><span class="line">    <span class="keyword">return</span> WithDeadlineCause(parent, d, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadlineCause</span><span class="params">(parent Context, d time.Time, cause <span class="type">error</span>)</span></span> (Context, CancelFunc) &#123;</span><br><span class="line">    <span class="keyword">if</span> parent == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;cannot create context from nil parent&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> cur, ok := parent.Deadline(); ok &amp;&amp; cur.Before(d) &#123;</span><br><span class="line">        <span class="comment">// The current deadline is already sooner than the new one.</span></span><br><span class="line">        <span class="keyword">return</span> WithCancel(parent)</span><br><span class="line">    &#125;</span><br><span class="line">    c := &amp;timerCtx&#123;</span><br><span class="line">        deadline: d,</span><br><span class="line">    &#125;</span><br><span class="line">    c.cancelCtx.propagateCancel(parent, c)</span><br><span class="line">    dur := time.Until(d)</span><br><span class="line">    <span class="keyword">if</span> dur &lt;= <span class="number">0</span> &#123;</span><br><span class="line">        c.cancel(<span class="literal">true</span>, DeadlineExceeded, cause) <span class="comment">// deadline has already passed</span></span><br><span class="line">        <span class="keyword">return</span> c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">false</span>, Canceled, <span class="literal">nil</span>) &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    c.mu.Lock()</span><br><span class="line">    <span class="keyword">defer</span> c.mu.Unlock()</span><br><span class="line">    <span class="keyword">if</span> c.err == <span class="literal">nil</span> &#123;</span><br><span class="line">        c.timer = time.AfterFunc(dur, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            c.cancel(<span class="literal">true</span>, DeadlineExceeded, cause)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c.cancel(<span class="literal">true</span>, Canceled, <span class="literal">nil</span>) &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-4-Timeout"><a href="#4-4-Timeout" class="headerlink" title="4.4 Timeout"></a>4.4 Timeout</h4><p>åŒæ ·æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ä¸ªä¸å¸¦<code>cause</code>ï¼Œä¸€ä¸ªå¸¦æœ‰<code>cause</code>ï¼Œæœ€åéƒ½æ˜¯é€šè¿‡<code>WithDeadlineCause</code>æ¥åˆ›å»ºçš„</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(parent Context, timeout time.Duration)</span></span> (Context, CancelFunc) &#123;</span><br><span class="line">    <span class="keyword">return</span> WithDeadline(parent, time.Now().Add(timeout))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeoutCause</span><span class="params">(parent Context, timeout time.Duration, cause <span class="type">error</span>)</span></span> (Context, CancelFunc) &#123;</span><br><span class="line">    <span class="keyword">return</span> WithDeadlineCause(parent, time.Now().Add(timeout), cause)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-5-ValueCtx"><a href="#4-5-ValueCtx" class="headerlink" title="4.5 ValueCtx"></a>4.5 ValueCtx</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValue</span><span class="params">(parent Context, key, val any)</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">if</span> parent == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;cannot create context from nil parent&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> key == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;nil key&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> !reflectlite.TypeOf(key).Comparable() &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;key is not comparable&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;valueCtx&#123;parent, key, val&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æºç è§£è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
